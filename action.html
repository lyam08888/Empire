<!DOCTYPE html>
<html lang="fr">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Empire - Jeu Complet Simulé</title>
   <meta name="description" content="Prototype complet et persistant du jeu de stratégie Empire, simulant une architecture multi-écrans avec une interface mobile.">
   <meta name="author" content="Empire Game Studio">
   <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%231e3a8a'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='Arial' font-size='18' font-weight='bold'>E</text></svg>" type="image/svg+xml">

   <style>
       :root {
           --color-primary: #fbbf24; /* Or */
           --color-secondary: #3b82f6; /* Bleu */
           --color-danger: #ef4444; /* Rouge */
           --color-success: #22c55e; /* Vert */
           --color-dark-1: #0a192f; /* Fond principal */
           --color-dark-2: #1e3a8a; /* Dégradé fond */
           --color-panel: rgba(15, 23, 42, 0.8); /* Panneaux */
           --color-panel-light: rgba(30, 41, 59, 0.8);
           --color-text: #e2e8f0;
           --color-text-muted: #94a3b8;
           --color-border: rgba(148, 163, 184, 0.2);
       }

       /* Styles de base et reset */
       * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
       html, body { height: 100%; }
       body {
           font-family: 'Arial', sans-serif;
           background: linear-gradient(135deg, var(--color-dark-1), var(--color-dark-2));
           color: var(--color-text);
           overflow: hidden;
       }
       .hidden { display: none !important; }

       /* --- LAYOUT GLOBAL --- */
       .game-ui { display: flex; flex-direction: column; height: 100%; }
       .game-header, .game-footer { flex-shrink: 0; z-index: 100; }
       .game-body { display: flex; flex-grow: 1; overflow: hidden; padding: 1rem; gap: 1rem; }

       /* --- HEADER --- */
       .game-header { padding: 0.5rem 1rem; background: var(--color-panel); backdrop-filter: blur(5px); border-bottom: 1px solid var(--color-border); }
       .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1600px; margin: 0 auto; }
       .resources { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; background: var(--color-panel-light); padding: 0.5rem 1rem; border-radius: 0.5rem; }
       .resource-item { display: flex; align-items: center; gap: 0.5rem; font-weight: bold; }
       .resource-item span { color: var(--color-primary); min-width: 40px; }
       .player-info a { color: var(--color-text-muted); text-decoration: none; transition: color 0.3s; }
       .player-info a:hover { color: var(--color-primary); }

       /* --- BARRE DE NAVIGATION GAUCHE (Desktop) --- */
       .left-sidebar { width: 200px; flex-shrink: 0; background: var(--color-panel); padding: 1rem; border-radius: 1rem; overflow-y: auto; }
       .main-nav ul { list-style: none; }
       .main-nav li a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; margin-bottom: 0.5rem; color: var(--color-text); text-decoration: none; border-radius: 0.5rem; transition: all 0.3s; cursor: pointer; }
       .main-nav li a:hover, .main-nav li a.active { background: rgba(251, 191, 36, 0.1); color: var(--color-primary); transform: translateX(5px); }
       .main-nav li a span { display: inline; }

       /* --- VUE CENTRALE (Conteneur) --- */
       .main-view-container { flex-grow: 1; position: relative; }
       .main-view {
           position: absolute; top: 0; left: 0; width: 100%; height: 100%;
           background: url('https://www.transparenttextures.com/patterns/dark-matter.png'), linear-gradient(135deg, #1c2a4b, #111827);
           border-radius: 1rem;
           overflow: auto;
           padding: 1.5rem;
           animation: fadeIn 0.5s;
       }
       @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
       .main-view h2 { color: var(--color-primary); margin-bottom: 1rem; font-size: 1.8rem; }
       
       /* --- VUE VILLE AMÉLIORÉE --- */
       .city-container {
           display: flex; flex-direction: column; height: 100%; gap: 1rem;
           padding: 1rem; background: var(--color-background);
       }
       
       .city-header {
           background: var(--color-panel-light); border-radius: 1rem; padding: 1.5rem;
           display: flex; justify-content: space-between; align-items: center;
           box-shadow: 0 4px 15px rgba(0,0,0,0.1);
       }
       
       .city-title h2 {
           margin: 0; color: var(--color-primary); font-size: 1.8rem;
       }
       
       .city-level {
           color: var(--color-text-muted); font-size: 0.9rem; margin-top: 0.25rem;
       }
       
       .city-vital-stats {
           display: flex; gap: 2rem;
       }
       
       .vital-stat {
           display: flex; align-items: center; gap: 0.75rem;
           background: var(--color-panel); padding: 1rem; border-radius: 0.75rem;
           transition: all 0.3s ease; cursor: pointer;
       }
       
       .vital-stat:hover {
           transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15);
       }
       
       .stat-icon {
           font-size: 2rem; opacity: 0.8;
       }
       
       .stat-value {
           font-size: 1.4rem; font-weight: bold; color: var(--color-text);
       }
       
       .stat-label {
           font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem;
       }
       
       .stat-growth, .stat-trend, .stat-modifier, .stat-impact {
           font-size: 0.75rem; margin-top: 0.25rem; font-weight: 500;
       }
       
       .stat-growth { color: var(--color-success); }
       .stat-trend { color: var(--color-warning); }
       .stat-modifier { color: var(--color-primary); }
       .stat-impact { color: var(--color-danger); }
       
       .city-districts-panel {
           display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
       }
       
       .district-card {
           background: var(--color-panel-light); border-radius: 1rem; padding: 1.25rem;
           cursor: pointer; transition: all 0.3s ease; position: relative;
           border: 2px solid transparent; overflow: hidden;
       }
       
       .district-card::before {
           content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
           transition: all 0.3s ease;
       }
       
       .district-card.residential::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
       .district-card.commercial::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
       .district-card.industrial::before { background: linear-gradient(90deg, #ef4444, #f87171); }
       .district-card.cultural::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
       
       .district-card:hover {
           transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15);
           border-color: var(--color-primary);
       }
       
       .district-card:hover::before {
           height: 6px;
       }
       
       .district-header {
           display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;
       }
       
       .district-icon {
           font-size: 2.5rem; opacity: 0.8;
       }
       
       .district-title h4 {
           margin: 0; color: var(--color-text); font-size: 1.1rem;
       }
       
       .district-level {
           font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem;
       }
       
       .district-efficiency {
           font-size: 0.9rem; font-weight: bold; color: var(--color-success);
           background: rgba(34, 197, 94, 0.1); padding: 0.25rem 0.5rem;
           border-radius: 0.5rem;
       }
       
       .district-stats {
           margin-bottom: 1rem;
       }
       
       .district-stat {
           display: flex; justify-content: space-between; margin-bottom: 0.5rem;
           font-size: 0.9rem;
       }
       
       .district-stat span:first-child {
           color: var(--color-text-muted);
       }
       
       .district-stat span:last-child {
           color: var(--color-text); font-weight: 500;
       }
       
       .district-production {
           border-top: 1px solid var(--color-border); padding-top: 0.75rem;
       }
       
       .production-item {
           font-size: 0.9rem; font-weight: 500; color: var(--color-success);
       }
       
       .city-main-area {
           display: flex; gap: 1rem; flex: 1;
       }
       
       .city-map-section {
           flex: 2; position: relative; background: var(--color-panel-light);
           border-radius: 1rem; overflow: hidden;
       }
       
       .city-view-content { 
           position: relative; width: 100%; height: 100%; min-height: 500px;
           background: linear-gradient(135deg, #2d5016, #3d6b1f), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grass" patternUnits="userSpaceOnUse" width="20" height="20"><rect width="20" height="20" fill="%23355e3b"/><circle cx="5" cy="5" r="1" fill="%234a7c59"/><circle cx="15" cy="15" r="1" fill="%234a7c59"/></pattern></defs><rect width="100" height="100" fill="url(%23grass)"/></svg>');
           border-radius: 1rem;
           overflow: hidden;
       }
       
       .city-roads {
           position: absolute; top: 0; left: 0; right: 0; bottom: 0;
           pointer-events: none; z-index: 50;
       }
       
       .road-connection {
           position: absolute; height: 3px;
           background: linear-gradient(90deg, #a16207, #ca8a04);
           border-radius: 2px; opacity: 0.8;
           box-shadow: 0 0 5px rgba(161, 98, 7, 0.5);
       }
       
       .city-overlay-info {
           position: absolute; top: 1rem; right: 1rem; z-index: 100;
           display: flex; flex-direction: column; gap: 0.5rem;
       }
       
       .weather-indicator, .time-indicator {
           background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 0.75rem;
           border-radius: 0.5rem; font-size: 0.8rem; text-align: center;
           backdrop-filter: blur(10px);
       }
       
       .city-details-panel {
           flex: 1; background: var(--color-panel-light); border-radius: 1rem;
           display: flex; flex-direction: column; overflow: hidden;
       }
       
       .details-header {
           background: var(--color-panel); padding: 1rem; display: flex;
           justify-content: space-between; align-items: center;
           border-bottom: 1px solid var(--color-border);
       }
       
       .details-header h3 {
           margin: 0; color: var(--color-text);
       }
       
       .close-details {
           background: none; border: none; color: var(--color-text-muted);
           font-size: 1.2rem; cursor: pointer; padding: 0.25rem;
           border-radius: 0.25rem; transition: all 0.2s ease;
       }
       
       .close-details:hover {
           background: var(--color-danger); color: white;
       }
       
       .details-content {
           flex: 1; padding: 1rem; overflow-y: auto;
       }
       
       .city-overview h4 {
           color: var(--color-primary); margin: 0 0 1rem 0; font-size: 1.1rem;
       }
       
       .management-actions {
           display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem;
       }
       
       .management-btn {
           background: var(--color-panel); border: 1px solid var(--color-border);
           color: var(--color-text); padding: 0.75rem; border-radius: 0.5rem;
           cursor: pointer; transition: all 0.3s ease; text-align: left;
           font-size: 0.9rem;
       }
       
       .management-btn:hover {
           background: var(--color-primary); color: white;
           transform: translateX(4px);
       }
       
       .detailed-stats {
           background: var(--color-panel); border-radius: 0.5rem; padding: 1rem;
       }
       
       .stat-row {
           display: flex; justify-content: space-between; margin-bottom: 0.75rem;
           font-size: 0.9rem;
       }
       
       .stat-row:last-child {
           margin-bottom: 0; padding-top: 0.75rem;
           border-top: 1px solid var(--color-border); font-weight: bold;
       }
       
       .stat-row span:first-child {
           color: var(--color-text-muted);
       }
       
       .stat-row .positive {
           color: var(--color-success);
       }
       
       .stat-row .negative {
           color: var(--color-danger);
       }
       
       /* Styles pour les districts focalisés et les détails */
       .district-card.focused {
           border-color: var(--color-primary) !important;
           box-shadow: 0 0 20px rgba(59, 130, 246, 0.3) !important;
           transform: translateY(-6px) !important;
       }
       
       .district-details {
           display: flex; flex-direction: column; gap: 1.5rem;
       }
       
       .overview-stats {
           display: flex; flex-direction: column; gap: 0.5rem;
       }
       
       .overview-stat {
           display: flex; justify-content: space-between; align-items: center;
           padding: 0.5rem; background: var(--color-panel); border-radius: 0.5rem;
       }
       
       .level-badge, .efficiency-badge, .contribution-badge {
           background: var(--color-primary); color: white; padding: 0.25rem 0.5rem;
           border-radius: 0.25rem; font-weight: bold; font-size: 0.8rem;
       }
       
       .efficiency-badge {
           background: var(--color-success);
       }
       
       .contribution-badge {
           background: var(--color-warning);
       }
       
       .upgrade-info {
           background: var(--color-panel); border-radius: 0.5rem; padding: 1rem;
       }
       
       .next-level {
           font-size: 1.1rem; font-weight: bold; color: var(--color-primary);
           margin-bottom: 0.5rem;
       }
       
       .upgrade-cost {
           color: var(--color-text-muted); margin-bottom: 1rem;
       }
       
       .upgrade-benefits ul {
           margin: 0.5rem 0; padding-left: 1.5rem;
       }
       
       .upgrade-benefits li {
           margin-bottom: 0.25rem; color: var(--color-success);
       }
       
       .upgrade-btn {
           background: var(--color-primary); color: white; border: none;
           padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;
           font-weight: bold; transition: all 0.3s ease; width: 100%;
       }
       
       .upgrade-btn:hover:not(:disabled) {
           background: var(--color-primary-dark); transform: translateY(-2px);
       }
       
       .upgrade-btn:disabled {
           background: var(--color-text-muted); cursor: not-allowed;
       }
       
       .policy-options {
           display: flex; flex-direction: column; gap: 0.5rem;
       }
       
       .policy-option {
           background: var(--color-panel); border: 1px solid var(--color-border);
           border-radius: 0.5rem; padding: 0.75rem; cursor: pointer;
           transition: all 0.3s ease;
       }
       
       .policy-option:hover {
           border-color: var(--color-primary); transform: translateX(4px);
       }
       
       .policy-option.active {
           background: var(--color-primary); color: white;
           border-color: var(--color-primary);
       }
       
       .policy-name {
           font-weight: bold; margin-bottom: 0.25rem;
       }
       
       .policy-effect {
           font-size: 0.9rem; margin-bottom: 0.25rem;
       }
       
       .policy-cost {
           font-size: 0.8rem; color: var(--color-warning);
       }
       
       .policy-option.active .policy-cost {
           color: rgba(255,255,255,0.8);
       }
       
       /* Styles pour les modales de politiques et infrastructure */
       .city-policies, .infrastructure-panel, .city-events {
           max-width: 600px;
       }
       
       .policy-grid {
           display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;
           margin-top: 1rem;
       }
       
       .policy-card {
           background: var(--color-panel-light); border: 1px solid var(--color-border);
           border-radius: 0.5rem; padding: 1rem; cursor: pointer;
           transition: all 0.3s ease;
       }
       
       .policy-card:hover {
           border-color: var(--color-primary); transform: translateY(-2px);
       }
       
       .policy-card h5 {
           margin: 0 0 0.5rem 0; color: var(--color-primary);
       }
       
       .policy-card p {
           margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--color-text-muted);
       }
       
       .policy-status {
           font-size: 0.8rem; color: var(--color-success); font-weight: bold;
       }
       
       .infrastructure-projects {
           display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;
       }
       
       .project-card {
           background: var(--color-panel-light); border: 1px solid var(--color-border);
           border-radius: 0.5rem; padding: 1rem;
       }
       
       .project-card h5 {
           margin: 0 0 0.5rem 0; color: var(--color-primary);
       }
       
       .project-card p {
           margin: 0 0 0.5rem 0; font-size: 0.9rem;
       }
       
       .project-cost {
           font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 1rem;
       }
       
       .project-btn {
           background: var(--color-success); color: white; border: none;
           padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;
           transition: all 0.3s ease;
       }
       
       .project-btn:hover {
           background: var(--color-success-dark); transform: translateY(-1px);
       }
       
       .events-list {
           max-height: 300px; overflow-y: auto; margin-bottom: 1rem;
       }
       
       .event-item {
           background: var(--color-panel-light); border-left: 3px solid var(--color-primary);
           padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.25rem;
       }
       
       .event-title {
           font-weight: bold; margin-bottom: 0.25rem;
       }
       
       .event-description {
           font-size: 0.9rem; margin-bottom: 0.25rem;
       }
       
       .event-time {
           font-size: 0.8rem; color: var(--color-text-muted);
       }
       
       .city-districts {
           position: absolute; top: 10px; left: 10px; right: 10px; height: 60px;
           display: flex; gap: 10px; background: rgba(0,0,0,0.7); border-radius: 8px; padding: 8px;
       }
       
       .district-indicator {
           flex: 1; text-align: center; padding: 4px; border-radius: 4px;
           background: var(--color-panel-light); font-size: 0.8rem;
           display: flex; flex-direction: column; justify-content: center;
       }
       
       .district-indicator.residential { border-left: 3px solid #22c55e; }
       .district-indicator.commercial { border-left: 3px solid #fbbf24; }
       .district-indicator.industrial { border-left: 3px solid #ef4444; }
       .district-indicator.cultural { border-left: 3px solid #8b5cf6; }
       
       .building-plot {
           position: absolute; background: rgba(30, 64, 175, 0.2); 
           border: 2px dashed rgba(59, 130, 246, 0.4);
           border-radius: 0.8rem; cursor: pointer; transition: all 0.4s ease;
           display: flex; flex-direction: column; justify-content: center;
           align-items: center; font-size: 2.5rem; color: rgba(255, 255, 255, 0.6);
           backdrop-filter: blur(2px);
       }
       
       .building-plot:hover, .building-plot.selected { 
           background: rgba(251, 191, 36, 0.3); border-color: var(--color-primary);
           transform: scale(1.05); box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
       }
       
       .building-plot.built {
           background: linear-gradient(135deg, rgba(30, 64, 175, 0.8), rgba(59, 130, 246, 0.6));
           border: 2px solid rgba(59, 130, 246, 0.8);
           box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
       }
       
       .building-plot.constructing::after { 
           content: '⏳'; position: absolute; top: 5px; right: 5px; 
           font-size: 1.2rem; animation: pulse 1.5s infinite;
           background: rgba(251, 191, 36, 0.9); padding: 2px 6px; border-radius: 50%;
       }
       
       @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
       
       .building-plot .level { 
           position: absolute; bottom: 5px; right: 8px; font-size: 0.9rem; 
           font-weight: bold; color: white; background: linear-gradient(135deg, #1e40af, #3b82f6);
           padding: 2px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);
       }
       
       .building-plot .building-name {
           position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
           font-size: 0.7rem; color: var(--color-text); background: rgba(0,0,0,0.8);
           padding: 2px 6px; border-radius: 4px; white-space: nowrap;
           opacity: 0; transition: opacity 0.3s;
       }
       
       .building-plot:hover .building-name { opacity: 1; }
       
       .city-roads {
           position: absolute; top: 0; left: 0; width: 100%; height: 100%;
           pointer-events: none; z-index: 1;
       }
       
       .road-connection {
           position: absolute; background: linear-gradient(90deg, #8b7355, #a0845c);
           height: 4px; border-radius: 2px; opacity: 0.7;
           box-shadow: 0 1px 3px rgba(0,0,0,0.3);
       }

       /* --- GRILLES DE CARTE (Monde & Île) --- */
       .map-grid-container {
           display: grid;
           width: 100%;
           aspect-ratio: 1 / 1;
           max-width: 800px;
           margin: auto;
           gap: 4px;
       }
       .map-tile {
           border-radius: 4px;
           transition: all 0.2s ease-in-out;
           cursor: pointer;
           position: relative;
           display: flex;
           justify-content: center;
           align-items: center;
           font-size: 2rem;
       }
       .map-tile .tooltip {
           visibility: hidden; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
           background-color: var(--color-dark-1); color: white; padding: 5px 10px; border-radius: 6px;
           white-space: nowrap; z-index: 20; font-size: 0.8rem;
       }
       .map-tile:hover {
           transform: scale(1.1);
           z-index: 10;
       }
       .map-tile:hover .tooltip { visibility: visible; }

       /* --- VUE MONDE AMÉLIORÉE --- */
       .world-view-container {
           display: flex; flex-direction: column; height: 100%; gap: 1rem;
       }
       
       .world-header {
           background: var(--color-panel-light); border-radius: 0.5rem; padding: 1rem;
           display: flex; justify-content: space-between; align-items: center;
       }
       
       .world-stats {
           display: flex; gap: 2rem; font-size: 0.9rem;
       }
       
       .world-main {
           display: flex; gap: 1rem; flex: 1;
       }
       
       .world-map-section {
           flex: 2; background: var(--color-panel-light); border-radius: 0.5rem; padding: 1rem;
           position: relative;
       }
       
       #world-map-grid { 
           display: grid; grid-template-columns: repeat(20, 1fr); gap: 2px;
           background: linear-gradient(135deg, #0f172a, #1e293b);
           border-radius: 1rem; padding: 1rem; aspect-ratio: 1.2;
           position: relative; overflow: hidden;
       }
       
       #world-map-grid::before {
           content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
           background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="50" height="50"><circle cx="10" cy="10" r="0.5" fill="white" opacity="0.3"/><circle cx="30" cy="25" r="0.3" fill="white" opacity="0.2"/><circle cx="45" cy="5" r="0.4" fill="white" opacity="0.4"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
           pointer-events: none; opacity: 0.3;
       }
       
       .world-tile { 
           background: linear-gradient(135deg, #1e40af, #3b82f6);
           border-radius: 3px; transition: all 0.3s ease;
           cursor: pointer; position: relative; display: flex;
           justify-content: center; align-items: center; font-size: 1rem;
           opacity: 0.4; border: 1px solid rgba(255,255,255,0.1);
       }
       
       .world-tile:hover {
           transform: scale(1.2); z-index: 10;
           box-shadow: 0 4px 15px rgba(0,0,0,0.5);
       }
       
       .world-tile.ocean { 
           background: linear-gradient(135deg, #1e40af, #2563eb);
           opacity: 0.2;
       }
       
       .world-tile.island { 
           background: linear-gradient(135deg, #16a34a, #22c55e);
           opacity: 0.8; border: 1px solid rgba(34, 197, 94, 0.5);
       }
       
       .world-tile.player { 
           background: linear-gradient(135deg, var(--color-primary), #f59e0b);
           opacity: 1; border: 2px solid #fbbf24;
           animation: playerGlow 2s infinite alternate;
       }
       
       .world-tile.ally { 
           background: linear-gradient(135deg, var(--color-success), #16a34a);
           opacity: 1; border: 2px solid #22c55e;
       }
       
       .world-tile.enemy { 
           background: linear-gradient(135deg, var(--color-danger), #dc2626);
           opacity: 1; border: 2px solid #ef4444;
           animation: enemyPulse 1.5s infinite;
       }
       
       .world-tile.unexplored { 
           background: linear-gradient(135deg, #374151, #4b5563);
           opacity: 0.1;
       }
       
       .world-tile.trade-route {
           border: 2px solid #fbbf24;
           box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
       }
       
       @keyframes playerGlow {
           0% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
           100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
       }
       
       @keyframes enemyPulse {
           0%, 100% { opacity: 1; }
           50% { opacity: 0.7; }
       }
       
       .world-details {
           flex: 1; background: var(--color-panel-light); border-radius: 0.5rem; 
           padding: 1rem; display: flex; flex-direction: column; gap: 1rem;
       }
       
       .world-events {
           background: var(--color-panel); border-radius: 0.5rem; padding: 0.75rem;
           max-height: 200px; overflow-y: auto;
       }
       
       .world-diplomacy {
           background: var(--color-panel); border-radius: 0.5rem; padding: 0.75rem;
       }
       
       .trade-routes-display {
           background: var(--color-panel); border-radius: 0.5rem; padding: 0.75rem;
       }
       
       .weather-system {
           position: absolute; top: 10px; right: 10px;
           background: rgba(0,0,0,0.7); border-radius: 8px; padding: 8px;
           font-size: 0.8rem; color: var(--color-text);
       }

       /* --- VUE ÎLE AMÉLIORÉE --- */
       .island-view-container {
           display: flex; flex-direction: column; height: 100%; gap: 1rem;
       }
       
       .island-header {
           background: var(--color-panel-light); border-radius: 0.5rem; padding: 1rem;
           display: flex; justify-content: space-between; align-items: center;
       }
       
       .island-stats {
           display: flex; gap: 2rem; font-size: 0.9rem;
       }
       
       .island-stat {
           display: flex; align-items: center; gap: 0.5rem;
       }
       
       .island-main {
           display: flex; gap: 1rem; flex: 1;
       }
       
       .island-map-section {
           flex: 2; background: var(--color-panel-light); border-radius: 0.5rem; padding: 1rem;
           position: relative; overflow: hidden;
       }
       
       #island-grid { 
           display: grid; grid-template-columns: repeat(9, 1fr); gap: 3px;
           background: linear-gradient(135deg, #0c4a6e, #1e40af); 
           border-radius: 1rem; padding: 1.5rem; aspect-ratio: 1;
           position: relative;
       }
       
       .island-tile { 
           background: linear-gradient(135deg, #0891b2, #0ea5e9);
           border-radius: 6px; transition: all 0.3s ease;
           cursor: pointer; position: relative; display: flex;
           justify-content: center; align-items: center; font-size: 1.5rem;
           border: 1px solid rgba(255,255,255,0.1);
       }
       
       .island-tile:hover {
           transform: scale(1.1); z-index: 10;
           box-shadow: 0 4px 15px rgba(0,0,0,0.3);
       }
       
       .island-tile.water { 
           background: linear-gradient(135deg, #1e40af, #3b82f6);
           opacity: 0.6;
       }
       
       .island-tile.land { 
           background: linear-gradient(135deg, #16a34a, #22c55e);
       }
       
       .island-tile.mountain { 
           background: linear-gradient(135deg, #6b7280, #9ca3af);
       }
       
       .island-tile.forest { 
           background: linear-gradient(135deg, #166534, #15803d);
       }
       
       .island-tile.playerCity { 
           background: linear-gradient(135deg, var(--color-primary), #f59e0b);
           border: 2px solid #fbbf24; animation: cityGlow 2s infinite alternate;
       }
       
       .island-tile.otherCity { 
           background: linear-gradient(135deg, var(--color-danger), #dc2626);
           border: 2px solid #ef4444;
       }
       
       .island-tile.resource { 
           background: linear-gradient(135deg, #a16207, #ca8a04);
           border: 2px solid #eab308;
       }
       
       .island-tile.wonder { 
           background: linear-gradient(135deg, #be185d, #db2777);
           border: 2px solid #ec4899; animation: wonderGlow 3s infinite alternate;
       }
       
       @keyframes cityGlow {
           0% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
           100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
       }
       
       @keyframes wonderGlow {
           0% { box-shadow: 0 0 15px rgba(236, 72, 153, 0.5); }
           100% { box-shadow: 0 0 25px rgba(236, 72, 153, 0.8); }
       }
       
       .island-details {
           flex: 1; background: var(--color-panel-light); border-radius: 0.5rem; 
           padding: 1rem; display: flex; flex-direction: column; gap: 1rem;
       }
       
       .terrain-info {
           background: var(--color-panel); border-radius: 0.5rem; padding: 0.75rem;
       }
       
       .resource-deposits {
           background: var(--color-panel); border-radius: 0.5rem; padding: 0.75rem;
       }
       
       .island-actions {
           display: flex; flex-direction: column; gap: 0.5rem;
       }

       /* --- VUE RECHERCHE, ETC. --- */
       .management-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));}
       .card { background: var(--color-panel-light); border: 1px solid var(--color-border); border-radius: 0.5rem; padding: 1rem; transition: all 0.3s; }
       .card:hover { border-color: var(--color-primary); transform: translateY(-5px); }
       .card h4 { color: var(--color-primary); margin-bottom: 0.5rem; }
       .card p { color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
       .card .cost { font-size: 0.8rem; margin-bottom: 1rem; }
       .action-btn { width: 100%; background: var(--color-primary); color: var(--color-dark-1); border: none; padding: 0.75rem; border-radius: 0.5rem; font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.3s; }
       .action-btn:hover { transform: scale(1.05); }
       .action-btn:disabled { background: #6b7280; cursor: not-allowed; transform: none; }

       /* --- PANNEAU CONTEXTUEL DROIT --- */
       .right-sidebar { width: 280px; flex-shrink: 0; background: var(--color-panel); padding: 1rem; border-radius: 1rem; display: flex; flex-direction: column; }
       #context-panel { flex-shrink: 0; }
       #context-panel h3 { color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
       #context-panel p { color: var(--color-text-muted); line-height: 1.5; }
       .queue-container { list-style: none; margin-top: auto; padding-top: 1rem; }
       .queue-container h3 { color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
       .queue-item { background: var(--color-panel-light); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
       .queue-item .name { font-weight: bold; }
       .queue-item .timer { color: var(--color-primary); }

       /* --- FOOTER --- */
       .game-footer { padding: 0.5rem 1rem; background: var(--color-panel); border-top: 1px solid var(--color-border); }
       .footer-content { max-width: 1600px; margin: 0 auto; color: var(--color-text-muted); text-align: center; }

       /* --- MODAL --- */
       .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s; }
       .modal-content { background: var(--color-dark-1); border: 1px solid var(--color-primary); padding: 2rem; border-radius: 1rem; text-align: center; width: 90%; max-width: 400px; }
       .modal-content h4 { font-size: 1.5rem; color: var(--color-primary); margin-bottom: 1rem; }
       #modal-cost { color: var(--color-text-muted); margin-bottom: 1rem; }
       .modal-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
       .modal-btn { border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
       .modal-btn.confirm { background: var(--color-primary); color: var(--color-dark-1); }
       .modal-btn.cancel { background: var(--color-panel-light); color: var(--color-text); }
       .modal-btn:hover { opacity: 0.8; }

       /* --- BUILDING SELECTION --- */
       .build-select-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; max-height: 300px; overflow-y: auto; }
       .build-option { background: var(--color-panel-light); padding: 0.5rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; transition: all 0.3s; border: 1px solid transparent; }
       .build-option:hover { border-color: var(--color-primary); transform: translateY(-2px); }
       .build-option .cost { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem; }
       
       /* --- ANIMATIONS ET EFFETS --- */
       @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
       @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
       @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--color-primary); } 50% { box-shadow: 0 0 20px var(--color-primary), 0 0 30px var(--color-primary); } }
       
       .achievement-notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, var(--color-success), #16a34a); color: white; padding: 1rem; border-radius: 0.5rem; z-index: 1001; animation: slideIn 0.5s ease-out; max-width: 300px; }
       .level-up-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, var(--color-primary), #f59e0b); color: var(--color-dark-1); padding: 2rem; border-radius: 1rem; z-index: 1002; animation: bounceIn 0.8s ease-out; text-align: center; font-weight: bold; font-size: 1.2rem; }
       
       .resource-gain { animation: glow 1s ease-in-out; }
       .building-completed { animation: bounceIn 0.6s ease-out; }
       
       /* --- TOOLTIPS AMÉLIORÉS --- */
       .enhanced-tooltip { position: relative; }
       .enhanced-tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: var(--color-dark-1); color: white; padding: 0.5rem; border-radius: 0.25rem; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.3s; font-size: 0.8rem; z-index: 100; }
       .enhanced-tooltip:hover::after { opacity: 1; visibility: visible; }

       /* --- NAVIGATION MOBILE --- */
       .mobile-nav { display: none; }

       /* --- RESPONSIVE DESIGN --- */
       @media (max-width: 900px) {
           .left-sidebar, .right-sidebar { display: none; }
           .game-body { padding: 0.5rem; }
           .main-view { padding: 1rem; }
           .player-info { font-size: 0.9rem; }
           .resources { gap: 0.5rem; padding: 0.5rem; }
           .resource-item { font-size: 0.9rem; }
           .resource-item span { min-width: 30px; }
           
           .game-ui { padding-bottom: 60px; /* Espace pour la nav mobile */ }
           .mobile-nav {
               display: flex;
               position: fixed;
               bottom: 0; left: 0; right: 0;
               background: var(--color-panel);
               backdrop-filter: blur(5px);
               border-top: 1px solid var(--color-border);
               justify-content: space-around;
               padding: 0.5rem 0;
               z-index: 200;
           }
           .mobile-nav a {
               flex-grow: 1;
               text-align: center;
               color: var(--color-text-muted);
               text-decoration: none;
               padding: 0.25rem 0;
               font-size: 1.5rem; /* Icon size */
               position: relative;
           }
           .mobile-nav a.active {
               color: var(--color-primary);
           }
            .mobile-nav a.active::after {
               content: '';
               position: absolute;
               bottom: -5px;
               left: 50%;
               transform: translateX(-50%);
               width: 8px;
               height: 8px;
               background: var(--color-primary);
               border-radius: 50%;
           }
       }

       /* --- STYLES ENHANCED POUR LES NOUVELLES INTERFACES --- */
       
       /* Interface des Conseillers Enhanced */
       .advisors-enhanced-container {
           display: flex;
           flex-direction: column;
           height: 100%;
           gap: 1.5rem;
           padding: 1.5rem;
       }

       .advisors-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           background: var(--color-panel-light);
           padding: 1.5rem;
           border-radius: 1rem;
           border: 1px solid var(--color-border);
       }

       .advisors-header h2 {
           color: var(--color-primary);
           margin: 0;
           font-size: 1.8rem;
       }

       .empire-status {
           display: flex;
           gap: 2rem;
       }

       .status-item {
           display: flex;
           flex-direction: column;
           align-items: center;
           gap: 0.25rem;
       }

       .status-item span:first-child {
           color: var(--color-text-muted);
           font-size: 0.8rem;
       }

       .status-item span:last-child {
           color: var(--color-text);
           font-weight: bold;
       }

       .advisors-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
           gap: 1.5rem;
           flex: 1;
       }

       .advisor-card {
           background: var(--color-panel-light);
           border-radius: 1rem;
           border: 1px solid var(--color-border);
           padding: 1.5rem;
           transition: all 0.3s ease;
           cursor: pointer;
           display: flex;
           flex-direction: column;
           gap: 1rem;
       }

       .advisor-card:hover {
           transform: translateY(-5px);
           box-shadow: 0 10px 30px rgba(251, 191, 36, 0.2);
           border-color: var(--color-primary);
       }

       .advisor-portrait {
           width: 80px;
           height: 80px;
           border-radius: 50%;
           background-size: cover;
           background-position: center;
           border: 3px solid var(--color-primary);
           margin: 0 auto;
       }

       .advisor-info {
           text-align: center;
       }

       .advisor-info h3 {
           color: var(--color-text);
           margin: 0 0 0.5rem 0;
           font-size: 1.2rem;
       }

       .advisor-title {
           color: var(--color-primary);
           font-weight: bold;
           margin-bottom: 0.25rem;
       }

       .advisor-specialty {
           color: var(--color-text-muted);
           font-size: 0.9rem;
       }

       .advisor-status {
           display: flex;
           align-items: center;
           justify-content: center;
           gap: 0.5rem;
           font-size: 0.9rem;
       }

       .status-indicator {
           width: 12px;
           height: 12px;
           border-radius: 50%;
           background: var(--color-success);
       }

       .status-indicator.busy {
           background: var(--color-danger);
       }

       .advisor-actions {
           display: flex;
           justify-content: center;
       }

       .advisor-btn {
           background: linear-gradient(135deg, var(--color-primary), #f59e0b);
           color: white;
           border: none;
           padding: 0.75rem 1.5rem;
           border-radius: 0.5rem;
           cursor: pointer;
           transition: all 0.3s ease;
           font-weight: bold;
       }

       .advisor-btn:hover {
           transform: translateY(-2px);
           box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4);
       }

       .advisor-consultation-panel {
           position: fixed;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           background: var(--color-panel);
           border-radius: 1rem;
           border: 1px solid var(--color-border);
           width: 90%;
           max-width: 600px;
           max-height: 80vh;
           z-index: 1000;
           backdrop-filter: blur(10px);
       }

       .consultation-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 1.5rem;
           border-bottom: 1px solid var(--color-border);
       }

       .consultation-header h3 {
           color: var(--color-primary);
           margin: 0;
       }

       .close-consultation {
           background: none;
           border: none;
           color: var(--color-text-muted);
           font-size: 1.5rem;
           cursor: pointer;
           padding: 0.25rem;
           border-radius: 0.25rem;
           transition: all 0.2s ease;
       }

       .close-consultation:hover {
           background: var(--color-danger);
           color: white;
       }

       .consultation-content {
           padding: 1.5rem;
           max-height: 60vh;
           overflow-y: auto;
       }

       /* Interface de Ville Enhanced */
       .city-enhanced-container {
           display: flex;
           flex-direction: column;
           height: 100%;
           gap: 1rem;
       }

       .city-enhanced-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           background: var(--color-panel-light);
           padding: 1.5rem;
           border-radius: 1rem;
           border: 1px solid var(--color-border);
       }

       .city-title-section h2 {
           color: var(--color-primary);
           margin: 0;
           font-size: 1.8rem;
       }

       .city-level {
           color: var(--color-text-muted);
           font-size: 0.9rem;
           margin-top: 0.25rem;
       }

       .city-quick-actions {
           display: flex;
           gap: 1rem;
       }

       .quick-action-btn {
           background: linear-gradient(135deg, var(--color-secondary), #1d4ed8);
           color: white;
           border: none;
           padding: 0.75rem 1rem;
           border-radius: 0.5rem;
           cursor: pointer;
           transition: all 0.3s ease;
           font-size: 0.9rem;
       }

       .quick-action-btn:hover {
           transform: translateY(-2px);
           box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
       }

       .city-enhanced-main {
           display: flex;
           gap: 1rem;
           flex: 1;
           overflow: hidden;
       }

       .city-resources-panel {
           width: 250px;
           background: var(--color-panel-light);
           border-radius: 1rem;
           padding: 1.5rem;
           border: 1px solid var(--color-border);
           overflow-y: auto;
       }

       .city-resources-panel h3 {
           color: var(--color-primary);
           margin: 0 0 1rem 0;
           font-size: 1.2rem;
       }

       .resource-list {
           display: flex;
           flex-direction: column;
           gap: 0.75rem;
           margin-bottom: 2rem;
       }

       .resource-item-enhanced {
           display: flex;
           align-items: center;
           gap: 0.75rem;
           padding: 0.75rem;
           background: var(--color-panel);
           border-radius: 0.5rem;
           border: 1px solid var(--color-border);
       }

       .resource-icon {
           width: 32px;
           height: 32px;
           border-radius: 50%;
           background-size: contain;
           background-repeat: no-repeat;
           background-position: center;
       }

       .resource-icon.wood { background-color: #16a34a; }
       .resource-icon.marble { background-color: #6b7280; }
       .resource-icon.crystal { background-color: #3b82f6; }
       .resource-icon.sulfur { background-color: #f59e0b; }
       .resource-icon.wine { background-color: #7c2d12; }
       .resource-icon.gold { background-color: #fbbf24; }

       .resource-name {
           flex: 1;
           color: var(--color-text);
           font-weight: 500;
       }

       .resource-amount {
           color: var(--color-primary);
           font-weight: bold;
       }

       .population-info {
           border-top: 1px solid var(--color-border);
           padding-top: 1rem;
       }

       .population-info h4 {
           color: var(--color-primary);
           margin: 0 0 0.75rem 0;
       }

       .population-stat {
           display: flex;
           justify-content: space-between;
           margin-bottom: 0.5rem;
           font-size: 0.9rem;
       }

       .population-stat span:first-child {
           color: var(--color-text-muted);
       }

       .population-stat span:last-child {
           color: var(--color-text);
           font-weight: 500;
       }

       .city-buildings-view {
           flex: 1;
           background: var(--color-panel-light);
           border-radius: 1rem;
           padding: 1.5rem;
           border: 1px solid var(--color-border);
           overflow-y: auto;
       }

       .city-stats-bar {
           display: flex;
           gap: 1rem;
           margin-bottom: 1.5rem;
       }

       .stat-card {
           flex: 1;
           background: var(--color-panel);
           padding: 1rem;
           border-radius: 0.5rem;
           text-align: center;
           border: 1px solid var(--color-border);
       }

       .stat-title {
           color: var(--color-text-muted);
           font-size: 0.8rem;
           margin-bottom: 0.5rem;
       }

       .stat-value {
           color: var(--color-primary);
           font-size: 1.5rem;
           font-weight: bold;
       }

       .buildings-grid-enhanced {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
           gap: 1rem;
       }

       .city-advisor-panel {
           width: 250px;
           background: var(--color-panel-light);
           border-radius: 1rem;
           padding: 1.5rem;
           border: 1px solid var(--color-border);
           overflow-y: auto;
       }

       .city-advisor-panel h3 {
           color: var(--color-primary);
           margin: 0 0 1rem 0;
           font-size: 1.2rem;
       }

       .advisor-card-mini {
           background: var(--color-panel);
           border-radius: 0.5rem;
           padding: 1rem;
           text-align: center;
           margin-bottom: 1.5rem;
           border: 1px solid var(--color-border);
       }

       .advisor-card-mini .advisor-portrait {
           width: 60px;
           height: 60px;
           margin: 0 auto 0.75rem;
       }

       .advisor-name {
           color: var(--color-text);
           font-weight: bold;
           margin-bottom: 0.25rem;
       }

       .advisor-title {
           color: var(--color-primary);
           font-size: 0.8rem;
           margin-bottom: 0.75rem;
       }

       .advisor-btn-mini {
           background: var(--color-primary);
           color: white;
           border: none;
           padding: 0.5rem 1rem;
           border-radius: 0.25rem;
           cursor: pointer;
           font-size: 0.8rem;
           transition: all 0.3s ease;
       }

       .advisor-btn-mini:hover {
           background: #f59e0b;
       }

       .construction-queue-mini,
       .city-events-mini {
           margin-bottom: 1.5rem;
       }

       .construction-queue-mini h4,
       .city-events-mini h4 {
           color: var(--color-primary);
           margin: 0 0 0.75rem 0;
           font-size: 1rem;
       }

       .queue-item-mini {
           display: flex;
           align-items: center;
           gap: 0.75rem;
           background: var(--color-panel);
           padding: 0.75rem;
           border-radius: 0.5rem;
           border: 1px solid var(--color-border);
       }

       .queue-icon {
           width: 32px;
           height: 32px;
           background-size: contain;
           background-repeat: no-repeat;
           background-position: center;
           border-radius: 4px;
       }

       .queue-info {
           flex: 1;
       }

       .queue-name {
           color: var(--color-text);
           font-size: 0.9rem;
           font-weight: 500;
       }

       .queue-time {
           color: var(--color-primary);
           font-size: 0.8rem;
       }

       .event-item-mini {
           background: var(--color-panel);
           padding: 0.75rem;
           border-radius: 0.5rem;
           border: 1px solid var(--color-border);
       }

       .event-text {
           color: var(--color-text);
           font-size: 0.9rem;
           margin-bottom: 0.25rem;
       }

       .event-time {
           color: var(--color-text-muted);
           font-size: 0.7rem;
       }

       /* Responsive pour les nouvelles interfaces */
       @media (max-width: 1200px) {
           .city-enhanced-main {
               flex-direction: column;
           }
           
           .city-resources-panel,
           .city-advisor-panel {
               width: 100%;
               max-height: 200px;
           }
           
           .advisors-grid {
               grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
           }
       }

       @media (max-width: 768px) {
           .city-quick-actions {
               flex-wrap: wrap;
               gap: 0.5rem;
           }
           
           .quick-action-btn {
               padding: 0.5rem 0.75rem;
               font-size: 0.8rem;
           }
           
           .advisors-grid {
               grid-template-columns: 1fr;
           }
           
           .advisor-consultation-panel {
               width: 95%;
               max-height: 90vh;
           }
       }
       }
   </style>
</head>
<body>
   <div class="game-ui">
       <!-- HEADER -->
       <header class="game-header">
           <div class="header-content">
               <div class="player-info">
                   <a href="#" title="Voir le profil du champion">Joueur_01</a>
                   <div style="font-size: 0.8rem; color: var(--color-primary);">
                       Niv. <span id="playerLevel">1</span> | XP: <span id="playerXP">0</span>/<span id="playerXPNeeded">100</span>
                   </div>
               </div>
               <div class="resources">
                   <div class="resource-item" title="Bois - Production de base sur toutes les îles">🌲 <span id="resWood">0</span></div>
                   <div class="resource-item" title="Pierre - Fortifications, bâtiments avancés">🪨 <span id="resStone">0</span></div>
                   <div class="resource-item" title="Fer - Unités militaires">⚔️ <span id="resIron">0</span></div>
                   <div class="resource-item" title="Vin - Bonheur de la population">🍇 <span id="resWine">0</span></div>
                   <div class="resource-item" title="Or - Commerce, entretien des troupes">💰 <span id="resGold">0</span></div>
               </div>
               <div class="player-info">
                   <div style="font-size: 0.8rem; margin-bottom: 0.25rem;">
                       🏆 <span id="achievementCount">0</span> achievements
                   </div>
                   <a href="#" title="Quitter la bataille en douce">Déconnexion</a>
               </div>
           </div>
       </header>

       <!-- CORPS PRINCIPAL -->
       <main class="game-body">
           <!-- MENU GAUCHE (Desktop) -->
           <nav class="left-sidebar main-nav">
               <ul>
                   <li><a href="#" data-view="city" title="Visitez votre ville en pantoufles">🏛️ <span>Ville</span></a></li>
                   <li><a href="#" data-view="island" title="Explorer les îles en tongs">🏝️ <span>Île</span></a></li>
                   <li><a href="#" data-view="world" title="Observer le monde d'un coup d'œil">🌍 <span>Monde</span></a></li>
                   <li><a href="#" data-view="research" title="Traquer les savants fous">🔬 <span>Recherche</span></a></li>
                   <li><a href="#" data-view="military" title="Armez-vous, ça va piquer">⚔️ <span>Militaire</span></a></li>
                   <li><a href="#" data-view="advisors" title="Conseil Impérial">👑 <span>Conseillers</span></a></li>
                   <li><a href="#" data-view="diplomacy" title="Serrer des mains virtuelles">🤝 <span>Diplomatie</span></a></li>
                   <li><a href="#" data-view="achievements" title="Vos exploits héroïques">🏆 <span>Achievements</span></a></li>
                   <li><a href="#" data-view="quests" title="Missions et événements">📋 <span>Quêtes</span></a></li>
                   <li><a href="#" data-view="trade" title="Commerce et échanges">💱 <span>Commerce</span></a></li>
               </ul>
           </nav>

           <!-- VUE CENTRALE (Conteneur pour toutes les vues) -->
           <div class="main-view-container">
               <section id="view-city" class="main-view">
                   <div class="city-container">
                       <!-- En-tête de la ville avec statistiques détaillées -->
                       <div class="city-header">
                           <div class="city-title">
                               <h2>🏛️ <span id="city-name">Capitale Impériale</span></h2>
                               <div class="city-level">Niveau <span id="city-level">1</span></div>
                           </div>
                           <div class="city-vital-stats">
                               <div class="vital-stat population">
                                   <div class="stat-icon">👥</div>
                                   <div class="stat-info">
                                       <div class="stat-value" id="city-population">1000</div>
                                       <div class="stat-label">Population</div>
                                       <div class="stat-growth" id="population-growth">+5/min</div>
                                   </div>
                               </div>
                               <div class="vital-stat happiness">
                                   <div class="stat-icon">😊</div>
                                   <div class="stat-info">
                                       <div class="stat-value" id="city-happiness">75%</div>
                                       <div class="stat-label">Bonheur</div>
                                       <div class="stat-trend" id="happiness-trend">Stable</div>
                                   </div>
                               </div>
                               <div class="vital-stat efficiency">
                                   <div class="stat-icon">⚡</div>
                                   <div class="stat-info">
                                       <div class="stat-value" id="city-efficiency">85%</div>
                                       <div class="stat-label">Efficacité</div>
                                       <div class="stat-modifier" id="efficiency-modifier">+10%</div>
                                   </div>
                               </div>
                               <div class="vital-stat pollution">
                                   <div class="stat-icon">🌫️</div>
                                   <div class="stat-info">
                                       <div class="stat-value" id="city-pollution">25%</div>
                                       <div class="stat-label">Pollution</div>
                                       <div class="stat-impact" id="pollution-impact">Faible</div>
                                   </div>
                               </div>
                           </div>
                       </div>

                       <!-- Districts avec informations détaillées -->
                       <div class="city-districts-panel">
                           <div class="district-card residential" onclick="focusDistrict('residential')">
                               <div class="district-header">
                                   <div class="district-icon">🏠</div>
                                   <div class="district-title">
                                       <h4>Résidentiel</h4>
                                       <div class="district-level">Niv. <span id="residential-level">1</span></div>
                                   </div>
                                   <div class="district-efficiency" id="residential-efficiency">100%</div>
                               </div>
                               <div class="district-stats">
                                   <div class="district-stat">
                                       <span>Logements:</span>
                                       <span id="residential-capacity">500</span>
                                   </div>
                                   <div class="district-stat">
                                       <span>Qualité:</span>
                                       <span id="residential-quality">Basique</span>
                                   </div>
                               </div>
                               <div class="district-production">
                                   <div class="production-item">
                                       <span>👥 +<span id="residential-population-bonus">5</span>/min</span>
                                   </div>
                               </div>
                           </div>

                           <div class="district-card commercial" onclick="focusDistrict('commercial')">
                               <div class="district-header">
                                   <div class="district-icon">🏪</div>
                                   <div class="district-title">
                                       <h4>Commercial</h4>
                                       <div class="district-level">Niv. <span id="commercial-level">1</span></div>
                                   </div>
                                   <div class="district-efficiency" id="commercial-efficiency">100%</div>
                               </div>
                               <div class="district-stats">
                                   <div class="district-stat">
                                       <span>Boutiques:</span>
                                       <span id="commercial-shops">10</span>
                                   </div>
                                   <div class="district-stat">
                                       <span>Attractivité:</span>
                                       <span id="commercial-appeal">Moyenne</span>
                                   </div>
                               </div>
                               <div class="district-production">
                                   <div class="production-item">
                                       <span>💰 +<span id="commercial-gold-bonus">15</span>/min</span>
                                   </div>
                               </div>
                           </div>

                           <div class="district-card industrial" onclick="focusDistrict('industrial')">
                               <div class="district-header">
                                   <div class="district-icon">🏭</div>
                                   <div class="district-title">
                                       <h4>Industriel</h4>
                                       <div class="district-level">Niv. <span id="industrial-level">1</span></div>
                                   </div>
                                   <div class="district-efficiency" id="industrial-efficiency">100%</div>
                               </div>
                               <div class="district-stats">
                                   <div class="district-stat">
                                       <span>Usines:</span>
                                       <span id="industrial-factories">3</span>
                                   </div>
                                   <div class="district-stat">
                                       <span>Pollution:</span>
                                       <span id="industrial-pollution">+15%</span>
                                   </div>
                               </div>
                               <div class="district-production">
                                   <div class="production-item">
                                       <span>🔨 +<span id="industrial-production-bonus">10</span>/min</span>
                                   </div>
                               </div>
                           </div>

                           <div class="district-card cultural" onclick="focusDistrict('cultural')">
                               <div class="district-header">
                                   <div class="district-icon">🎭</div>
                                   <div class="district-title">
                                       <h4>Culturel</h4>
                                       <div class="district-level">Niv. <span id="cultural-level">1</span></div>
                                   </div>
                                   <div class="district-efficiency" id="cultural-efficiency">100%</div>
                               </div>
                               <div class="district-stats">
                                   <div class="district-stat">
                                       <span>Monuments:</span>
                                       <span id="cultural-monuments">2</span>
                                   </div>
                                   <div class="district-stat">
                                       <span>Influence:</span>
                                       <span id="cultural-influence">Locale</span>
                                   </div>
                               </div>
                               <div class="district-production">
                                   <div class="production-item">
                                       <span>😊 +<span id="cultural-happiness-bonus">10</span>%</span>
                                   </div>
                               </div>
                           </div>
                       </div>

                       <!-- Zone principale avec carte de la ville et panneau de détails -->
                       <div class="city-main-area">
                           <div class="city-map-section">
                               <div class="city-view-content" id="city-grid">
                                   <div class="city-roads" id="city-roads"></div>
                               </div>
                               <div class="city-overlay-info">
                                   <div class="weather-indicator" id="city-weather">☀️ Ensoleillé</div>
                                   <div class="time-indicator" id="city-time">Jour 1 - 08:00</div>
                               </div>
                           </div>

                           <div class="city-details-panel" id="city-details">
                               <div class="details-header">
                                   <h3 id="details-title">Aperçu de la Ville</h3>
                                   <button class="close-details" onclick="closeCityDetails()">✕</button>
                               </div>
                               <div class="details-content" id="details-content">
                                   <div class="city-overview">
                                       <h4>🏛️ Gestion Urbaine</h4>
                                       <div class="management-actions">
                                           <button class="management-btn" onclick="openCityPolicies()">
                                               📋 Politiques Urbaines
                                           </button>
                                           <button class="management-btn" onclick="openInfrastructure()">
                                               🛤️ Infrastructure
                                           </button>
                                           <button class="management-btn" onclick="openCityEvents()">
                                               📰 Événements Locaux
                                           </button>
                                       </div>
                                       
                                       <h4>📊 Statistiques Détaillées</h4>
                                       <div class="detailed-stats">
                                           <div class="stat-row">
                                               <span>Croissance démographique:</span>
                                               <span id="population-growth-rate">+2.5%/jour</span>
                                           </div>
                                           <div class="stat-row">
                                               <span>Revenus fiscaux:</span>
                                               <span id="tax-income">+45 or/min</span>
                                           </div>
                                           <div class="stat-row">
                                               <span>Coûts d'entretien:</span>
                                               <span id="maintenance-cost">-20 or/min</span>
                                           </div>
                                           <div class="stat-row">
                                               <span>Bilan net:</span>
                                               <span id="net-income" class="positive">+25 or/min</span>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               </section>
               
               <section id="view-island" class="main-view hidden">
                   <div class="island-view-container">
                       <div class="island-header">
                           <h2>🏝️ <span id="current-island-name">Île Capitale</span></h2>
                           <div class="island-stats">
                               <div class="island-stat">👥 <span id="island-population">1000</span></div>
                               <div class="island-stat">😊 <span id="island-happiness">75%</span></div>
                               <div class="island-stat">🏗️ <span id="island-development">Niv. 1</span></div>
                           </div>
                       </div>
                       <div class="island-main">
                           <div class="island-map-section">
                               <div id="island-grid"></div>
                           </div>
                           <div class="island-details">
                               <div class="terrain-info">
                                   <h4>🌍 Terrain</h4>
                                   <div id="terrain-types">Plaines, Forêts, Collines</div>
                               </div>
                               <div class="resource-deposits">
                                   <h4>⛏️ Ressources</h4>
                                   <div id="natural-resources">Bois, Vin, Marbre</div>
                               </div>
                               <div class="island-actions">
                                   <button class="action-btn" onclick="developIsland()">🏗️ Développer l'île</button>
                                   <button class="action-btn" onclick="exploreIsland()">🔍 Explorer davantage</button>
                               </div>
                           </div>
                       </div>
                   </div>
               </section>
               
               <section id="view-world" class="main-view hidden">
                   <div class="world-view-container">
                       <div class="world-header">
                           <h2>🌍 Empire Mondial</h2>
                           <div class="world-stats">
                               <div>🏝️ Îles: <span id="world-islands-count">1</span></div>
                               <div>🚢 Routes: <span id="world-routes-count">0</span></div>
                               <div>👑 Influence: <span id="world-influence">50</span></div>
                           </div>
                       </div>
                       <div class="world-main">
                           <div class="world-map-section">
                               <div class="weather-system" id="weather-display">☀️ Temps clair</div>
                               <div id="world-map-grid"></div>
                           </div>
                           <div class="world-details">
                               <div class="world-events">
                                   <h4>📰 Événements Mondiaux</h4>
                                   <div id="world-events-list">Aucun événement récent</div>
                               </div>
                               <div class="world-diplomacy">
                                   <h4>🤝 Relations Diplomatiques</h4>
                                   <div id="diplomacy-status">Relations neutres</div>
                               </div>
                               <div class="trade-routes-display">
                                   <h4>🚢 Routes Commerciales</h4>
                                   <div id="trade-routes-list">Aucune route active</div>
                               </div>
                           </div>
                       </div>
                   </div>
               </section>
               <section id="view-research" class="main-view hidden"><h2>Recherche</h2><div id="research-grid" class="management-grid"></div></section>
               <section id="view-military" class="main-view hidden"><h2>Militaire</h2><div id="military-grid" class="management-grid"></div></section>
               <section id="view-advisors" class="main-view hidden">
                   <!-- Interface des Conseillers Enhanced -->
                   <div class="advisors-enhanced-container">
                       <div class="advisors-header">
                           <h2>👑 Conseil Impérial</h2>
                           <div class="empire-status">
                               <div class="status-item">
                                   <span>Stabilité:</span>
                                   <span class="positive">Excellente</span>
                               </div>
                               <div class="status-item">
                                   <span>Influence:</span>
                                   <span>Régionale</span>
                               </div>
                           </div>
                       </div>

                       <div class="advisors-grid">
                           <div class="advisor-card" data-advisor="military">
                               <div class="advisor-portrait" style="background-image: url('Romain/Quintus_Cornelius_Crassus_asset_pack/legatus_homme_bust.png');"></div>
                               <div class="advisor-info">
                                   <h3>Quintus Cornelius</h3>
                                   <div class="advisor-title">Légat Militaire</div>
                                   <div class="advisor-specialty">Stratégie & Défense</div>
                               </div>
                               <div class="advisor-status">
                                   <div class="status-indicator active"></div>
                                   <span>Disponible</span>
                               </div>
                               <div class="advisor-actions">
                                   <button class="advisor-btn" onclick="consultAdvisor('military')">Consulter</button>
                               </div>
                           </div>

                           <div class="advisor-card" data-advisor="economic">
                               <div class="advisor-portrait" style="background-image: url('Romain/Lucius_Cornelius_Crassus_asset_pack/patrician_male_homme_bust.png');"></div>
                               <div class="advisor-info">
                                   <h3>Lucius Cornelius</h3>
                                   <div class="advisor-title">Questeur</div>
                                   <div class="advisor-specialty">Économie & Commerce</div>
                               </div>
                               <div class="advisor-status">
                                   <div class="status-indicator active"></div>
                                   <span>Disponible</span>
                               </div>
                               <div class="advisor-actions">
                                   <button class="advisor-btn" onclick="consultAdvisor('economic')">Consulter</button>
                               </div>
                           </div>

                           <div class="advisor-card" data-advisor="diplomatic">
                               <div class="advisor-portrait" style="background-image: url('Romain/Valeria_Drusilla_asset_pack/patrician_female_femme_bust.png');"></div>
                               <div class="advisor-info">
                                   <h3>Valeria Drusilla</h3>
                                   <div class="advisor-title">Ambassadrice</div>
                                   <div class="advisor-specialty">Diplomatie & Relations</div>
                               </div>
                               <div class="advisor-status">
                                   <div class="status-indicator active"></div>
                                   <span>Disponible</span>
                               </div>
                               <div class="advisor-actions">
                                   <button class="advisor-btn" onclick="consultAdvisor('diplomatic')">Consulter</button>
                               </div>
                           </div>

                           <div class="advisor-card" data-advisor="research">
                               <div class="advisor-portrait" style="background-image: url('Romain/Fabia_Maxima_asset_pack/vestal_femme_bust.png');"></div>
                               <div class="advisor-info">
                                   <h3>Fabia Maxima</h3>
                                   <div class="advisor-title">Grande Vestale</div>
                                   <div class="advisor-specialty">Recherche & Savoir</div>
                               </div>
                               <div class="advisor-status">
                                   <div class="status-indicator active"></div>
                                   <span>Disponible</span>
                               </div>
                               <div class="advisor-actions">
                                   <button class="advisor-btn" onclick="consultAdvisor('research')">Consulter</button>
                               </div>
                           </div>

                           <div class="advisor-card" data-advisor="construction">
                               <div class="advisor-portrait" style="background-image: url('Romain/Titus_Fabius_Scipio_asset_pack/praetorian_homme_bust.png');"></div>
                               <div class="advisor-info">
                                   <h3>Titus Fabius</h3>
                                   <div class="advisor-title">Architecte Impérial</div>
                                   <div class="advisor-specialty">Construction & Urbanisme</div>
                               </div>
                               <div class="advisor-status">
                                   <div class="status-indicator active"></div>
                                   <span>Disponible</span>
                               </div>
                               <div class="advisor-actions">
                                   <button class="advisor-btn" onclick="consultAdvisor('construction')">Consulter</button>
                               </div>
                           </div>

                           <div class="advisor-card" data-advisor="espionage">
                               <div class="advisor-portrait" style="background-image: url('Romain/Gaius_Valerius_Maximus_asset_pack/gladiator_homme_bust.png');"></div>
                               <div class="advisor-info">
                                   <h3>Gaius Valerius</h3>
                                   <div class="advisor-title">Maître Espion</div>
                                   <div class="advisor-specialty">Renseignement & Sécurité</div>
                               </div>
                               <div class="advisor-status">
                                   <div class="status-indicator active"></div>
                                   <span>Disponible</span>
                               </div>
                               <div class="advisor-actions">
                                   <button class="advisor-btn" onclick="consultAdvisor('espionage')">Consulter</button>
                               </div>
                           </div>
                       </div>

                       <div class="advisor-consultation-panel" id="advisor-consultation" style="display: none;">
                           <div class="consultation-header">
                               <h3 id="consultation-title">Consultation</h3>
                               <button class="close-consultation" onclick="closeConsultation()">✕</button>
                           </div>
                           <div class="consultation-content" id="consultation-content">
                               <!-- Contenu dynamique -->
                           </div>
                       </div>
                   </div>
               </section>
               <section id="view-battle" class="main-view hidden"><h2>Bataille</h2><div id="battle-grid" class="management-grid"></div></section>
               <section id="view-diplomacy" class="main-view hidden"><h2>Diplomatie</h2><div id="diplomacy-grid" class="management-grid"></div></section>
               <section id="view-achievements" class="main-view hidden"><h2>Achievements & Statistiques</h2><div id="achievements-grid" class="management-grid"></div></section>
               <section id="view-quests" class="main-view hidden"><h2>Quêtes & Événements</h2><div id="quests-grid" class="management-grid"></div></section>
               <section id="view-trade" class="main-view hidden"><h2>Commerce & Échanges</h2><div id="trade-grid" class="management-grid"></div></section>
           </div>
           
           <!-- PANNEAU DROIT (Desktop) -->
           <aside class="right-sidebar">
               <div id="context-panel">
                   <!-- Contenu injecté par JavaScript -->
               </div>
               <div class="queue-container">
                   <h3>Files d'attente</h3>
                   <ul id="queueList"></ul>
               </div>
           </aside>
       </main>

       <!-- FOOTER -->
       <footer class="game-footer">
           <div class="footer-content">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                   <div id="event-log">Bienvenue dans Empire !</div>
                   <div style="display: flex; gap: 1rem;">
                       <button onclick="showHelp('buildings')" style="background: none; border: 1px solid var(--color-border); color: var(--color-text); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">💡 Aide</button>
                       <button onclick="saveState(); logEvent('💾 Jeu sauvegardé manuellement')" style="background: none; border: 1px solid var(--color-border); color: var(--color-text); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">💾 Sauvegarder</button>
                       <button onclick="if(confirm('Êtes-vous sûr de vouloir recommencer ? Toute progression sera perdue.')) { localStorage.removeItem('empireGameState'); location.reload(); }" style="background: none; border: 1px solid var(--color-danger); color: var(--color-danger); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">🔄 Reset</button>
                   </div>
               </div>
           </div>
       </footer>

       <!-- NAVIGATION MOBILE -->
       <nav class="mobile-nav main-nav">
²
           <a href="#" data-view="city" title="Ville, version poche">🏛️</a>
           <a href="#" data-view="island" title="Île au bout du doigt">🏝️</a>
           <a href="#" data-view="world" title="Le monde tient dans ta main">🌍</a>
           <a href="#" data-view="research" title="Science express">🔬</a>
           <a href="#" data-view="military" title="Prêt pour l'assaut miniature">⚔️</a>
           <a href="#" data-view="advisors" title="Conseillers">👑</a>
           <a href="#" data-view="diplomacy" title="Diplomatie de poche">🤝</a>
           <a href="#" data-view="achievements" title="Vos trophées">🏆</a>
           <a href="#" data-view="quests" title="Missions">📋</a>
           <a href="#" data-view="trade" title="Commerce">💱</a>

       </nav>
   </div>
   
   <!-- MODAL -->

   <div class="modal-overlay" id="actionModal"><div class="modal-content"><h4 id="modalTitle"></h4><p id="modalMessage"></p><div id="modal-cost"></div><div class="modal-actions"><button class="modal-btn cancel" id="modalCancelBtn" title="Annule comme un ninja">Annuler</button><button class="modal-btn confirm" id="modalConfirmBtn" title="Confirme, brave héros">Confirmer</button></div></div></div>

   <script src="gameplay.js"></script>
   <script>
       document.addEventListener('DOMContentLoaded', function() {
           // --- CONFIGURATION DU JEU ---
           const config = {
               buildings: {
                   // Bâtiments selon le GDD Imperium avec formules exactes
                   "Forum": { 
                       description: "Augmente population max et débloque nouveaux bâtiments", 
                       icon: "🏛️", 
                       category: "government",
                       effect: "Population max = 50 + 25 * Niveau",
                       levels: [
                           { cost: { wood: 200, stone: 100 }, buildTime: 5 },   // Niveau 1: T = 5 * 1^1.5 = 5 min
                           { cost: { wood: 300, stone: 140 }, buildTime: 11 },  // Niveau 2: T = 5 * 2^1.5 = 11 min
                           { cost: { wood: 450, stone: 196 }, buildTime: 18 },  // Niveau 3: T = 5 * 3^1.5 = 18 min
                           { cost: { wood: 675, stone: 274 }, buildTime: 25 }   // Niveau 4: T = 5 * 4^1.5 = 25 min
                       ]
                   },
                   "Camp de Bûcherons": { 
                       description: "Produit du bois (production de base)", 
                       icon: "🌲", 
                       category: "production",
                       effect: "Production = 10 * (1 + 0.1 * (Niveau - 1)) * Bonus île",
                       levels: [
                           { cost: { wood: 150 }, buildTime: 5 },
                           { cost: { wood: 225 }, buildTime: 11 },
                           { cost: { wood: 338 }, buildTime: 18 },
                           { cost: { wood: 507 }, buildTime: 25 }
                       ]
                   },
                   "Carrière": { 
                       description: "Produit de la pierre pour fortifications", 
                       icon: "🪨", 
                       category: "production",
                       effect: "Production = 8 * (1 + 0.1 * (Niveau - 1)) * Bonus île",
                       levels: [
                           { cost: { wood: 200, stone: 50 }, buildTime: 8 },
                           { cost: { wood: 300, stone: 70 }, buildTime: 16 },
                           { cost: { wood: 450, stone: 98 }, buildTime: 26 },
                           { cost: { wood: 675, stone: 137 }, buildTime: 38 }
                       ]
                   },
                   "Mine de Fer": { 
                       description: "Produit du fer pour unités militaires", 
                       icon: "⛏️", 
                       category: "production",
                       effect: "Production = 6 * (1 + 0.1 * (Niveau - 1)) * Bonus île",
                       levels: [
                           { cost: { wood: 250, stone: 100 }, buildTime: 10 },
                           { cost: { wood: 375, stone: 140 }, buildTime: 20 },
                           { cost: { wood: 563, stone: 196 }, buildTime: 32 },
                           { cost: { wood: 844, stone: 274 }, buildTime: 46 }
                       ]
                   },
                   "Vignoble": { 
                       description: "Produit du vin pour le bonheur", 
                       icon: "🍇", 
                       category: "production",
                       effect: "Production = 4 * (1 + 0.1 * (Niveau - 1)) * Bonus île",
                       levels: [
                           { cost: { wood: 180, stone: 80 }, buildTime: 7 },
                           { cost: { wood: 270, stone: 112 }, buildTime: 14 },
                           { cost: { wood: 405, stone: 157 }, buildTime: 23 },
                           { cost: { wood: 608, stone: 220 }, buildTime: 34 }
                       ]
                   },
                   "Entrepôt": { 
                       description: "Augmente la capacité de stockage", 
                       icon: "🏪", 
                       category: "logistics",
                       effect: "Capacité = 500 * Niveau^1.2",
                       levels: [
                           { cost: { wood: 300 }, buildTime: 6 },
                           { cost: { wood: 450 }, buildTime: 12 },
                           { cost: { wood: 675 }, buildTime: 20 },
                           { cost: { wood: 1013 }, buildTime: 30 }
                       ]
                   },
                   "Caserne": { 
                       description: "Permet de recruter des unités terrestres", 
                       icon: "⚔️", 
                       category: "military",
                       effect: "Débloque unités: Velites, Hastati, Légionnaires, Equites",
                       levels: [
                           { cost: { wood: 400, stone: 200, iron: 100 }, buildTime: 15 },
                           { cost: { wood: 600, stone: 280, iron: 140 }, buildTime: 30 },
                           { cost: { wood: 900, stone: 392, iron: 196 }, buildTime: 48 },
                           { cost: { wood: 1350, stone: 549, iron: 274 }, buildTime: 70 }
                       ]
                   },
                   "Chantier Naval": { 
                       description: "Construit des navires de guerre et marchands", 
                       icon: "⚓", 
                       category: "military",
                       effect: "Débloque navires: Marchands, Trirèmes, Quinquérèmes",
                       levels: [
                           { cost: { wood: 500, stone: 150, iron: 200 }, buildTime: 20 },
                           { cost: { wood: 750, stone: 210, iron: 280 }, buildTime: 40 },
                           { cost: { wood: 1125, stone: 294, iron: 392 }, buildTime: 64 },
                           { cost: { wood: 1688, stone: 412, iron: 549 }, buildTime: 92 }
                       ]
                   },
                   "Académie": { 
                       description: "Permet la recherche technologique", 
                       icon: "🔬", 
                       category: "research",
                       effect: "Débloque les 4 branches de recherche",
                       levels: [
                           { cost: { wood: 350, stone: 250, gold: 200 }, buildTime: 18 },
                           { cost: { wood: 525, stone: 350, gold: 280 }, buildTime: 36 },
                           { cost: { wood: 788, stone: 490, gold: 392 }, buildTime: 58 },
                           { cost: { wood: 1181, stone: 686, gold: 549 }, buildTime: 84 }
                       ]
                   },
                   "Taverne": { 
                       description: "Augmente le bonheur de la population", 
                       icon: "🍺", 
                       category: "social",
                       effect: "Bonheur +5 à +50 selon niveau",
                       levels: [
                           { cost: { wood: 250, wine: 50 }, buildTime: 8 },
                           { cost: { wood: 375, wine: 70 }, buildTime: 16 },
                           { cost: { wood: 563, wine: 98 }, buildTime: 26 },
                           { cost: { wood: 844, wine: 137 }, buildTime: 38 }
                       ]
                   },
                   "Muraille": { 
                       description: "Renforce la défense de la ville", 
                       icon: "🛡️", 
                       category: "defense",
                       effect: "Défense +25% par niveau",
                       levels: [
                           { cost: { wood: 300, stone: 400 }, buildTime: 12 },
                           { cost: { wood: 450, stone: 560 }, buildTime: 24 },
                           { cost: { wood: 675, stone: 784 }, buildTime: 38 },
                           { cost: { wood: 1013, stone: 1098 }, buildTime: 56 }
                       ]
                   }
               },
               research: {
                   // 4 branches de recherche selon le GDD Imperium
                   urbanisme: { 
                       name: "Urbanisme", 
                       icon: "🏛️", 
                       description: "Débloque bâtiments avancés et améliorations urbaines",
                       techs: { 
                           "Aqueducs": { description: "Augmente la population max de 25%.", cost: { gold: 100, stone: 50 }, time: 2 },      // Temps = Base * 2^1 = 2h
                           "Amphithéâtres": { description: "Bonus bonheur +20 pour toute la ville.", cost: { gold: 200, stone: 100 }, time: 4 },  // Temps = Base * 2^2 = 4h
                           "Thermes": { description: "Réduit la consommation de vin de 30%.", cost: { gold: 400, stone: 200 }, time: 8 },        // Temps = Base * 2^3 = 8h
                           "Égouts": { description: "Prévient les épidémies et maladies.", cost: { gold: 800, stone: 400 }, time: 16 }           // Temps = Base * 2^4 = 16h
                       } 
                   },
                   militaire: { 
                       name: "Militaire", 
                       icon: "⚔️", 
                       description: "Nouvelles unités, sièges et discipline militaire",
                       techs: { 
                           "Phalange": { description: "Débloque les Hastati (infanterie de base).", cost: { gold: 150, iron: 100 }, time: 3 },
                           "Discipline": { description: "Augmente l'attaque de toutes les unités de 15%.", cost: { gold: 300, iron: 200 }, time: 6 },
                           "Machines de Siège": { description: "Débloque les Balistes pour sièges.", cost: { gold: 600, iron: 400 }, time: 12 },
                           "Légions": { description: "Débloque les Légionnaires (infanterie lourde).", cost: { gold: 1200, iron: 800 }, time: 24 }
                       } 
                   },
                   economie: {
                       name: "Économie",
                       icon: "💰",
                       description: "Routes commerciales et optimisation de production",
                       techs: {
                           "Commerce": { description: "Augmente les revenus en or de 25%.", cost: { gold: 200, wood: 100 }, time: 2 },
                           "Routes Commerciales": { description: "Réduit les coûts de transport de 50%.", cost: { gold: 400, wood: 200 }, time: 4 },
                           "Monnaie": { description: "Génère +2 or/min par niveau de Forum.", cost: { gold: 800, wood: 400 }, time: 8 },
                           "Banque Impériale": { description: "Génère des intérêts sur votre or (1%/jour).", cost: { gold: 1600, wood: 800 }, time: 16 }
                       }
                   },
                   diplomatie: {
                       name: "Diplomatie",
                       icon: "🤝",
                       description: "Alliances, espionnage et commerce avancé",
                       techs: {
                           "Ambassades": { description: "Permet de former des alliances.", cost: { gold: 250, wine: 50 }, time: 3 },
                           "Espionnage": { description: "Débloque les missions d'espionnage.", cost: { gold: 500, wine: 100 }, time: 6 },
                           "Traités": { description: "Bonus alliance +10% (défense et économie).", cost: { gold: 1000, wine: 200 }, time: 12 },
                           "Réseau d'Espions": { description: "Révèle les mouvements ennemis.", cost: { gold: 2000, wine: 400 }, time: 24 }
                       }
                   }
               },
               units: {
                   // Unités terrestres selon le GDD Imperium
                   land: {
                       "Velites": { 
                           description: "Éclaireurs rapides, faibles", 
                           icon: "🏃", 
                           stats: { attack: 5, defense: 3, speed: 8 },
                           cost: { wood: 30, iron: 20, gold: 15 }, 
                           time: 3,
                           requires: "Caserne niveau 1"
                       },
                       "Hastati": { 
                           description: "Infanterie de base", 
                           icon: "⚔️", 
                           stats: { attack: 8, defense: 6, speed: 5 },
                           cost: { wood: 50, iron: 40, gold: 25 }, 
                           time: 5,
                           requires: "Caserne niveau 1 + Recherche Phalange"
                       },
                       "Légionnaires": { 
                           description: "Infanterie lourde", 
                           icon: "🛡️", 
                           stats: { attack: 12, defense: 10, speed: 4 },
                           cost: { wood: 80, iron: 60, gold: 40 }, 
                           time: 8,
                           requires: "Caserne niveau 2 + Recherche Légions"
                       },
                       "Equites": { 
                           description: "Cavalerie", 
                           icon: "🐎", 
                           stats: { attack: 10, defense: 7, speed: 10 },
                           cost: { wood: 70, iron: 50, gold: 60 }, 
                           time: 7,
                           requires: "Caserne niveau 2"
                       },
                       "Balistes": { 
                           description: "Siège", 
                           icon: "🏹", 
                           stats: { attack: 20, defense: 5, speed: 2 },
                           cost: { wood: 150, iron: 100, gold: 80 }, 
                           time: 12,
                           requires: "Caserne niveau 3 + Recherche Machines de Siège"
                       }
                   },
                   // Unités navales selon le GDD Imperium
                   naval: {
                       "Navires Marchands": { 
                           description: "Transport de ressources et colonisation", 
                           icon: "🚢", 
                           stats: { cargo: 500, defense: 2, speed: 6 },
                           cost: { wood: 200, iron: 50, gold: 100 }, 
                           time: 15,
                           requires: "Chantier Naval niveau 1"
                       },
                       "Trirèmes": { 
                           description: "Guerre rapide", 
                           icon: "⚓", 
                           stats: { attack: 15, defense: 8, speed: 8 },
                           cost: { wood: 300, iron: 100, gold: 150 }, 
                           time: 20,
                           requires: "Chantier Naval niveau 2"
                       },
                       "Quinquérèmes": { 
                           description: "Transport lourd", 
                           icon: "🛳️", 
                           stats: { attack: 20, defense: 12, cargo: 1000, speed: 5 },
                           cost: { wood: 500, iron: 200, gold: 250 }, 
                           time: 30,
                           requires: "Chantier Naval niveau 3"
                       }
                   }
               },
               diplomacy: {
                   alliances: { "Les Spartiates": { tag: "SPQR", members: 15, points: 12000 } },
                   treaties: { "Traité Culturel": { description: "Augmente le bonheur de vos villes.", cost: { gold: 1000 } } }
               },
               cityLayout: [
                   { id: "townHall", top: "40%", left: "45%", width: "120px", height: "120px" }, { id: "plot1", top: "35%", left: "25%", width: "90px", height: "90px" },
                   { id: "plot2", top: "55%", left: "30%", width: "90px", height: "90px" }, { id: "plot3", top: "50%", left: "60%", width: "90px", height: "90px" },
                   { id: "academy", top: "20%", left: "60%", width: "90px", height: "90px" }, { id: "plot4", top: "20%", left: "30%", width: "90px", height: "90px" },
                   { id: "plot5", top: "70%", left: "40%", width: "90px", height: "90px" }, { id: "plot6", top: "75%", left: "65%", width: "90px", height: "90px" },
                   { id: "plot7", top: "25%", left: "75%", width: "90px", height: "90px" }, { id: "plot8", top: "65%", left: "75%", width: "90px", height: "90px" }
               ],
               islandLayout: {
                   size: 7,
                   plots: [
                       { x: 3, y: 3, type: 'playerCity', name: 'Votre Ville', icon: '🏛️' },
                       { x: 2, y: 5, type: 'otherCity', name: 'Ville de Joueur_02', icon: '🏘️' },
                       { x: 1, y: 2, type: 'resource', name: 'Scierie (Bois)', icon: '🌲' },
                       { x: 5, y: 4, type: 'resource', name: 'Mine de Marbre', icon: '💎' },
                       { x: 4, y: 1, type: 'wonder', name: 'Merveille Antique', icon: '🌟' }
                   ]
               },
               worldMap: {
                   size: 15,
                   islands: [
                       { x: 7, y: 7, type: 'player', name: 'Votre Capitale' },
                       { x: 8, y: 9, type: 'ally', name: 'Allié_01' },
                       { x: 5, y: 6, type: 'enemy', name: 'Ennemi_Alpha' },
                       { x: 10, y: 11, type: 'island', name: 'Île aux merveilles' },
                       { x: 3, y: 4, type: 'island', name: 'Île sauvage' },
                       { x: 12, y: 5, type: 'island', name: 'Île abandonnée' }
                   ]
               },
               worldActions: {
                   explore: { label: 'Explorer', cost: { wood: 50, gold: 100 }, description: "Révèle les détails de la case." },
                   colonize: { label: 'Coloniser', cost: { wood: 1000, gold: 500 }, description: "Fonde une nouvelle colonie." },
                   attack: { label: 'Attaquer', cost: { sulfur: 200 }, description: "Lance une attaque contre l'île ciblée." }
               }
           };

           // --- ÉTAT DU JEU ---
           let gameState;
           const defaultGameState = {
               // Ressources selon le GDD Imperium (5 ressources principales)
               resources: { 
                   wood: 500,      // Production de base sur toutes les îles
                   stone: 200,     // Fortifications, bâtiments avancés  
                   iron: 100,      // Unités militaires
                   wine: 50,       // Bonheur de la population (consommation journalière)
                   gold: 1000      // Commerce, entretien des troupes, accélérations
               },
               // Bâtiments selon le système Imperium
               buildings: { 
                   "forum": { type: "Forum", level: 1, constructing: false, timeLeft: 0 }, 
                   "lumbercamp": { type: "Camp de Bûcherons", level: 1, constructing: false, timeLeft: 0 }, 
                   "quarry": { type: "Carrière", level: 0, constructing: false, timeLeft: 0 }, 
                   "ironmine": { type: "Mine de Fer", level: 0, constructing: false, timeLeft: 0 }, 
                   "vineyard": { type: "Vignoble", level: 0, constructing: false, timeLeft: 0 }, 
                   "warehouse": { type: "Entrepôt", level: 1, constructing: false, timeLeft: 0 },
                   "barracks": { type: "Caserne", level: 0, constructing: false, timeLeft: 0 },
                   "shipyard": { type: "Chantier Naval", level: 0, constructing: false, timeLeft: 0 },
                   "academy": { type: "Académie", level: 0, constructing: false, timeLeft: 0 },
                   "tavern": { type: "Taverne", level: 0, constructing: false, timeLeft: 0 },
                   "wall": { type: "Muraille", level: 0, constructing: false, timeLeft: 0 }
               },
               // Armée selon les unités romaines du GDD
               military: {
                   land: {
                       velites: 0,        // Éclaireurs rapides, faibles
                       hastati: 0,        // Infanterie de base
                       legionnaires: 0,   // Infanterie lourde
                       equites: 0,        // Cavalerie
                       balistes: 0        // Siège
                   },
                   naval: {
                       merchant: 0,       // Navires marchands (transport)
                       trireme: 0,        // Trirèmes (guerre rapide)
                       quinquereme: 0     // Quinquérèmes (transport lourd)
                   }
               },
               // Système de recherche avec 4 branches selon le GDD
               research: {
                   completed: [],
                   inProgress: null,
                   branches: {
                       urbanisme: { level: 0, researching: false, timeLeft: 0 },    // Débloque bâtiments
                       militaire: { level: 0, researching: false, timeLeft: 0 },    // Nouvelles unités, sièges
                       economie: { level: 0, researching: false, timeLeft: 0 },     // Routes commerciales, optimisation
                       diplomatie: { level: 0, researching: false, timeLeft: 0 }    // Alliances, espionnage
                   }
               },
               // Population et bonheur selon le GDD
               population: {
                   current: 75,        // Population actuelle
                   max: 75,           // Population max = 50 + 25 * Niveau_Forum
                   happiness: 80,     // Influencé par vin et bâtiments
                   wineConsumption: 5 // Consommation de vin par jour
               },
               queues: { build: [], research: [], military: [] },
               cooldowns: { build: 0, research: 0, military: 0 },
               exploredIslands: [{ x: 7, y: 7, name: "Île Capitale", type: "capital", resources: ["wood", "wine"], population: 1000, development: 1 }],
               colonizedIslands: [],
               currentIsland: { x: 7, y: 7 }, // Île actuellement sélectionnée
               islandDetails: {
                   "7-7": {
                       name: "Île Capitale",
                       type: "capital",
                       climate: "temperate",
                       terrain: ["plains", "forest", "hills"],
                       naturalResources: ["wood", "wine", "marble"],
                       population: 1000,
                       happiness: 75,
                       development: 1,
                       infrastructure: { roads: 1, ports: 1, defenses: 1 },
                       specialBuildings: [],
                       districts: {
                           residential: { level: 1, population: 400 },
                           commercial: { level: 1, income: 50 },
                           industrial: { level: 1, production: 30 },
                           military: { level: 1, defense: 25 }
                       }
                   }
               },
               worldEvents: [],
               tradeRoutes: [],
               diplomacy: {
                   relations: {},
                   treaties: [],
                   reputation: 50
               },
               playerStats: { level: 1, xp: 0, totalBuildings: 2, totalUnits: 0 },
               achievements: [],
               activeQuests: [],
               completedQuests: [],
               questPoints: 0,
               eventHistory: [],
               lastEventTime: 0,
               lastEventCheck: 0,
               tradeReputation: 50,
               tradeHistory: [],
               activeContracts: [],
               militaryUnits: [],
               lastUpdate: Date.now()
           };

           // --- DOM ELEMENTS ---
           const dom = {
               res: Object.keys(defaultGameState.resources).reduce((acc, key) => ({ ...acc, [key]: document.getElementById(`res${key.charAt(0).toUpperCase() + key.slice(1)}`) }), {}),
               cityGrid: document.getElementById('city-grid'), islandGrid: document.getElementById('island-grid'),
               worldMapGrid: document.getElementById('world-map-grid'),
               contextPanel: document.getElementById('context-panel'), queueList: document.getElementById('queueList'),
               eventLog: document.getElementById('event-log'), modal: document.getElementById('actionModal'),
               modalTitle: document.getElementById('modalTitle'), modalMessage: document.getElementById('modalMessage'),
               modalCost: document.getElementById('modal-cost'), modalConfirmBtn: document.getElementById('modalConfirmBtn'),
               modalCancelBtn: document.getElementById('modalCancelBtn'), navLinks: document.querySelectorAll('.main-nav a'),
               mainViews: document.querySelectorAll('.main-view'), researchGrid: document.getElementById('research-grid'),
               militaryGrid: document.getElementById('military-grid'), battleGrid: document.getElementById('battle-grid'),
               diplomacyGrid: document.getElementById('diplomacy-grid'), questsGrid: document.getElementById('quests-grid'),
               tradeGrid: document.getElementById('trade-grid'), achievementsGrid: document.getElementById('achievements-grid'),
               worldGrid: document.getElementById('world-grid'),
           };

           let selectedPlotId = null;
           let currentAction = null;
           const ACTION_COOLDOWNS = { build: 5, research: 5, military: 5 };
           function isCooldownActive(type) { return gameState.cooldowns[type] && Date.now() < gameState.cooldowns[type]; }

           // --- PERSISTANCE DES DONNÉES ---
           function saveState() { localStorage.setItem('empireGameState', JSON.stringify(gameState)); }
          function loadState() {
              const savedState = localStorage.getItem('empireGameState');
               gameState = savedState ? JSON.parse(savedState) : JSON.parse(JSON.stringify(defaultGameState));
               
               // Migration des anciennes sauvegardes
               if (!gameState.cooldowns) gameState.cooldowns = { build: 0, research: 0, military: 0 };
               if (!gameState.exploredIslands) gameState.exploredIslands = [{ x: 7, y: 7, name: "Île Capitale", type: "capital", resources: ["wood", "wine"], population: 1000, development: 1 }];
               if (!gameState.colonizedIslands) gameState.colonizedIslands = [];
               if (!gameState.currentIsland) gameState.currentIsland = { x: 7, y: 7 };
               if (!gameState.islandDetails) gameState.islandDetails = {};
               if (!gameState.worldEvents) gameState.worldEvents = [];
               if (!gameState.tradeRoutes) gameState.tradeRoutes = [];
               if (!gameState.diplomacy) gameState.diplomacy = { relations: {}, treaties: [], reputation: 50 };
               if (!gameState.playerStats) gameState.playerStats = { level: 1, xp: 0, totalBuildings: 2, totalUnits: 0 };
               if (!gameState.achievements) gameState.achievements = [];
               if (!gameState.activeQuests) {
                   gameState.activeQuests = [];
               } else {
                   // Reconnect quest condition functions that were lost during JSON serialization
                   gameState.activeQuests = gameState.activeQuests
                       .map(q => {
                           const template = QUEST_TEMPLATES.find(t => t.id === q.id);
                           // If the template exists, merge it with the saved quest and restore the condition function.
                           // If no matching template is found, return null so it can be filtered out.
                           return template ? { ...template, ...q, condition: template.condition } : null;
                       })
                       .filter(Boolean); // Remove quests without valid templates
               }
               if (!gameState.completedQuests) gameState.completedQuests = [];
               if (!gameState.eventHistory) gameState.eventHistory = [];
               if (!gameState.lastEventTime) gameState.lastEventTime = 0;
               
              const offlineTime = (Date.now() - gameState.lastUpdate) / 1000;
              produceResources(offlineTime);
              gameState.lastUpdate = Date.now();
              
              // Afficher les gains hors ligne si significatifs
              if (offlineTime > 60) {
                  logEvent(`Bienvenue ! Vous avez gagné des ressources pendant votre absence (${Math.floor(offlineTime/60)} min).`);
              }
          }

           // --- NAVIGATION & VUES ---
           function switchView(viewId) {
               dom.mainViews.forEach(view => view.classList.add('hidden'));
               document.getElementById(`view-${viewId}`).classList.remove('hidden');
               dom.navLinks.forEach(link => {
                   link.classList.toggle('active', link.dataset.view === viewId);
               });
               updateContextPanel(); // Clear context panel on view switch
               
               // Initialiser les nouvelles interfaces enhanced
               if (viewId === 'advisors') {
                   initializeAdvisorsView();
               } else if (viewId === 'city') {
                   initializeCityEnhancedView();
               }
           }

           // --- FONCTIONS ENHANCED POUR LES NOUVELLES INTERFACES ---
           
           // Interface des Conseillers Enhanced
           function consultAdvisor(advisorType) {
               const advisorData = {
                   military: {
                       name: "Quintus Cornelius",
                       title: "Légat Militaire",
                       advice: "Nos légions sont prêtes, César ! Je recommande de renforcer nos défenses avant d'étendre l'Empire.",
                       actions: [
                           { name: "Recruter des Légionnaires", cost: { gold: 100 }, effect: "military" },
                           { name: "Améliorer les Fortifications", cost: { marble: 200 }, effect: "defense" },
                           { name: "Organiser des Manœuvres", cost: { gold: 50 }, effect: "training" }
                       ]
                   },
                   economic: {
                       name: "Lucius Cornelius",
                       title: "Questeur",
                       advice: "Les finances de l'Empire sont stables. Je suggère d'investir dans le commerce pour augmenter nos revenus.",
                       actions: [
                           { name: "Développer le Commerce", cost: { gold: 150 }, effect: "trade" },
                           { name: "Réduire les Taxes", cost: { gold: 100 }, effect: "happiness" },
                           { name: "Construire des Marchés", cost: { wood: 200, gold: 100 }, effect: "economy" }
                       ]
                   },
                   diplomatic: {
                       name: "Valeria Drusilla",
                       title: "Ambassadrice",
                       advice: "Les relations avec nos voisins sont tendues. Une approche diplomatique pourrait éviter des conflits coûteux.",
                       actions: [
                           { name: "Envoyer des Ambassadeurs", cost: { gold: 200 }, effect: "diplomacy" },
                           { name: "Organiser un Banquet", cost: { wine: 50, gold: 100 }, effect: "relations" },
                           { name: "Signer un Traité Commercial", cost: { gold: 300 }, effect: "trade_agreement" }
                       ]
                   },
                   research: {
                       name: "Fabia Maxima",
                       title: "Grande Vestale",
                       advice: "Les dieux nous accordent leur faveur. Nos recherches progressent bien, mais nous pourrions accélérer le processus.",
                       actions: [
                           { name: "Accélérer les Recherches", cost: { crystal: 100, gold: 150 }, effect: "research_boost" },
                           { name: "Construire une Bibliothèque", cost: { wood: 300, marble: 150 }, effect: "knowledge" },
                           { name: "Former des Érudits", cost: { gold: 200 }, effect: "scholars" }
                       ]
                   },
                   construction: {
                       name: "Titus Fabius",
                       title: "Architecte Impérial",
                       advice: "Nos projets de construction avancent selon les plans. Je recommande d'améliorer nos infrastructures.",
                       actions: [
                           { name: "Accélérer la Construction", cost: { wood: 200, gold: 100 }, effect: "build_speed" },
                           { name: "Améliorer les Routes", cost: { marble: 150, gold: 200 }, effect: "infrastructure" },
                           { name: "Former des Artisans", cost: { gold: 150 }, effect: "crafters" }
                       ]
                   },
                   espionage: {
                       name: "Gaius Valerius",
                       title: "Maître Espion",
                       advice: "Mes agents rapportent des mouvements suspects chez nos ennemis. La vigilance est de mise.",
                       actions: [
                           { name: "Recruter des Espions", cost: { gold: 250 }, effect: "spies" },
                           { name: "Infiltrer les Ennemis", cost: { gold: 300 }, effect: "intelligence" },
                           { name: "Renforcer la Sécurité", cost: { gold: 200 }, effect: "security" }
                       ]
                   }
               };

               const advisor = advisorData[advisorType];
               if (!advisor) return;

               const consultationPanel = document.getElementById('advisor-consultation');
               const consultationTitle = document.getElementById('consultation-title');
               const consultationContent = document.getElementById('consultation-content');

               consultationTitle.textContent = `Consultation avec ${advisor.name}`;
               
               let html = `
                   <div style="text-align: center; margin-bottom: 2rem;">
                       <div class="advisor-portrait" style="background-image: url('Romain/${advisor.name.replace(' ', '_')}_asset_pack/portrait.png'); width: 100px; height: 100px; margin: 0 auto 1rem;"></div>
                       <h4 style="color: var(--color-primary); margin-bottom: 0.5rem;">${advisor.name}</h4>
                       <div style="color: var(--color-text-muted); margin-bottom: 1rem;">${advisor.title}</div>
                       <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--color-primary);">
                           "${advisor.advice}"
                       </div>
                   </div>
                   
                   <h4 style="color: var(--color-primary); margin-bottom: 1rem;">Actions Recommandées</h4>
                   <div style="display: flex; flex-direction: column; gap: 1rem;">
               `;

               advisor.actions.forEach((action, index) => {
                   const canAfford = Object.entries(action.cost).every(([resource, amount]) => 
                       gameState.resources[resource] >= amount
                   );
                   
                   const costText = Object.entries(action.cost)
                       .map(([resource, amount]) => `${amount} ${resource}`)
                       .join(', ');

                   html += `
                       <div class="advisor-action" style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--color-border);">
                           <div style="display: flex; justify-content: space-between; align-items: center;">
                               <div>
                                   <div style="font-weight: bold; color: var(--color-text); margin-bottom: 0.25rem;">${action.name}</div>
                                   <div style="color: var(--color-text-muted); font-size: 0.9rem;">Coût: ${costText}</div>
                               </div>
                               <button onclick="executeAdvisorAction('${advisorType}', ${index})" 
                                       class="advisor-btn" 
                                       style="padding: 0.5rem 1rem; font-size: 0.9rem;" 
                                       ${!canAfford ? 'disabled' : ''}>
                                   Exécuter
                               </button>
                           </div>
                       </div>
                   `;
               });

               html += '</div>';
               consultationContent.innerHTML = html;
               consultationPanel.style.display = 'block';
           }

           function closeConsultation() {
               document.getElementById('advisor-consultation').style.display = 'none';
           }

           function executeAdvisorAction(advisorType, actionIndex) {
               const advisorData = {
                   military: { actions: [
                       { name: "Recruter des Légionnaires", cost: { gold: 100 }, effect: "military" },
                       { name: "Améliorer les Fortifications", cost: { marble: 200 }, effect: "defense" },
                       { name: "Organiser des Manœuvres", cost: { gold: 50 }, effect: "training" }
                   ]},
                   economic: { actions: [
                       { name: "Développer le Commerce", cost: { gold: 150 }, effect: "trade" },
                       { name: "Réduire les Taxes", cost: { gold: 100 }, effect: "happiness" },
                       { name: "Construire des Marchés", cost: { wood: 200, gold: 100 }, effect: "economy" }
                   ]},
                   // ... autres conseillers
               };

               const action = advisorData[advisorType]?.actions[actionIndex];
               if (!action) return;

               // Vérifier si le joueur peut se permettre l'action
               const canAfford = Object.entries(action.cost).every(([resource, amount]) => 
                   gameState.resources[resource] >= amount
               );

               if (!canAfford) {
                   logEvent("❌ Ressources insuffisantes pour cette action.");
                   return;
               }

               // Déduire les coûts
               Object.entries(action.cost).forEach(([resource, amount]) => {
                   gameState.resources[resource] -= amount;
               });

               // Appliquer les effets
               switch(action.effect) {
                   case 'military':
                       gameState.military.land.legionary += 10;
                       logEvent("⚔️ 10 légionnaires recrutés !");
                       break;
                   case 'defense':
                       // Augmenter la défense de la ville
                       logEvent("🛡️ Fortifications améliorées !");
                       break;
                   case 'trade':
                       // Bonus de commerce temporaire
                       logEvent("💰 Commerce développé !");
                       break;
                   case 'happiness':
                       // Augmenter le bonheur
                       logEvent("😊 La population est plus heureuse !");
                       break;
                   // ... autres effets
               }

               updateAllUI();
               closeConsultation();
               logEvent(`✅ ${action.name} exécuté avec succès !`);
           }

           function initializeAdvisorsView() {
               // Initialisation de la vue des conseillers si nécessaire
               console.log("Vue des conseillers initialisée");
           }

           // Interface de Ville Enhanced
           function initializeCityEnhancedView() {
               renderBuildingsGridEnhanced();
               updateCityResourcesDisplay();
           }

           function renderBuildingsGridEnhanced() {
               const buildingsGrid = document.getElementById('buildings-grid');
               if (!buildingsGrid) return;

               const buildingAssets = {
                   "Hôtel de Ville": "Batiment/palatium_asset.png",
                   "Caserne": "Batiment/castra_asset.png",
                   "Académie": "Batiment/basilica_asset.png",
                   "Taverne": "Batiment/thermae_asset.png",
                   "Musée": "Batiment/templum_asset.png",
                   "Muraille": "Batiment/muraille_asset.png",
                   "Port": "Batiment/portus_asset.png",
                   "Chantier Naval": "Batiment/navale_asset.png",
                   "Marché": "Batiment/mercatus_asset.png",
                   "Foresterie": "Batiment/silva_asset.png"
               };

               let html = '';
               Object.entries(gameState.buildings).forEach(([buildingName, buildingData]) => {
                   const config = window.config?.buildings[buildingName];
                   if (!config) return;

                   const assetPath = buildingAssets[buildingName] || 'Batiment/default_asset.png';
                   const level = buildingData.level || 0;
                   const isMaxLevel = level >= (config.levels?.length || 1);

                   html += `
                       <div class="building-card-enhanced" onclick="selectBuilding('${buildingName}')" 
                            style="background: var(--color-panel); border-radius: 0.5rem; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--color-border);">
                           <div class="building-image" style="width: 80px; height: 80px; background-image: url('${assetPath}'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto 0.5rem; border-radius: 8px;"></div>
                           <div class="building-name" style="font-weight: bold; color: var(--color-text); margin-bottom: 0.25rem; font-size: 0.9rem;">${buildingName}</div>
                           <div class="building-level" style="color: var(--color-primary); font-size: 0.8rem;">Niv. ${level}</div>
                           ${!isMaxLevel ? `<div class="upgrade-indicator" style="color: var(--color-success); font-size: 0.7rem; margin-top: 0.25rem;">⬆️ Amélioration disponible</div>` : ''}
                       </div>
                   `;
               });

               buildingsGrid.innerHTML = html;
           }

           function updateCityResourcesDisplay() {
               // Mettre à jour l'affichage des ressources dans la sidebar
               Object.entries(gameState.resources).forEach(([resource, amount]) => {
                   const element = document.getElementById(`${resource}-amount`);
                   if (element) {
                       element.textContent = Math.floor(amount).toLocaleString();
                   }
               });

               // Mettre à jour les statistiques de population
               const populationElement = document.getElementById('city-population');
               const happinessElement = document.getElementById('city-happiness');
               
               if (populationElement) {
                   populationElement.textContent = Math.floor(gameState.population || 1000).toLocaleString();
               }
               
               if (happinessElement) {
                   const happiness = Math.floor((gameState.happiness || 75));
                   happinessElement.textContent = `${happiness}%`;
                   happinessElement.className = happiness >= 70 ? 'positive' : happiness >= 50 ? 'neutral' : 'negative';
               }
           }

           function selectBuilding(buildingName) {
               // Logique de sélection de bâtiment
               logEvent(`🏗️ ${buildingName} sélectionné`);
               // Ici on pourrait ouvrir un panneau de détails du bâtiment
           }

           // Fonctions pour les boutons d'action rapide
           function openBuildingView() {
               logEvent("🏗️ Ouverture de la vue construction...");
               // Logique pour ouvrir la vue de construction
           }

           function openMilitaryView() {
               switchView('military');
           }

           function openTradeView() {
               switchView('trade');
           }

           function openResearchView() {
               switchView('research');
           }

           // --- LOGIQUE DE JEU PRINCIPALE ---
           function init() {
               loadState();
               renderAll();
               switchView('city'); // Start on city view
               setInterval(gameLoop, 1000);
               dom.navLinks.forEach(link => {
                   link.addEventListener('click', (e) => {
                       e.preventDefault();
                       switchView(link.dataset.view)
                   });
               });
           }
           
           function renderAll() {
               renderCityLayout();
               renderIslandView();
               renderWorldMap();
               renderResearchTree();
               renderMilitaryUnits();
               renderBattle();
               renderDiplomacy();
               renderAchievements();
               renderQuests();
               renderTrade();
               updateAllUI();
           }

           function gameLoop() {
               try {
                   produceResources(1);
                   processQueues();
                   updateAllUI();
                   checkAchievements();
                   processQuests();
                   checkRandomEvents();
                   
                   // Sauvegarde automatique toutes les 30 secondes
                   if (!gameLoop.lastSave || Date.now() - gameLoop.lastSave > 30000) {
                       saveState();
                       gameLoop.lastSave = Date.now();
                   }
               } catch (error) {
                   console.error('Erreur dans la boucle de jeu:', error);
                   logEvent('⚠️ Erreur détectée, tentative de récupération...');
               }
           }

           function produceResources(seconds) {
               // Production selon les formules exactes du GDD Imperium
               // Production horaire = Base * (1 + 0.1 * (Niveau - 1)) * Bonus île * Bonus alliance
               
               const hourlyProduction = seconds / 3600; // Conversion en production par seconde
               
               // Bonus île (île capitale a +15% selon le defaultGameState)
               const islandBonus = 1.15;
               
               // Bonus alliance (simulé à +10% pour l'exemple)
               const allianceBonus = gameState.alliance ? 1.10 : 1.0;
               
               let production = {
                   wood: 0,
                   stone: 0,
                   iron: 0,
                   wine: 0,
                   gold: 0
               };
               
               // Production des bâtiments selon les formules Imperium
               Object.entries(gameState.buildings).forEach(([buildingId, building]) => {
                   if (!building || building.level === 0 || building.constructing) return;
                   
                   const level = building.level;
                   const baseProduction = 10; // Base : 10 unités/h (niveau 1)
                   const levelMultiplier = 1 + 0.1 * (level - 1);
                   const finalProduction = baseProduction * levelMultiplier * islandBonus * allianceBonus * hourlyProduction;
                   
                   switch(building.type) {
                       case "Camp de Bûcherons":
                           production.wood += finalProduction;
                           break;
                       case "Carrière":
                           production.stone += finalProduction * 0.8; // 8 unités/h de base
                           break;
                       case "Mine de Fer":
                           production.iron += finalProduction * 0.6; // 6 unités/h de base
                           break;
                       case "Vignoble":
                           production.wine += finalProduction * 0.4; // 4 unités/h de base
                           break;
                       case "Forum":
                           // Le Forum génère de l'or selon les recherches
                           if (gameState.research.completed.includes("Monnaie")) {
                               production.gold += level * 2 * hourlyProduction; // +2 or/min par niveau
                           }
                           break;
                   }
               });
               
               // Consommation de vin selon le GDD
               const wineConsumption = gameState.population.wineConsumption * hourlyProduction;
               production.wine -= wineConsumption;
               
               // Calcul du bonheur selon la consommation de vin
               const wineAvailable = gameState.resources.wine + production.wine;
               let happinessFromWine = 0;
               if (wineAvailable >= wineConsumption) {
                   happinessFromWine = Math.floor(wineAvailable / 10) * 2; // +2 bonheur / 10 unités
               }
               
               // Bonus bonheur des tavernes
               const tavernLevel = gameState.buildings.tavern?.level || 0;
               const happinessFromTavern = tavernLevel > 0 ? 5 + (tavernLevel - 1) * 10 : 0; // +5 à +50 selon niveau
               
               // Mise à jour du bonheur total
               gameState.population.happiness = Math.min(100, Math.max(0, 
                   50 + happinessFromWine + happinessFromTavern
               ));
               
               // Malus de productivité si bonheur < 50
               const happinessPenalty = gameState.population.happiness < 50 ? 0.9 : 1.0; // -10% si bonheur bas
               
               // Application du malus de bonheur
               Object.keys(production).forEach(resource => {
                   production[resource] *= happinessPenalty;
               });
               
               // Vérification de la capacité de stockage selon la formule Imperium
               // Capacité = 500 * Niveau_Entrepôt ^ 1.2
               const warehouseLevel = gameState.buildings.warehouse?.level || 1;
               const storageCapacity = 500 * Math.pow(warehouseLevel, 1.2);
               
               // Application de la production avec vérification des limites de stockage
               Object.entries(production).forEach(([resource, amount]) => {
                   const newAmount = gameState.resources[resource] + amount;
                   
                   if (newAmount > storageCapacity && resource !== 'gold') {
                       // Les ressources dépassant la capacité sont perdues (sauf l'or)
                       gameState.resources[resource] = storageCapacity;
                       if (amount > 0 && newAmount - storageCapacity > 0.1) {
                           logEvent(`⚠️ Entrepôt plein ! ${Math.floor(newAmount - storageCapacity)} ${resource} perdus.`);
                       }
                   } else {
                       gameState.resources[resource] = Math.max(0, newAmount);
                   }
               });
               
               // Mise à jour de la population max selon le Forum
               // Population max = 50 + 25 * Niveau_Forum
               const forumLevel = gameState.buildings.forum?.level || 1;
               gameState.population.max = 50 + 25 * forumLevel;
           }

           function processQueues() {
               const now = Date.now();
               let stateChanged = false;
               ['build', 'research', 'military'].forEach(qType => {
                   const finished = [];
                   gameState.queues[qType].forEach((item, index) => {
                       if (now >= item.endTime) {
                           finished.push(index);
                           logEvent(`${item.name} terminé !`);
                           
                           if (qType === 'build') {
                               if (item.level === 1) gameState.buildings[item.id].type = item.name;
                               gameState.buildings[item.id].level = item.level;
                               gameState.playerStats.totalBuildings++;
                               addXP(item.level * 10);
                               checkAchievements();
                           } else if (qType === 'research') {
                               gameState.researchCompleted.push(item.name);
                               addXP(50);
                               checkAchievements();
                           } else if (qType === 'military') {
                               gameState.playerStats.totalUnits += item.count || 1;
                               addXP(item.count * 5);
                               checkAchievements();
                           }
                           stateChanged = true;
                       }
                   });
                   if (finished.length > 0) {
                       gameState.queues[qType] = gameState.queues[qType].filter((_, index) => !finished.includes(index));
                   }
               });
               if (stateChanged) {
                   renderAll();
                   if (selectedPlotId) updateContextPanel(selectedPlotId);
               }
           }
           
          function startAction(type, id, name, level) {
               if (isCooldownActive(type)) { showModal("Action impossible", "Cette action est encore en cooldown."); return; }
               const queue = gameState.queues[type];
               let spec, cost, time;
               if (type === 'build') { spec = config.buildings[name].levels[level - 1]; }
               else if (type === 'research') { const branch = Object.keys(config.research).find(br => config.research[br].techs[name]); spec = config.research[branch].techs[name]; }
               else if (type === 'military') { spec = config.units[name]; }
               cost = spec.cost; time = spec.buildTime || spec.time;
               for(const res in cost) { if (gameState.resources[res] < cost[res]) { showModal("Action impossible", "Ressources insuffisantes."); return; } }
               for(const res in cost) gameState.resources[res] -= cost[res];
               const endTime = Date.now() + time * 1000;
               queue.push({ id, name, level, endTime });
               gameState.cooldowns[type] = Date.now() + ACTION_COOLDOWNS[type] * 1000;
               logEvent(`Lancement: ${name}.`);
               updateAllUI();
               if (selectedPlotId) updateContextPanel(selectedPlotId);
          }

           function startWorldAction(action, coords, name) {
               const [x, y] = coords.split(',').map(Number);
               const spec = config.worldActions[action];
               const cost = spec.cost || {};
               for (const res in cost) { if (gameState.resources[res] < cost[res]) { showModal("Action impossible", "Ressources insuffisantes."); return; } }
               for (const res in cost) gameState.resources[res] -= cost[res];
               if (action === 'explore') {
                   gameState.exploredIslands.push({ x, y });
                   logEvent(`Exploration de [${x},${y}] terminée.`);
               } else if (action === 'colonize') {
                   gameState.colonizedIslands.push({ x, y, type: 'player', name: name || 'Nouvelle Colonie' });
                   if (!gameState.exploredIslands.some(p => p.x === x && p.y === y)) gameState.exploredIslands.push({ x, y });
                   logEvent(`Vous avez colonisé [${x},${y}].`);
               } else if (action === 'attack') {
                   logEvent(`Vous attaquez ${name} [${x},${y}].`);
               }
               updateAllUI();
               renderWorldMap();
               saveState();
           }

           // --- FONCTIONS D'AFFICHAGE ---
           function updateAllUI() { updateResourceUI(); updatePlayerUI(); updateQueueUI(); updateActionAvailability(); }
           function updateResourceUI() { 
               // Mise à jour des ressources Imperium
               const resourceElements = {
                   wood: document.getElementById('resWood'),
                   stone: document.getElementById('resStone'),
                   iron: document.getElementById('resIron'),
                   wine: document.getElementById('resWine'),
                   gold: document.getElementById('resGold')
               };
               
               Object.entries(resourceElements).forEach(([resource, element]) => {
                   if (element && gameState.resources[resource] !== undefined) {
                       element.textContent = Math.floor(gameState.resources[resource]).toLocaleString();
                   }
               });
               
               // Mise à jour des informations de population et bonheur
               const populationElement = document.getElementById('city-population');
               const happinessElement = document.getElementById('city-happiness');
               
               if (populationElement && gameState.population) {
                   populationElement.textContent = `${gameState.population.current}/${gameState.population.max}`;
               }
               
               if (happinessElement && gameState.population) {
                   const happiness = Math.floor(gameState.population.happiness);
                   happinessElement.textContent = `${happiness}%`;
                   happinessElement.className = happiness >= 70 ? 'positive' : happiness >= 50 ? 'neutral' : 'negative';
               }
           }
           
           function updatePlayerUI() {
               const levelEl = document.getElementById('playerLevel');
               const xpEl = document.getElementById('playerXP');
               const xpNeededEl = document.getElementById('playerXPNeeded');
               const achievementEl = document.getElementById('achievementCount');
               
               if (levelEl) levelEl.textContent = gameState.playerStats.level;
               if (xpEl) xpEl.textContent = gameState.playerStats.xp;
               if (xpNeededEl) xpNeededEl.textContent = gameState.playerStats.level * 100;
               if (achievementEl) achievementEl.textContent = gameState.achievements.length;
           }
           
           function renderCityLayout() {
               // Nettoyer la grille existante mais garder les districts et routes
               const existingDistricts = dom.cityGrid.querySelector('.city-districts');
               const existingRoads = dom.cityGrid.querySelector('.city-roads');
               
               // Supprimer seulement les building-plot
               dom.cityGrid.querySelectorAll('.building-plot').forEach(el => el.remove());
               
               // Mettre à jour les indicateurs de districts
               updateDistrictIndicators();
               
               config.cityLayout.forEach(plot => {
                   const el = document.createElement('div'); 
                   el.className = 'building-plot'; 
                   el.dataset.plotId = plot.id;
                   el.style.cssText = `top:${plot.top}; left:${plot.left}; width:${plot.width}; height:${plot.height};`;
                   
                   const building = gameState.buildings[plot.id];
                   if (building && building.type) { 
                       el.classList.add('built');
                       el.innerHTML = `
                           ${config.buildings[building.type].icon}
                           <div class="level">Niv. ${building.level}</div>
                           <div class="building-name">${building.type}</div>
                       `; 
                   } else { 
                       el.innerHTML = '➕'; 
                   }
                   
                   if (gameState.queues.build.some(item => item.id === plot.id)) {
                       el.classList.add('constructing');
                   }
                   
                   el.addEventListener('click', () => {
                       selectedPlotId = plot.id;
                       document.querySelectorAll('.building-plot.selected').forEach(p => p.classList.remove('selected'));
                       el.classList.add('selected');
                       if (window.innerWidth > 900) updateContextPanel(plot.id);
                       else showContextModalForBuilding(plot.id);
                   });
                   
                   dom.cityGrid.appendChild(el);
               });
               
               // Générer les routes entre bâtiments
               generateCityRoads();
           }
           
           function updateDistrictIndicators() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (islandData && islandData.districts) {
                   const districts = islandData.districts;
                   document.getElementById('residential-level').textContent = districts.residential.level;
                   document.getElementById('commercial-level').textContent = districts.commercial.level;
                   document.getElementById('industrial-level').textContent = districts.industrial.level;
                   document.getElementById('cultural-level').textContent = districts.cultural?.level || 1;
                   
                   // Mettre à jour les statistiques détaillées des districts
                   updateDistrictStats(districts);
               }
               
               // Mettre à jour les statistiques vitales de la ville
               updateCityVitalStats();
           }
           
           function updateDistrictStats(districts) {
               // District résidentiel
               const resCapacity = districts.residential.level * 500;
               const resQuality = getQualityLevel(districts.residential.level);
               const resPopBonus = districts.residential.level * 5;
               const resEfficiency = calculateDistrictEfficiency('residential');
               
               document.getElementById('residential-capacity').textContent = resCapacity;
               document.getElementById('residential-quality').textContent = resQuality;
               document.getElementById('residential-population-bonus').textContent = resPopBonus;
               document.getElementById('residential-efficiency').textContent = `${resEfficiency}%`;
               
               // District commercial
               const comShops = districts.commercial.level * 10;
               const comAppeal = getAppealLevel(districts.commercial.level);
               const comGoldBonus = districts.commercial.level * 15;
               const comEfficiency = calculateDistrictEfficiency('commercial');
               
               document.getElementById('commercial-shops').textContent = comShops;
               document.getElementById('commercial-appeal').textContent = comAppeal;
               document.getElementById('commercial-gold-bonus').textContent = comGoldBonus;
               document.getElementById('commercial-efficiency').textContent = `${comEfficiency}%`;
               
               // District industriel
               const indFactories = districts.industrial.level * 3;
               const indPollution = districts.industrial.level * 15;
               const indProdBonus = districts.industrial.level * 10;
               const indEfficiency = calculateDistrictEfficiency('industrial');
               
               document.getElementById('industrial-factories').textContent = indFactories;
               document.getElementById('industrial-pollution').textContent = `+${indPollution}%`;
               document.getElementById('industrial-production-bonus').textContent = indProdBonus;
               document.getElementById('industrial-efficiency').textContent = `${indEfficiency}%`;
               
               // District culturel
               const culMonuments = (districts.cultural?.level || 1) * 2;
               const culInfluence = getInfluenceLevel(districts.cultural?.level || 1);
               const culHappinessBonus = (districts.cultural?.level || 1) * 10;
               const culEfficiency = calculateDistrictEfficiency('cultural');
               
               document.getElementById('cultural-monuments').textContent = culMonuments;
               document.getElementById('cultural-influence').textContent = culInfluence;
               document.getElementById('cultural-happiness-bonus').textContent = culHappinessBonus;
               document.getElementById('cultural-efficiency').textContent = `${culEfficiency}%`;
           }
           
           function updateCityVitalStats() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (!islandData) return;
               
               // Population
               const population = islandData.population || 1000;
               const popGrowth = calculatePopulationGrowth();
               document.getElementById('city-population').textContent = population.toLocaleString();
               document.getElementById('population-growth').textContent = `+${popGrowth}/min`;
               
               // Bonheur
               const happiness = islandData.happiness || 75;
               const happinessTrend = getHappinessTrend(happiness);
               document.getElementById('city-happiness').textContent = `${happiness}%`;
               document.getElementById('happiness-trend').textContent = happinessTrend;
               
               // Efficacité
               const efficiency = calculateCityEfficiency();
               const efficiencyModifier = getEfficiencyModifier();
               document.getElementById('city-efficiency').textContent = `${efficiency}%`;
               document.getElementById('efficiency-modifier').textContent = `+${efficiencyModifier}%`;
               
               // Pollution
               const pollution = calculateCityPollution();
               const pollutionImpact = getPollutionImpact(pollution);
               document.getElementById('city-pollution').textContent = `${pollution}%`;
               document.getElementById('pollution-impact').textContent = pollutionImpact;
               
               // Statistiques détaillées
               updateDetailedCityStats();
           }
           
           function updateDetailedCityStats() {
               const popGrowthRate = (calculatePopulationGrowth() / 10).toFixed(1);
               const taxIncome = calculateTaxIncome();
               const maintenanceCost = calculateMaintenanceCost();
               const netIncome = taxIncome - maintenanceCost;
               
               document.getElementById('population-growth-rate').textContent = `+${popGrowthRate}%/jour`;
               document.getElementById('tax-income').textContent = `+${taxIncome} or/min`;
               document.getElementById('maintenance-cost').textContent = `-${maintenanceCost} or/min`;
               
               const netIncomeEl = document.getElementById('net-income');
               netIncomeEl.textContent = `${netIncome >= 0 ? '+' : ''}${netIncome} or/min`;
               netIncomeEl.className = netIncome >= 0 ? 'positive' : 'negative';
           }
           
           // Fonctions utilitaires pour les calculs
           function getQualityLevel(level) {
               if (level >= 5) return 'Luxueux';
               if (level >= 3) return 'Confortable';
               if (level >= 2) return 'Correct';
               return 'Basique';
           }
           
           function getAppealLevel(level) {
               if (level >= 5) return 'Exceptionnelle';
               if (level >= 3) return 'Élevée';
               if (level >= 2) return 'Bonne';
               return 'Moyenne';
           }
           
           function getInfluenceLevel(level) {
               if (level >= 5) return 'Mondiale';
               if (level >= 3) return 'Régionale';
               if (level >= 2) return 'Insulaire';
               return 'Locale';
           }
           
           function calculateDistrictEfficiency(districtType) {
               const baseEfficiency = 100;
               const pollution = calculateCityPollution();
               const happiness = gameState.islandDetails[`${gameState.currentIsland.x}-${gameState.currentIsland.y}`]?.happiness || 75;
               
               let efficiency = baseEfficiency;
               
               // La pollution affecte l'efficacité
               efficiency -= Math.floor(pollution / 5);
               
               // Le bonheur affecte l'efficacité
               if (happiness < 50) efficiency -= (50 - happiness);
               else if (happiness > 80) efficiency += Math.floor((happiness - 80) / 2);
               
               // Bonus spécifiques par district
               switch (districtType) {
                   case 'industrial':
                       // L'industrie est moins affectée par la pollution
                       efficiency += Math.floor(pollution / 10);
                       break;
                   case 'cultural':
                       // La culture bénéficie du bonheur
                       efficiency += Math.floor((happiness - 50) / 5);
                       break;
               }
               
               return Math.max(50, Math.min(150, efficiency));
           }
           
           function calculatePopulationGrowth() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (!islandData) return 5;
               
               const districts = islandData.districts;
               const baseGrowth = districts.residential.level * 5;
               const happinessBonus = Math.floor((islandData.happiness - 50) / 10);
               
               return Math.max(1, baseGrowth + happinessBonus);
           }
           
           function calculateCityEfficiency() {
               const happiness = gameState.islandDetails[`${gameState.currentIsland.x}-${gameState.currentIsland.y}`]?.happiness || 75;
               const pollution = calculateCityPollution();
               
               let efficiency = 85; // Base
               efficiency += Math.floor((happiness - 50) / 5);
               efficiency -= Math.floor(pollution / 3);
               
               return Math.max(30, Math.min(120, efficiency));
           }
           
           function calculateCityPollution() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (!islandData) return 25;
               
               const districts = islandData.districts;
               const industrialPollution = districts.industrial.level * 15;
               const basePollution = 10;
               
               return Math.min(100, basePollution + industrialPollution);
           }
           
           function getHappinessTrend(happiness) {
               if (happiness >= 80) return 'En hausse';
               if (happiness >= 60) return 'Stable';
               if (happiness >= 40) return 'En baisse';
               return 'Critique';
           }
           
           function getEfficiencyModifier() {
               const weather = getCurrentWeather();
               switch (weather) {
                   case 'sunny': return 10;
                   case 'rainy': return 5;
                   case 'stormy': return -5;
                   default: return 0;
               }
           }
           
           function getPollutionImpact(pollution) {
               if (pollution >= 70) return 'Critique';
               if (pollution >= 50) return 'Élevé';
               if (pollution >= 30) return 'Modéré';
               return 'Faible';
           }
           
           function calculateTaxIncome() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (!islandData) return 45;
               
               const districts = islandData.districts;
               const commercialIncome = districts.commercial.level * 15;
               const populationTax = Math.floor(islandData.population / 100);
               
               return commercialIncome + populationTax;
           }
           
           function calculateMaintenanceCost() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (!islandData) return 20;
               
               const districts = islandData.districts;
               const totalLevels = districts.residential.level + districts.commercial.level + 
                                 districts.industrial.level + (districts.cultural?.level || 1);
               
               return totalLevels * 5;
           }
           
           function getCurrentWeather() {
               const weathers = ['sunny', 'cloudy', 'rainy', 'stormy'];
               const hour = new Date().getHours();
               return weathers[hour % weathers.length];
           }
           
           // Nouvelles fonctions d'interaction pour la ville
           function focusDistrict(districtType) {
               // Mettre en évidence le district sélectionné
               document.querySelectorAll('.district-card').forEach(card => {
                   card.classList.remove('focused');
               });
               document.querySelector(`.district-card.${districtType}`).classList.add('focused');
               
               // Afficher les détails du district dans le panneau
               showDistrictDetails(districtType);
           }
           
           function showDistrictDetails(districtType) {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               const districts = islandData?.districts;
               
               if (!districts) return;
               
               const district = districts[districtType] || { level: 1 };
               const detailsTitle = document.getElementById('details-title');
               const detailsContent = document.getElementById('details-content');
               
               const districtInfo = getDistrictInfo(districtType);
               
               detailsTitle.textContent = `${districtInfo.icon} District ${districtInfo.name}`;
               
               detailsContent.innerHTML = `
                   <div class="district-details">
                       <div class="district-overview">
                           <h4>📊 Aperçu du District</h4>
                           <div class="overview-stats">
                               <div class="overview-stat">
                                   <span>Niveau actuel:</span>
                                   <span class="level-badge">${district.level}</span>
                               </div>
                               <div class="overview-stat">
                                   <span>Efficacité:</span>
                                   <span class="efficiency-badge">${calculateDistrictEfficiency(districtType)}%</span>
                               </div>
                               <div class="overview-stat">
                                   <span>Contribution:</span>
                                   <span class="contribution-badge">${getDistrictContribution(districtType, district.level)}</span>
                               </div>
                           </div>
                       </div>
                       
                       <div class="district-upgrade">
                           <h4>⬆️ Amélioration</h4>
                           <div class="upgrade-info">
                               <div class="next-level">Niveau ${district.level + 1}</div>
                               <div class="upgrade-cost">
                                   ${getUpgradeCost(districtType, district.level)}
                               </div>
                               <div class="upgrade-benefits">
                                   <strong>Nouveaux avantages:</strong>
                                   <ul>
                                       ${getUpgradeBenefits(districtType, district.level).map(benefit => `<li>${benefit}</li>`).join('')}
                                   </ul>
                               </div>
                               <button class="upgrade-btn" onclick="upgradeDistrict('${districtType}')" 
                                       ${canAffordUpgrade(districtType, district.level) ? '' : 'disabled'}>
                                   🔨 Améliorer le District
                               </button>
                           </div>
                       </div>
                       
                       <div class="district-policies">
                           <h4>📋 Politiques du District</h4>
                           <div class="policy-options">
                               ${getDistrictPolicies(districtType).map(policy => `
                                   <div class="policy-option ${policy.active ? 'active' : ''}" 
                                        onclick="toggleDistrictPolicy('${districtType}', '${policy.id}')">
                                       <div class="policy-name">${policy.name}</div>
                                       <div class="policy-effect">${policy.effect}</div>
                                       <div class="policy-cost">${policy.cost}</div>
                                   </div>
                               `).join('')}
                           </div>
                       </div>
                   </div>
               `;
           }
           
           function getDistrictInfo(districtType) {
               const info = {
                   residential: { icon: '🏠', name: 'Résidentiel' },
                   commercial: { icon: '🏪', name: 'Commercial' },
                   industrial: { icon: '🏭', name: 'Industriel' },
                   cultural: { icon: '🎭', name: 'Culturel' }
               };
               return info[districtType];
           }
           
           function getDistrictContribution(districtType, level) {
               switch (districtType) {
                   case 'residential': return `+${level * 5} pop/min`;
                   case 'commercial': return `+${level * 15} or/min`;
                   case 'industrial': return `+${level * 10} prod/min`;
                   case 'cultural': return `+${level * 10}% bonheur`;
                   default: return 'N/A';
               }
           }
           
           function getUpgradeCost(districtType, currentLevel) {
               const baseCosts = {
                   residential: { gold: 500, wood: 200, marble: 100 },
                   commercial: { gold: 800, wood: 150, marble: 200 },
                   industrial: { gold: 1000, wood: 300, sulfur: 150 },
                   cultural: { gold: 1200, marble: 300, wine: 100 }
               };
               
               const cost = baseCosts[districtType];
               const multiplier = currentLevel + 1;
               
               return Object.entries(cost)
                   .map(([resource, amount]) => `${amount * multiplier} ${resource}`)
                   .join(', ');
           }
           
           function getUpgradeBenefits(districtType, currentLevel) {
               const benefits = {
                   residential: [
                       `+500 capacité de logement`,
                       `+5 croissance de population/min`,
                       `Amélioration de la qualité de vie`
                   ],
                   commercial: [
                       `+10 boutiques`,
                       `+15 revenus d'or/min`,
                       `Augmentation de l'attractivité commerciale`
                   ],
                   industrial: [
                       `+3 usines`,
                       `+10 production/min`,
                       `Nouvelles technologies disponibles`
                   ],
                   cultural: [
                       `+2 monuments`,
                       `+10% bonheur de la population`,
                       `Extension de l'influence culturelle`
                   ]
               };
               
               return benefits[districtType] || [];
           }
           
           function getDistrictPolicies(districtType) {
               const policies = {
                   residential: [
                       { id: 'luxury_housing', name: 'Logements de Luxe', effect: '+20% bonheur, -10% croissance', cost: '50 or/min', active: false },
                       { id: 'social_programs', name: 'Programmes Sociaux', effect: '+15% croissance, -30 or/min', cost: '30 or/min', active: false }
                   ],
                   commercial: [
                       { id: 'tax_incentives', name: 'Incitations Fiscales', effect: '+25% revenus, -20% bonheur', cost: '20 or/min', active: false },
                       { id: 'market_regulation', name: 'Régulation du Marché', effect: '+10% bonheur, -15% revenus', cost: '15 or/min', active: false }
                   ],
                   industrial: [
                       { id: 'overtime_work', name: 'Heures Supplémentaires', effect: '+30% production, -15% bonheur', cost: '25 or/min', active: false },
                       { id: 'green_technology', name: 'Technologies Vertes', effect: '-50% pollution, -20% production', cost: '40 or/min', active: false }
                   ],
                   cultural: [
                       { id: 'festivals', name: 'Festivals Culturels', effect: '+20% bonheur, +10% tourisme', cost: '35 or/min', active: false },
                       { id: 'education_focus', name: 'Focus Éducation', effect: '+15% efficacité globale', cost: '30 or/min', active: false }
                   ]
               };
               
               return policies[districtType] || [];
           }
           
           function canAffordUpgrade(districtType, currentLevel) {
               const baseCosts = {
                   residential: { gold: 500, wood: 200, marble: 100 },
                   commercial: { gold: 800, wood: 150, marble: 200 },
                   industrial: { gold: 1000, wood: 300, sulfur: 150 },
                   cultural: { gold: 1200, marble: 300, wine: 100 }
               };
               
               const cost = baseCosts[districtType];
               const multiplier = currentLevel + 1;
               
               return Object.entries(cost).every(([resource, amount]) => 
                   gameState.resources[resource] >= (amount * multiplier)
               );
           }
           
           function upgradeDistrict(districtType) {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               
               if (!islandData || !islandData.districts) return;
               
               const district = islandData.districts[districtType];
               const currentLevel = district.level;
               
               if (!canAffordUpgrade(districtType, currentLevel)) {
                   showModal('Amélioration impossible', 'Ressources insuffisantes pour cette amélioration.');
                   return;
               }
               
               // Déduire les ressources
               const baseCosts = {
                   residential: { gold: 500, wood: 200, marble: 100 },
                   commercial: { gold: 800, wood: 150, marble: 200 },
                   industrial: { gold: 1000, wood: 300, sulfur: 150 },
                   cultural: { gold: 1200, marble: 300, wine: 100 }
               };
               
               const cost = baseCosts[districtType];
               const multiplier = currentLevel + 1;
               
               Object.entries(cost).forEach(([resource, amount]) => {
                   gameState.resources[resource] -= amount * multiplier;
               });
               
               // Améliorer le district
               district.level++;
               
               // Effets de l'amélioration
               switch (districtType) {
                   case 'residential':
                       islandData.population += 200;
                       break;
                   case 'commercial':
                       // Augmentation des revenus (géré automatiquement)
                       break;
                   case 'industrial':
                       // Augmentation de la pollution
                       break;
                   case 'cultural':
                       islandData.happiness = Math.min(100, islandData.happiness + 5);
                       break;
               }
               
               logEvent(`🏗️ District ${getDistrictInfo(districtType).name} amélioré au niveau ${district.level}`);
               addXP(50);
               
               // Mettre à jour l'affichage
               updateDistrictIndicators();
               showDistrictDetails(districtType);
               updateAllUI();
               saveState();
           }
           
           function toggleDistrictPolicy(districtType, policyId) {
               // Implémentation des politiques de district
               showModal('Politique', 'Système de politiques en développement. Cette fonctionnalité sera bientôt disponible !');
           }
           
           function openCityPolicies() {
               showModal('Politiques Urbaines', `
                   <div class="city-policies">
                       <h4>🏛️ Politiques Générales</h4>
                       <div class="policy-grid">
                           <div class="policy-card" onclick="toggleCityPolicy('taxation')">
                               <h5>💰 Politique Fiscale</h5>
                               <p>Ajuster les taux d'imposition</p>
                               <div class="policy-status">Taux normal (15%)</div>
                           </div>
                           <div class="policy-card" onclick="toggleCityPolicy('environment')">
                               <h5>🌱 Politique Environnementale</h5>
                               <p>Réguler la pollution industrielle</p>
                               <div class="policy-status">Réglementation standard</div>
                           </div>
                           <div class="policy-card" onclick="toggleCityPolicy('security')">
                               <h5>🛡️ Sécurité Publique</h5>
                               <p>Maintenir l'ordre dans la ville</p>
                               <div class="policy-status">Patrouilles normales</div>
                           </div>
                           <div class="policy-card" onclick="toggleCityPolicy('education')">
                               <h5>📚 Éducation</h5>
                               <p>Investir dans l'éducation publique</p>
                               <div class="policy-status">Financement de base</div>
                           </div>
                       </div>
                   </div>
               `);
           }
           
           function openInfrastructure() {
               showModal('Infrastructure', `
                   <div class="infrastructure-panel">
                       <h4>🛤️ Projets d'Infrastructure</h4>
                       <div class="infrastructure-projects">
                           <div class="project-card">
                               <h5>🚇 Système de Transport</h5>
                               <p>Améliore l'efficacité de tous les districts</p>
                               <div class="project-cost">Coût: 2000 or, 500 bois, 300 marbre</div>
                               <button class="project-btn" onclick="startInfrastructureProject('transport')">Construire</button>
                           </div>
                           <div class="project-card">
                               <h5>💧 Système d'Eau</h5>
                               <p>Réduit la pollution et augmente le bonheur</p>
                               <div class="project-cost">Coût: 1500 or, 400 marbre</div>
                               <button class="project-btn" onclick="startInfrastructureProject('water')">Construire</button>
                           </div>
                           <div class="project-card">
                               <h5>⚡ Réseau Électrique</h5>
                               <p>Booste la production industrielle</p>
                               <div class="project-cost">Coût: 2500 or, 600 bois, 200 soufre</div>
                               <button class="project-btn" onclick="startInfrastructureProject('electricity')">Construire</button>
                           </div>
                       </div>
                   </div>
               `);
           }
           
           function openCityEvents() {
               const recentEvents = gameState.eventHistory.slice(-5).reverse();
               const eventsHtml = recentEvents.length > 0 
                   ? recentEvents.map(event => `
                       <div class="event-item">
                           <div class="event-title">${event.title}</div>
                           <div class="event-description">${event.description}</div>
                           <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
                       </div>
                   `).join('')
                   : '<p>Aucun événement récent dans la ville.</p>';
               
               showModal('Événements Locaux', `
                   <div class="city-events">
                       <h4>📰 Événements Récents</h4>
                       <div class="events-list">
                           ${eventsHtml}
                       </div>
                       <button class="action-btn" onclick="generateCityEvent()">
                           🎲 Générer un Événement
                       </button>
                   </div>
               `);
           }
           
           function closeCityDetails() {
               document.getElementById('details-title').textContent = 'Aperçu de la Ville';
               document.getElementById('details-content').innerHTML = `
                   <div class="city-overview">
                       <h4>🏛️ Gestion Urbaine</h4>
                       <div class="management-actions">
                           <button class="management-btn" onclick="openCityPolicies()">
                               📋 Politiques Urbaines
                           </button>
                           <button class="management-btn" onclick="openInfrastructure()">
                               🛤️ Infrastructure
                           </button>
                           <button class="management-btn" onclick="openCityEvents()">
                               📰 Événements Locaux
                           </button>
                       </div>
                       
                       <h4>📊 Statistiques Détaillées</h4>
                       <div class="detailed-stats">
                           <div class="stat-row">
                               <span>Croissance démographique:</span>
                               <span id="population-growth-rate">+2.5%/jour</span>
                           </div>
                           <div class="stat-row">
                               <span>Revenus fiscaux:</span>
                               <span id="tax-income">+45 or/min</span>
                           </div>
                           <div class="stat-row">
                               <span>Coûts d'entretien:</span>
                               <span id="maintenance-cost">-20 or/min</span>
                           </div>
                           <div class="stat-row">
                               <span>Bilan net:</span>
                               <span id="net-income" class="positive">+25 or/min</span>
                           </div>
                       </div>
                   </div>
               `;
               
               // Retirer le focus des districts
               document.querySelectorAll('.district-card').forEach(card => {
                   card.classList.remove('focused');
               });
           }
           
           function generateCityRoads() {
               const roadsContainer = document.getElementById('city-roads');
               if (!roadsContainer) return;
               
               roadsContainer.innerHTML = '';
               
               // Créer des routes entre l'hôtel de ville et les autres bâtiments
               const townHall = config.cityLayout.find(plot => plot.id === 'townHall');
               if (!townHall) return;
               
               config.cityLayout.forEach(plot => {
                   if (plot.id !== 'townHall' && gameState.buildings[plot.id]?.type) {
                       const road = document.createElement('div');
                       road.className = 'road-connection';
                       
                       // Calculer la position et l'angle de la route
                       const x1 = parseFloat(townHall.left) + parseFloat(townHall.width) / 2;
                       const y1 = parseFloat(townHall.top) + parseFloat(townHall.height) / 2;
                       const x2 = parseFloat(plot.left) + parseFloat(plot.width) / 2;
                       const y2 = parseFloat(plot.top) + parseFloat(plot.height) / 2;
                       
                       const distance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                       const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                       
                       road.style.cssText = `
                           left: ${x1}%; top: ${y1}%;
                           width: ${distance}px; 
                           transform: rotate(${angle}deg);
                           transform-origin: 0 50%;
                       `;
                       
                       roadsContainer.appendChild(road);
                   }
               });
           }

         function renderWorldMap() {
             // Mettre à jour les statistiques mondiales
             updateWorldStats();
             
             // Mettre à jour le système météorologique
             updateWeatherSystem();
             
             // Nettoyer et reconstruire la grille du monde
             dom.worldMapGrid.innerHTML = '';
             
             // Générer la carte du monde 20x20 avec océans et îles
             for (let y = 0; y < 20; y++) {
                 for (let x = 0; x < 20; x++) {
                     const tile = document.createElement('div');
                     tile.className = 'world-tile';
                     tile.dataset.x = x;
                     tile.dataset.y = y;
                     
                     const island = getIslandAtPosition(x, y);
                     const isExplored = gameState.exploredIslands.some(exp => exp.x === x && exp.y === y);
                     const isColonized = gameState.colonizedIslands.some(col => col.x === x && col.y === y);
                     const hasTradeRoute = gameState.tradeRoutes.some(route => 
                         (route.from.x === x && route.from.y === y) || (route.to.x === x && route.to.y === y)
                     );
                     
                     // Déterminer le type de tuile
                     if (!island) {
                         tile.classList.add('ocean');
                         tile.innerHTML = '🌊';
                         tile.title = `Océan [${x},${y}]`;
                     } else {
                         if (isColonized || (x === 10 && y === 10)) { // Position de départ du joueur
                             tile.classList.add('player');
                             tile.innerHTML = '🏛️';
                             tile.title = `${island.name} - Votre colonie`;
                         } else if (island.type === 'ally') {
                             tile.classList.add('ally');
                             tile.innerHTML = '🤝';
                             tile.title = `${island.name} - Allié`;
                         } else if (island.type === 'enemy') {
                             tile.classList.add('enemy');
                             tile.innerHTML = '⚔️';
                             tile.title = `${island.name} - Ennemi`;
                         } else if (isExplored) {
                             tile.classList.add('island');
                             tile.innerHTML = '🏝️';
                             tile.title = `${island.name} - Île explorée`;
                         } else {
                             tile.classList.add('unexplored');
                             tile.innerHTML = '❓';
                             tile.title = `Zone inexplorée [${x},${y}]`;
                         }
                     }
                     
                     // Marquer les routes commerciales
                     if (hasTradeRoute) {
                         tile.classList.add('trade-route');
                     }
                     
                     // Ajouter les événements de clic
                     tile.addEventListener('click', () => handleWorldTileClick(x, y, island, isExplored));
                     
                     dom.worldMapGrid.appendChild(tile);
                 }
             }
             
             // Mettre à jour les détails du monde
             updateWorldDetails();
         }
         
         function updateWorldStats() {
             const islandsEl = document.getElementById('world-islands-count');
             const routesEl = document.getElementById('world-routes-count');
             const influenceEl = document.getElementById('world-influence');
             
             if (islandsEl) islandsEl.textContent = gameState.exploredIslands.length;
             if (routesEl) routesEl.textContent = gameState.tradeRoutes.length;
             if (influenceEl) influenceEl.textContent = gameState.diplomacy.reputation || 50;
         }
         
         function updateWeatherSystem() {
             const weatherEl = document.getElementById('weather-display');
             if (!weatherEl) return;
             
             const weathers = [
                 { icon: '☀️', name: 'Temps clair', effect: 'Production +10%' },
                 { icon: '⛅', name: 'Nuageux', effect: 'Normal' },
                 { icon: '🌧️', name: 'Pluie', effect: 'Agriculture +15%' },
                 { icon: '⛈️', name: 'Orage', effect: 'Commerce -20%' },
                 { icon: '🌪️', name: 'Tempête', effect: 'Navigation impossible' },
                 { icon: '❄️', name: 'Neige', effect: 'Consommation +25%' }
             ];
             
             // Changer le temps toutes les 5 minutes
             const currentTime = Math.floor(Date.now() / (5 * 60 * 1000));
             const weatherIndex = currentTime % weathers.length;
             const currentWeather = weathers[weatherIndex];
             
             weatherEl.innerHTML = `${currentWeather.icon} ${currentWeather.name}`;
             weatherEl.title = currentWeather.effect;
         }
         
         function updateWorldDetails() {
             const eventsEl = document.getElementById('world-events-list');
             const diplomacyEl = document.getElementById('diplomacy-status');
             const tradesEl = document.getElementById('trade-routes-list');
             
             // Événements mondiaux récents
             if (eventsEl) {
                 const recentEvents = gameState.worldEvents.slice(-3);
                 if (recentEvents.length > 0) {
                     eventsEl.innerHTML = recentEvents.map(event => 
                         `<div style="margin-bottom: 0.5rem; padding: 0.25rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">
                             <strong>${event.title}</strong><br>
                             <small>${event.description}</small>
                         </div>`
                     ).join('');
                 } else {
                     eventsEl.textContent = 'Aucun événement récent';
                 }
             }
             
             // Statut diplomatique
             if (diplomacyEl) {
                 const reputation = gameState.diplomacy.reputation || 50;
                 let status = 'Neutre';
                 if (reputation >= 80) status = 'Excellent';
                 else if (reputation >= 60) status = 'Bon';
                 else if (reputation >= 40) status = 'Moyen';
                 else if (reputation >= 20) status = 'Mauvais';
                 else status = 'Hostile';
                 
                 diplomacyEl.innerHTML = `
                     <div>Réputation: ${reputation}/100</div>
                     <div>Statut: ${status}</div>
                 `;
             }
             
             // Routes commerciales
             if (tradesEl) {
                 if (gameState.tradeRoutes.length > 0) {
                     tradesEl.innerHTML = gameState.tradeRoutes.map((route, index) => 
                         `<div style="margin-bottom: 0.5rem; padding: 0.25rem; background: rgba(255,255,255,0.1); border-radius: 0.25rem;">
                             <strong>${route.from.name} ↔ ${route.to.name}</strong><br>
                             <small>Distance: ${route.distance} | Biens: ${route.goods.join(', ')}</small>
                             <button onclick="cancelTradeRoute(${index})" style="float: right; background: var(--color-danger); border: none; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">❌</button>
                         </div>`
                     ).join('');
                 } else {
                     tradesEl.textContent = 'Aucune route active';
                 }
             }
         }
         
         // Nouvelles fonctions pour les améliorations de l'île
         function developIsland() {
             const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
             const islandData = gameState.islandDetails[currentIslandKey];
             
             if (!islandData) return;
             
             const cost = {
                 gold: islandData.development * 1000,
                 wood: islandData.development * 500,
                 marble: islandData.development * 200
             };
             
             // Vérifier si le joueur a assez de ressources
             for (const res in cost) {
                 if (gameState.resources[res] < cost[res]) {
                     showModal("Développement impossible", `Ressources insuffisantes. Coût: ${Object.entries(cost).map(([r, c]) => `${c} ${r}`).join(', ')}`);
                     return;
                 }
             }
             
             // Déduire les ressources
             for (const res in cost) {
                 gameState.resources[res] -= cost[res];
             }
             
             // Améliorer l'île
             islandData.development++;
             islandData.population += 200;
             islandData.happiness = Math.min(100, islandData.happiness + 5);
             
             // Améliorer les districts
             Object.values(islandData.districts).forEach(district => {
                 if (Math.random() < 0.5) {
                     district.level++;
                 }
             });
             
             logEvent(`🏗️ ${islandData.name} développée au niveau ${islandData.development}`);
             addXP(100);
             
             renderIslandView();
             updateAllUI();
             saveState();
         }
         
         function exploreIsland() {
             const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
             const islandData = gameState.islandDetails[currentIslandKey];
             
             if (!islandData) return;
             
             const cost = { gold: 200, wood: 100 };
             
             // Vérifier si le joueur a assez de ressources
             for (const res in cost) {
                 if (gameState.resources[res] < cost[res]) {
                     showModal("Exploration impossible", "Ressources insuffisantes pour l'exploration.");
                     return;
                 }
             }
             
             // Déduire les ressources
             for (const res in cost) {
                 gameState.resources[res] -= cost[res];
             }
             
             // Découvrir de nouvelles ressources ou caractéristiques
             const discoveries = [
                 { type: 'resource', name: 'Gisement de fer', bonus: 'iron' },
                 { type: 'resource', name: 'Source d\'eau pure', bonus: 'happiness' },
                 { type: 'terrain', name: 'Terres fertiles', bonus: 'agriculture' },
                 { type: 'wonder', name: 'Ruines antiques', bonus: 'culture' },
                 { type: 'danger', name: 'Créatures sauvages', bonus: 'military' }
             ];
             
             const discovery = discoveries[Math.floor(Math.random() * discoveries.length)];
             
             // Ajouter la découverte aux ressources naturelles
             if (!islandData.naturalResources.includes(discovery.name)) {
                 islandData.naturalResources.push(discovery.name);
             }
             
             // Appliquer les bonus
             switch (discovery.bonus) {
                 case 'happiness':
                     islandData.happiness = Math.min(100, islandData.happiness + 10);
                     break;
                 case 'iron':
                     gameState.resources.sulfur = (gameState.resources.sulfur || 0) + 50;
                     break;
                 case 'agriculture':
                     gameState.resources.wine = (gameState.resources.wine || 0) + 30;
                     break;
             }
             
             logEvent(`🔍 Découverte sur ${islandData.name}: ${discovery.name}`);
             addXP(50);
             
             renderIslandView();
             updateAllUI();
             saveState();
         }
         
         function showBuildingOptions(x, y, terrain) {
             const buildings = [
                 { name: 'Avant-poste', icon: '🏕️', cost: { wood: 200, gold: 100 }, description: 'Étend votre influence' },
                 { name: 'Mine', icon: '⛏️', cost: { wood: 300, gold: 200 }, description: 'Extrait des minerais' },
                 { name: 'Ferme', icon: '🚜', cost: { wood: 250, gold: 150 }, description: 'Produit de la nourriture' },
                 { name: 'Tour de Guet', icon: '🗼', cost: { wood: 400, gold: 300 }, description: 'Surveille les environs' }
             ];
             
             let html = `
                 <h4>Construire sur [${x},${y}]</h4>
                 <p>Terrain: ${terrain.name}</p>
                 <div class="build-select-grid">
             `;
             
             buildings.forEach(building => {
                 const canAfford = Object.entries(building.cost).every(([res, cost]) => gameState.resources[res] >= cost);
                 html += `
                     <div class="build-option ${canAfford ? '' : 'disabled'}" onclick="${canAfford ? `buildOnIsland(${x}, ${y}, '${building.name}')` : ''}">
                         <div>${building.icon}</div>
                         <div>${building.name}</div>
                         <div class="cost">${Object.entries(building.cost).map(([r, c]) => `${c} ${r}`).join(', ')}</div>
                     </div>
                 `;
             });
             
             html += '</div>';
             showModal('Construction', html);
         }
         
         function buildOnIsland(x, y, buildingName) {
             const buildings = {
                 'Avant-poste': { icon: '🏕️', cost: { wood: 200, gold: 100 }, effect: 'influence' },
                 'Mine': { icon: '⛏️', cost: { wood: 300, gold: 200 }, effect: 'mining' },
                 'Ferme': { icon: '🚜', cost: { wood: 250, gold: 150 }, effect: 'food' },
                 'Tour de Guet': { icon: '🗼', cost: { wood: 400, gold: 300 }, effect: 'defense' }
             };
             
             const building = buildings[buildingName];
             if (!building) return;
             
             // Déduire les ressources
             Object.entries(building.cost).forEach(([res, cost]) => {
                 gameState.resources[res] -= cost;
             });
             
             // Ajouter le bâtiment aux données de l'île
             const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
             const islandData = gameState.islandDetails[currentIslandKey];
             
             if (!islandData.specialBuildings) {
                 islandData.specialBuildings = [];
             }
             
             islandData.specialBuildings.push({
                 x: x,
                 y: y,
                 name: buildingName,
                 icon: building.icon,
                 effect: building.effect
             });
             
             logEvent(`🏗️ ${buildingName} construite sur [${x},${y}]`);
             addXP(25);
             gameState.playerStats.totalBuildings++;
             
             dom.modal.style.display = 'none';
             renderIslandView();
             updateAllUI();
             saveState();
         }
           }

           function handleWorldTileClick(x, y, island, explored) {
              if (!explored) {
                  showModal('explore', `${x},${y}`, `Case [${x},${y}]`);
                  return;
              }
              if (!island) {
                  showModal('Océan', `Emplacement [${x},${y}]`);
                  return;
              }
              if (island.type === 'enemy') {
                  showModal('attack', `${x},${y}`, island.name);
              } else if (island.type === 'island') {
                  showModal('colonize', `${x},${y}`, island.name);
              } else {
                  showModal(island.name, `Type: ${island.type}`);
              }
           }
           
           function renderIslandView() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey] || createDefaultIslandData(gameState.currentIsland);
               
               // Mettre à jour les informations de l'île dans l'en-tête
               updateIslandHeader(islandData);
               
               // Nettoyer et reconstruire la grille de l'île
               dom.islandGrid.innerHTML = '';
               
               // Générer la carte de l'île 9x9 avec différents terrains
               for (let y = 0; y < 9; y++) {
                   for (let x = 0; x < 9; x++) {
                       const tile = document.createElement('div');
                       tile.className = 'island-tile';
                       tile.dataset.x = x;
                       tile.dataset.y = y;
                       
                       const terrain = getTerrainForTile(x, y, islandData);
                       const building = getBuildingOnTile(x, y, islandData);
                       const resource = getResourceOnTile(x, y, islandData);
                       
                       // Appliquer le type de terrain
                       tile.classList.add(terrain.type);
                       
                       // Ajouter le contenu de la tuile
                       if (building) {
                           tile.classList.add(building.type);
                           tile.innerHTM