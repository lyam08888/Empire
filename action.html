<!DOCTYPE html>
<html lang="fr">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Empire - Jeu Complet Simul√©</title>
   <meta name="description" content="Prototype complet et persistant du jeu de strat√©gie Empire, simulant une architecture multi-√©crans avec une interface mobile.">
   <meta name="author" content="Empire Game Studio">
   <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%231e3a8a'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='Arial' font-size='18' font-weight='bold'>E</text></svg>" type="image/svg+xml">

   <style>
       :root {
           --color-primary: #fbbf24; /* Or */
           --color-secondary: #3b82f6; /* Bleu */
           --color-danger: #ef4444; /* Rouge */
           --color-success: #22c55e; /* Vert */
           --color-dark-1: #0a192f; /* Fond principal */
           --color-dark-2: #1e3a8a; /* D√©grad√© fond */
           --color-panel: rgba(15, 23, 42, 0.8); /* Panneaux */
           --color-panel-light: rgba(30, 41, 59, 0.8);
           --color-text: #e2e8f0;
           --color-text-muted: #94a3b8;
           --color-border: rgba(148, 163, 184, 0.2);
       }

       /* Styles de base et reset */
       * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
       html, body { height: 100%; }
       body {
           font-family: 'Arial', sans-serif;
           background: linear-gradient(135deg, var(--color-dark-1), var(--color-dark-2));
           color: var(--color-text);
           overflow: hidden;
       }
       .hidden { display: none !important; }

       /* --- LAYOUT GLOBAL --- */
       .game-ui { display: flex; flex-direction: column; height: 100%; }
       .game-header, .game-footer { flex-shrink: 0; z-index: 100; }
       .game-body { display: flex; flex-grow: 1; overflow: hidden; padding: 1rem; gap: 1rem; }

       /* --- HEADER --- */
       .game-header { padding: 0.5rem 1rem; background: var(--color-panel); backdrop-filter: blur(5px); border-bottom: 1px solid var(--color-border); }
       .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1600px; margin: 0 auto; }
       .resources { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; background: var(--color-panel-light); padding: 0.5rem 1rem; border-radius: 0.5rem; }
       .resource-item { display: flex; align-items: center; gap: 0.5rem; font-weight: bold; }
       .resource-item span { color: var(--color-primary); min-width: 40px; }
       .player-info a { color: var(--color-text-muted); text-decoration: none; transition: color 0.3s; }
       .player-info a:hover { color: var(--color-primary); }

       /* --- BARRE DE NAVIGATION GAUCHE (Desktop) --- */
       .left-sidebar { width: 200px; flex-shrink: 0; background: var(--color-panel); padding: 1rem; border-radius: 1rem; overflow-y: auto; }
       .main-nav ul { list-style: none; }
       .main-nav li a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; margin-bottom: 0.5rem; color: var(--color-text); text-decoration: none; border-radius: 0.5rem; transition: all 0.3s; cursor: pointer; }
       .main-nav li a:hover, .main-nav li a.active { background: rgba(251, 191, 36, 0.1); color: var(--color-primary); transform: translateX(5px); }
       .main-nav li a span { display: inline; }

       /* --- VUE CENTRALE (Conteneur) --- */
       .main-view-container { flex-grow: 1; position: relative; }
       .main-view {
           position: absolute; top: 0; left: 0; width: 100%; height: 100%;
           background: url('https://www.transparenttextures.com/patterns/dark-matter.png'), linear-gradient(135deg, #1c2a4b, #111827);
           border-radius: 1rem;
           overflow: auto;
           padding: 1.5rem;
           animation: fadeIn 0.5s;
       }
       @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
       .main-view h2 { color: var(--color-primary); margin-bottom: 1rem; font-size: 1.8rem; }
       
       /* --- VUE VILLE --- */
       .city-view-content { position: relative; width: 100%; height: 100%; min-height: 400px; }
       .building-plot {
           position: absolute; background: rgba(30, 64, 175, 0.3); border: 2px dashed rgba(59, 130, 246, 0.5);
           border-radius: 0.5rem; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center;
           align-items: center; font-size: 2rem; color: rgba(255, 255, 255, 0.5);
       }
       .building-plot:hover, .building-plot.selected { background: rgba(251, 191, 36, 0.3); border-color: var(--color-primary); }
       .building-plot.constructing::after { content: '‚è≥'; position: absolute; top: 5px; right: 5px; font-size: 1rem; animation: pulse 1.5s infinite; }
       @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
       .building-plot .level { position: absolute; bottom: 2px; right: 5px; font-size: 0.8rem; font-weight: bold; color: white; background: rgba(0,0,0,0.5); padding: 0 4px; border-radius: 3px; }

       /* --- GRILLES DE CARTE (Monde & √éle) --- */
       .map-grid-container {
           display: grid;
           width: 100%;
           aspect-ratio: 1 / 1;
           max-width: 800px;
           margin: auto;
           gap: 4px;
       }
       .map-tile {
           border-radius: 4px;
           transition: all 0.2s ease-in-out;
           cursor: pointer;
           position: relative;
           display: flex;
           justify-content: center;
           align-items: center;
           font-size: 2rem;
       }
       .map-tile .tooltip {
           visibility: hidden; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
           background-color: var(--color-dark-1); color: white; padding: 5px 10px; border-radius: 6px;
           white-space: nowrap; z-index: 20; font-size: 0.8rem;
       }
       .map-tile:hover {
           transform: scale(1.1);
           z-index: 10;
       }
       .map-tile:hover .tooltip { visibility: visible; }

       /* --- VUE MONDE --- */
       #world-map-grid { grid-template-columns: repeat(15, 1fr); }
       .world-tile { background-color: var(--color-secondary); opacity: 0.3; }
       .world-tile.island { background-color: var(--color-secondary); opacity: 0.8; }
       .world-tile.player { background-color: var(--color-primary); opacity: 1; }
       .world-tile.ally { background-color: var(--color-success); opacity: 1; }
       .world-tile.enemy { background-color: var(--color-danger); opacity: 1; }
       .world-tile.unexplored { opacity: 0.1; }

       /* --- VUE √éLE --- */
       #island-grid { grid-template-columns: repeat(7, 1fr); background: #0c4a6e; border-radius: 1rem; padding: 1rem; }
       .island-tile { background-color: #0891b2; }
       .island-tile.playerCity { background-color: var(--color-primary); }
       .island-tile.otherCity { background-color: var(--color-danger); }
       .island-tile.resource { background-color: #a16207; }
       .island-tile.wonder { background-color: #be185d; }

       /* --- VUE RECHERCHE, ETC. --- */
       .management-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));}
       .card { background: var(--color-panel-light); border: 1px solid var(--color-border); border-radius: 0.5rem; padding: 1rem; transition: all 0.3s; }
       .card:hover { border-color: var(--color-primary); transform: translateY(-5px); }
       .card h4 { color: var(--color-primary); margin-bottom: 0.5rem; }
       .card p { color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; }
       .card .cost { font-size: 0.8rem; margin-bottom: 1rem; }
       .action-btn { width: 100%; background: var(--color-primary); color: var(--color-dark-1); border: none; padding: 0.75rem; border-radius: 0.5rem; font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.3s; }
       .action-btn:hover { transform: scale(1.05); }
       .action-btn:disabled { background: #6b7280; cursor: not-allowed; transform: none; }

       /* --- PANNEAU CONTEXTUEL DROIT --- */
       .right-sidebar { width: 280px; flex-shrink: 0; background: var(--color-panel); padding: 1rem; border-radius: 1rem; display: flex; flex-direction: column; }
       #context-panel { flex-shrink: 0; }
       #context-panel h3 { color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
       #context-panel p { color: var(--color-text-muted); line-height: 1.5; }
       .queue-container { list-style: none; margin-top: auto; padding-top: 1rem; }
       .queue-container h3 { color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
       .queue-item { background: var(--color-panel-light); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
       .queue-item .name { font-weight: bold; }
       .queue-item .timer { color: var(--color-primary); }

       /* --- FOOTER --- */
       .game-footer { padding: 0.5rem 1rem; background: var(--color-panel); border-top: 1px solid var(--color-border); }
       .footer-content { max-width: 1600px; margin: 0 auto; color: var(--color-text-muted); text-align: center; }

       /* --- MODAL --- */
       .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s; }
       .modal-content { background: var(--color-dark-1); border: 1px solid var(--color-primary); padding: 2rem; border-radius: 1rem; text-align: center; width: 90%; max-width: 400px; }
       .modal-content h4 { font-size: 1.5rem; color: var(--color-primary); margin-bottom: 1rem; }
       #modal-cost { color: var(--color-text-muted); margin-bottom: 1rem; }
       .modal-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
       .modal-btn { border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-weight: bold; transition: opacity 0.3s; }
       .modal-btn.confirm { background: var(--color-primary); color: var(--color-dark-1); }
       .modal-btn.cancel { background: var(--color-panel-light); color: var(--color-text); }
       .modal-btn:hover { opacity: 0.8; }

       /* --- BUILDING SELECTION --- */
       .build-select-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; max-height: 300px; overflow-y: auto; }
       .build-option { background: var(--color-panel-light); padding: 0.5rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; transition: all 0.3s; border: 1px solid transparent; }
       .build-option:hover { border-color: var(--color-primary); transform: translateY(-2px); }
       .build-option .cost { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem; }
       
       /* --- ANIMATIONS ET EFFETS --- */
       @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
       @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
       @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--color-primary); } 50% { box-shadow: 0 0 20px var(--color-primary), 0 0 30px var(--color-primary); } }
       
       .achievement-notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, var(--color-success), #16a34a); color: white; padding: 1rem; border-radius: 0.5rem; z-index: 1001; animation: slideIn 0.5s ease-out; max-width: 300px; }
       .level-up-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, var(--color-primary), #f59e0b); color: var(--color-dark-1); padding: 2rem; border-radius: 1rem; z-index: 1002; animation: bounceIn 0.8s ease-out; text-align: center; font-weight: bold; font-size: 1.2rem; }
       
       .resource-gain { animation: glow 1s ease-in-out; }
       .building-completed { animation: bounceIn 0.6s ease-out; }
       
       /* --- TOOLTIPS AM√âLIOR√âS --- */
       .enhanced-tooltip { position: relative; }
       .enhanced-tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: var(--color-dark-1); color: white; padding: 0.5rem; border-radius: 0.25rem; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.3s; font-size: 0.8rem; z-index: 100; }
       .enhanced-tooltip:hover::after { opacity: 1; visibility: visible; }

       /* --- NAVIGATION MOBILE --- */
       .mobile-nav { display: none; }

       /* --- RESPONSIVE DESIGN --- */
       @media (max-width: 900px) {
           .left-sidebar, .right-sidebar { display: none; }
           .game-body { padding: 0.5rem; }
           .main-view { padding: 1rem; }
           .player-info { font-size: 0.9rem; }
           .resources { gap: 0.5rem; padding: 0.5rem; }
           .resource-item { font-size: 0.9rem; }
           .resource-item span { min-width: 30px; }
           
           .game-ui { padding-bottom: 60px; /* Espace pour la nav mobile */ }
           .mobile-nav {
               display: flex;
               position: fixed;
               bottom: 0; left: 0; right: 0;
               background: var(--color-panel);
               backdrop-filter: blur(5px);
               border-top: 1px solid var(--color-border);
               justify-content: space-around;
               padding: 0.5rem 0;
               z-index: 200;
           }
           .mobile-nav a {
               flex-grow: 1;
               text-align: center;
               color: var(--color-text-muted);
               text-decoration: none;
               padding: 0.25rem 0;
               font-size: 1.5rem; /* Icon size */
               position: relative;
           }
           .mobile-nav a.active {
               color: var(--color-primary);
           }
            .mobile-nav a.active::after {
               content: '';
               position: absolute;
               bottom: -5px;
               left: 50%;
               transform: translateX(-50%);
               width: 8px;
               height: 8px;
               background: var(--color-primary);
               border-radius: 50%;
           }
       }
   </style>
</head>
<body>
   <div class="game-ui">
       <!-- HEADER -->
       <header class="game-header">
           <div class="header-content">
               <div class="player-info">
                   <a href="#" title="Voir le profil du champion">Joueur_01</a>
                   <div style="font-size: 0.8rem; color: var(--color-primary);">
                       Niv. <span id="playerLevel">1</span> | XP: <span id="playerXP">0</span>/<span id="playerXPNeeded">100</span>
                   </div>
               </div>
               <div class="resources">
                   <div class="resource-item" title="Bois">üå≤ <span id="resWood">0</span></div>
                   <div class="resource-item" title="Vin">üçá <span id="resWine">0</span></div>
                   <div class="resource-item" title="Marbre">üèõÔ∏è <span id="resMarble">0</span></div>
                   <div class="resource-item" title="Cristal">üíé <span id="resCrystal">0</span></div>
                   <div class="resource-item" title="Soufre">üî• <span id="resSulfur">0</span></div>
                   <div class="resource-item" title="Or">üí∞ <span id="resGold">0</span></div>
                   <div class="resource-item" title="Points de Recherche">üî¨ <span id="resResearch">0</span></div>
               </div>
               <div class="player-info">
                   <div style="font-size: 0.8rem; margin-bottom: 0.25rem;">
                       üèÜ <span id="achievementCount">0</span> achievements
                   </div>
                   <a href="#" title="Quitter la bataille en douce">D√©connexion</a>
               </div>
           </div>
       </header>

       <!-- CORPS PRINCIPAL -->
       <main class="game-body">
           <!-- MENU GAUCHE (Desktop) -->
           <nav class="left-sidebar main-nav">
               <ul>
                   <li><a href="#" data-view="city" title="Visitez votre ville en pantoufles">üèõÔ∏è <span>Ville</span></a></li>
                   <li><a href="#" data-view="island" title="Explorer les √Æles en tongs">üèùÔ∏è <span>√éle</span></a></li>
                   <li><a href="#" data-view="world" title="Observer le monde d'un coup d'≈ìil">üåç <span>Monde</span></a></li>
                   <li><a href="#" data-view="research" title="Traquer les savants fous">üî¨ <span>Recherche</span></a></li>
                   <li><a href="#" data-view="military" title="Armez-vous, √ßa va piquer">‚öîÔ∏è <span>Militaire</span></a></li>
                   <li><a href="#" data-view="diplomacy" title="Serrer des mains virtuelles">ü§ù <span>Diplomatie</span></a></li>
                   <li><a href="#" data-view="achievements" title="Vos exploits h√©ro√Øques">üèÜ <span>Achievements</span></a></li>
                   <li><a href="#" data-view="quests" title="Missions et √©v√©nements">üìã <span>Qu√™tes</span></a></li>
                   <li><a href="#" data-view="trade" title="Commerce et √©changes">üí± <span>Commerce</span></a></li>
               </ul>
           </nav>

           <!-- VUE CENTRALE (Conteneur pour toutes les vues) -->
           <div class="main-view-container">
               <section id="view-city" class="main-view"><div class="city-view-content" id="city-grid"></div></section>
               <section id="view-island" class="main-view hidden"><h2>Vue de l'√éle</h2><div id="island-grid" class="map-grid-container"></div></section>
               <section id="view-world" class="main-view hidden"><h2>Carte du Monde</h2><div id="world-map-grid" class="map-grid-container"></div></section>
               <section id="view-research" class="main-view hidden"><h2>Recherche</h2><div id="research-grid" class="management-grid"></div></section>
               <section id="view-military" class="main-view hidden"><h2>Militaire</h2><div id="military-grid" class="management-grid"></div></section>
               <section id="view-battle" class="main-view hidden"><h2>Bataille</h2><div id="battle-grid" class="management-grid"></div></section>
               <section id="view-diplomacy" class="main-view hidden"><h2>Diplomatie</h2><div id="diplomacy-grid" class="management-grid"></div></section>
               <section id="view-achievements" class="main-view hidden"><h2>Achievements & Statistiques</h2><div id="achievements-grid" class="management-grid"></div></section>
               <section id="view-quests" class="main-view hidden"><h2>Qu√™tes & √âv√©nements</h2><div id="quests-grid" class="management-grid"></div></section>
               <section id="view-trade" class="main-view hidden"><h2>Commerce & √âchanges</h2><div id="trade-grid" class="management-grid"></div></section>
           </div>
           
           <!-- PANNEAU DROIT (Desktop) -->
           <aside class="right-sidebar">
               <div id="context-panel">
                   <!-- Contenu inject√© par JavaScript -->
               </div>
               <div class="queue-container">
                   <h3>Files d'attente</h3>
                   <ul id="queueList"></ul>
               </div>
           </aside>
       </main>

       <!-- FOOTER -->
       <footer class="game-footer">
           <div class="footer-content">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                   <div id="event-log">Bienvenue dans Empire !</div>
                   <div style="display: flex; gap: 1rem;">
                       <button onclick="showHelp('buildings')" style="background: none; border: 1px solid var(--color-border); color: var(--color-text); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">üí° Aide</button>
                       <button onclick="saveState(); logEvent('üíæ Jeu sauvegard√© manuellement')" style="background: none; border: 1px solid var(--color-border); color: var(--color-text); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">üíæ Sauvegarder</button>
                       <button onclick="if(confirm('√ätes-vous s√ªr de vouloir recommencer ? Toute progression sera perdue.')) { localStorage.removeItem('empireGameState'); location.reload(); }" style="background: none; border: 1px solid var(--color-danger); color: var(--color-danger); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">üîÑ Reset</button>
                   </div>
               </div>
           </div>
       </footer>

       <!-- NAVIGATION MOBILE -->
       <nav class="mobile-nav main-nav">
¬≤
           <a href="#" data-view="city" title="Ville, version poche">üèõÔ∏è</a>
           <a href="#" data-view="island" title="√éle au bout du doigt">üèùÔ∏è</a>
           <a href="#" data-view="world" title="Le monde tient dans ta main">üåç</a>
           <a href="#" data-view="research" title="Science express">üî¨</a>
           <a href="#" data-view="military" title="Pr√™t pour l'assaut miniature">‚öîÔ∏è</a>
           <a href="#" data-view="diplomacy" title="Diplomatie de poche">ü§ù</a>
           <a href="#" data-view="achievements" title="Vos troph√©es">üèÜ</a>
           <a href="#" data-view="quests" title="Missions">üìã</a>
           <a href="#" data-view="trade" title="Commerce">üí±</a>

       </nav>
   </div>
   
   <!-- MODAL -->

   <div class="modal-overlay" id="actionModal"><div class="modal-content"><h4 id="modalTitle"></h4><p id="modalMessage"></p><div id="modal-cost"></div><div class="modal-actions"><button class="modal-btn cancel" id="modalCancelBtn" title="Annule comme un ninja">Annuler</button><button class="modal-btn confirm" id="modalConfirmBtn" title="Confirme, brave h√©ros">Confirmer</button></div></div></div>

   <script src="gameplay.js"></script>
   <script>
       document.addEventListener('DOMContentLoaded', function() {
           // --- CONFIGURATION DU JEU ---
           const config = {
               buildings: {
                   "H√¥tel de Ville": { description: "Augmente la population et le revenu en or.", icon: "üèõÔ∏è", levels: [ { cost: { wood: 150 }, buildTime: 10 }, { cost: { wood: 350 }, buildTime: 25 } ] },
                   "Caserne": { description: "Permet de recruter des unit√©s.", icon: "‚öîÔ∏è", levels: [ { cost: { wood: 200, gold: 50 }, buildTime: 15 }, { cost: { wood: 450, gold: 120 }, buildTime: 35 } ] },
                   "Entrep√¥t": { description: "Augmente le stockage.", icon: "üß±", levels: [ { cost: { wood: 250 }, buildTime: 12 }, { cost: { wood: 500 }, buildTime: 30 } ] },
                   "Acad√©mie": { description: "Produit des points de recherche.", icon: "üî¨", levels: [ { cost: { wood: 300, crystal: 100 }, buildTime: 20 }, { cost: { wood: 600, crystal: 250 }, buildTime: 45 } ] },
                   "Taverne": { description: "Augmente le bonheur des habitants.", icon: "üç∫", levels: [ { cost: { wood: 220, wine: 40 }, buildTime: 15 }, { cost: { wood: 450, wine: 100 }, buildTime: 35 } ] },
                   "Mus√©e": { description: "Exhibe des tr√©sors culturels.", icon: "üè∫", levels: [ { cost: { wood: 300, marble: 100 }, buildTime: 20 }, { cost: { wood: 600, marble: 250 }, buildTime: 45 } ] },
                   "Muraille": { description: "Renforce la d√©fense de la ville.", icon: "üõ°Ô∏è", levels: [ { cost: { wood: 250, marble: 150 }, buildTime: 25 }, { cost: { wood: 550, marble: 350 }, buildTime: 60 } ] },
                   "Port": { description: "Permet les √©changes maritimes.", icon: "‚öì", levels: [ { cost: { wood: 400 }, buildTime: 30 }, { cost: { wood: 800 }, buildTime: 60 } ] },
                   "Chantier Naval": { description: "Construit des navires de guerre.", icon: "üö¢", levels: [ { cost: { wood: 500, sulfur: 200 }, buildTime: 35 }, { cost: { wood: 900, sulfur: 400 }, buildTime: 70 } ] },
                   "March√©": { description: "Centre des √©changes commerciaux.", icon: "üè¨", levels: [ { cost: { wood: 300, gold: 100 }, buildTime: 20 }, { cost: { wood: 650, gold: 250 }, buildTime: 45 } ] },
                   "Foresterie": { description: "Augmente la production de bois.", icon: "üå≤", levels: [ { cost: { wood: 200 }, buildTime: 12 }, { cost: { wood: 450 }, buildTime: 30 } ] },
                   "Carri√®re de Pierre": { description: "Augmente la production de marbre.", icon: "ü™®", levels: [ { cost: { wood: 200, marble: 50 }, buildTime: 15 }, { cost: { wood: 500, marble: 120 }, buildTime: 35 } ] },
                   "Verrerie": { description: "Produit du cristal.", icon: "üß™", levels: [ { cost: { wood: 250, crystal: 80 }, buildTime: 18 }, { cost: { wood: 550, crystal: 200 }, buildTime: 40 } ] },
                   "Cave √† Vin": { description: "Produit du vin.", icon: "üç∑", levels: [ { cost: { wood: 220, wine: 50 }, buildTime: 18 }, { cost: { wood: 520, wine: 120 }, buildTime: 40 } ] },
                   "Alchimiste": { description: "Transforme le soufre.", icon: "‚öóÔ∏è", levels: [ { cost: { wood: 240, sulfur: 60 }, buildTime: 18 }, { cost: { wood: 540, sulfur: 150 }, buildTime: 40 } ] },
                   "Menuiserie": { description: "R√©duit le co√ªt en bois des constructions.", icon: "ü™µ", levels: [ { cost: { wood: 300 }, buildTime: 22 }, { cost: { wood: 650 }, buildTime: 50 } ] },
                   "Architecte": { description: "R√©duit le co√ªt en marbre.", icon: "üìê", levels: [ { cost: { wood: 300, marble: 100 }, buildTime: 22 }, { cost: { wood: 650, marble: 220 }, buildTime: 50 } ] },
                   "Opticien": { description: "R√©duit le co√ªt en cristal.", icon: "üëì", levels: [ { cost: { wood: 300, crystal: 100 }, buildTime: 22 }, { cost: { wood: 650, crystal: 220 }, buildTime: 50 } ] },
                   "Vignoble": { description: "Augmente la production de vin.", icon: "üçá", levels: [ { cost: { wood: 240, wine: 40 }, buildTime: 16 }, { cost: { wood: 540, wine: 100 }, buildTime: 38 } ] },
                   "Artificier": { description: "Am√©liore les unit√©s sp√©ciales.", icon: "üéá", levels: [ { cost: { wood: 320, sulfur: 80 }, buildTime: 24 }, { cost: { wood: 700, sulfur: 180 }, buildTime: 55 } ] }
               },
               research: {
                   economy: { 
                       name: "√âconomie", 
                       icon: "üí∞", 
                       techs: { 
                           "Commerce": { description: "Augmente les revenus en or de 25%.", cost: { research: 200 }, time: 30 },
                           "Expansion": { description: "Permet de fonder une nouvelle colonie.", cost: { research: 500 }, time: 60 },
                           "Banque": { description: "G√©n√®re des int√©r√™ts sur votre or.", cost: { research: 800 }, time: 90 },
                           "Routes Commerciales": { description: "R√©duit les co√ªts de transport de 50%.", cost: { research: 1200 }, time: 120 }
                       } 
                   },
                   military: { 
                       name: "Militaire", 
                       icon: "‚öîÔ∏è", 
                       techs: { 
                           "Tactiques": { description: "Augmente l'attaque des unit√©s de 15%.", cost: { research: 250 }, time: 40 },
                           "Balistique": { description: "Am√©liore la pr√©cision des catapultes.", cost: { research: 400 }, time: 60 },
                           "Fortification": { description: "Augmente la d√©fense des murailles de 30%.", cost: { research: 600 }, time: 80 },
                           "Poudre √† Canon": { description: "D√©bloque les unit√©s √† poudre.", cost: { research: 1000 }, time: 100 }
                       } 
                   },
                   science: {
                       name: "Science",
                       icon: "üî¨",
                       techs: {
                           "Philosophie": { description: "Augmente la production de recherche de 20%.", cost: { research: 300 }, time: 50 },
                           "Math√©matiques": { description: "R√©duit le temps de construction de 15%.", cost: { research: 500 }, time: 70 },
                           "Ing√©nierie": { description: "D√©bloque des b√¢timents avanc√©s.", cost: { research: 750 }, time: 90 },
                           "Alchimie": { description: "Permet la transmutation des ressources.", cost: { research: 1100 }, time: 110 }
                       }
                   },
                   navigation: {
                       name: "Navigation",
                       icon: "‚õµ",
                       techs: {
                           "Cartographie": { description: "R√©v√®le 3 √Æles al√©atoirement.", cost: { research: 350 }, time: 45 },
                           "Navigation": { description: "Augmente la vitesse des navires de 25%.", cost: { research: 550 }, time: 65 },
                           "Astronomie": { description: "Am√©liore l'exploration maritime.", cost: { research: 800 }, time: 85 },
                           "Boussole": { description: "R√©duit les co√ªts d'exploration de 40%.", cost: { research: 1200 }, time: 105 }
                       }
                   }
               },
               units: {
                   "Hoplite": { description: "Unit√© de base solide.", icon: "üõ°Ô∏è", cost: { wood: 50, sulfur: 30, gold: 10 }, time: 5 },
                   "Archer": { description: "Attaque √† distance.", icon: "üèπ", cost: { wood: 40, gold: 15 }, time: 4 },
                   "Catapulte": { description: "Si√®ge puissant contre les b√¢timents.", icon: "üèπ", cost: { wood: 200, sulfur: 100, gold: 50 }, time: 15 },
                   "Cavalier": { description: "Unit√© rapide et mobile.", icon: "üêé", cost: { wood: 80, gold: 30 }, time: 8 },
                   "Phalange": { description: "Formation d√©fensive redoutable.", icon: "üõ°Ô∏è", cost: { wood: 120, sulfur: 60, gold: 25 }, time: 12 },
                   "√âclaireur": { description: "Unit√© de reconnaissance rapide.", icon: "üëÅÔ∏è", cost: { wood: 30, gold: 20 }, time: 3 },
                   "B√©lier": { description: "Sp√©cialis√© dans la destruction des murailles.", icon: "üêè", cost: { wood: 150, sulfur: 80, gold: 40 }, time: 10 },
                   "M√©decin": { description: "Soigne les unit√©s bless√©es.", icon: "‚öïÔ∏è", cost: { wood: 60, crystal: 40, gold: 35 }, time: 7 }
               },
               diplomacy: {
                   alliances: { "Les Spartiates": { tag: "SPQR", members: 15, points: 12000 } },
                   treaties: { "Trait√© Culturel": { description: "Augmente le bonheur de vos villes.", cost: { gold: 1000 } } }
               },
               cityLayout: [
                   { id: "townHall", top: "40%", left: "45%", width: "120px", height: "120px" }, { id: "plot1", top: "35%", left: "25%", width: "90px", height: "90px" },
                   { id: "plot2", top: "55%", left: "30%", width: "90px", height: "90px" }, { id: "plot3", top: "50%", left: "60%", width: "90px", height: "90px" },
                   { id: "academy", top: "20%", left: "60%", width: "90px", height: "90px" }, { id: "plot4", top: "20%", left: "30%", width: "90px", height: "90px" },
                   { id: "plot5", top: "70%", left: "40%", width: "90px", height: "90px" }, { id: "plot6", top: "75%", left: "65%", width: "90px", height: "90px" },
                   { id: "plot7", top: "25%", left: "75%", width: "90px", height: "90px" }, { id: "plot8", top: "65%", left: "75%", width: "90px", height: "90px" }
               ],
               islandLayout: {
                   size: 7,
                   plots: [
                       { x: 3, y: 3, type: 'playerCity', name: 'Votre Ville', icon: 'üèõÔ∏è' },
                       { x: 2, y: 5, type: 'otherCity', name: 'Ville de Joueur_02', icon: 'üèòÔ∏è' },
                       { x: 1, y: 2, type: 'resource', name: 'Scierie (Bois)', icon: 'üå≤' },
                       { x: 5, y: 4, type: 'resource', name: 'Mine de Marbre', icon: 'üíé' },
                       { x: 4, y: 1, type: 'wonder', name: 'Merveille Antique', icon: 'üåü' }
                   ]
               },
               worldMap: {
                   size: 15,
                   islands: [
                       { x: 7, y: 7, type: 'player', name: 'Votre Capitale' },
                       { x: 8, y: 9, type: 'ally', name: 'Alli√©_01' },
                       { x: 5, y: 6, type: 'enemy', name: 'Ennemi_Alpha' },
                       { x: 10, y: 11, type: 'island', name: '√éle aux merveilles' },
                       { x: 3, y: 4, type: 'island', name: '√éle sauvage' },
                       { x: 12, y: 5, type: 'island', name: '√éle abandonn√©e' }
                   ]
               },
               worldActions: {
                   explore: { label: 'Explorer', cost: { wood: 50, gold: 100 }, description: "R√©v√®le les d√©tails de la case." },
                   colonize: { label: 'Coloniser', cost: { wood: 1000, gold: 500 }, description: "Fonde une nouvelle colonie." },
                   attack: { label: 'Attaquer', cost: { sulfur: 200 }, description: "Lance une attaque contre l'√Æle cibl√©e." }
               }
           };

           // --- √âTAT DU JEU ---
           let gameState;
           const defaultGameState = {
               resources: { wood: 1000, wine: 100, marble: 100, crystal: 100, sulfur: 100, gold: 5000, research: 0 },
               buildings: { "townHall": { type: "H√¥tel de Ville", level: 1 }, "plot1": { type: "Caserne", level: 1 }, "plot2": { type: null, level: 0 }, "plot3": { type: null, level: 0 }, "academy": { type: "Acad√©mie", level: 1 }, "plot4": { type: null, level: 0 }, "plot5": { type: null, level: 0 }, "plot6": { type: null, level: 0 }, "plot7": { type: null, level: 0 }, "plot8": { type: null, level: 0 } },
               researchCompleted: [],
               queues: { build: [], research: [], military: [] },
               cooldowns: { build: 0, research: 0, military: 0 },
               exploredIslands: [{ x: 7, y: 7, name: "√éle Capitale", type: "capital", resources: ["wood", "wine"], population: 1000, development: 1 }],
               colonizedIslands: [],
               currentIsland: { x: 7, y: 7 }, // √éle actuellement s√©lectionn√©e
               islandDetails: {
                   "7-7": {
                       name: "√éle Capitale",
                       type: "capital",
                       climate: "temperate",
                       terrain: ["plains", "forest", "hills"],
                       naturalResources: ["wood", "wine", "marble"],
                       population: 1000,
                       happiness: 75,
                       development: 1,
                       infrastructure: { roads: 1, ports: 1, defenses: 1 },
                       specialBuildings: [],
                       districts: {
                           residential: { level: 1, population: 400 },
                           commercial: { level: 1, income: 50 },
                           industrial: { level: 1, production: 30 },
                           military: { level: 1, defense: 25 }
                       }
                   }
               },
               worldEvents: [],
               tradeRoutes: [],
               diplomacy: {
                   relations: {},
                   treaties: [],
                   reputation: 50
               },
               playerStats: { level: 1, xp: 0, totalBuildings: 2, totalUnits: 0 },
               achievements: [],
               activeQuests: [],
               completedQuests: [],
               questPoints: 0,
               eventHistory: [],
               lastEventTime: 0,
               lastEventCheck: 0,
               tradeReputation: 50,
               tradeHistory: [],
               activeContracts: [],
               militaryUnits: [],
               lastUpdate: Date.now()
           };

           // --- DOM ELEMENTS ---
           const dom = {
               res: Object.keys(defaultGameState.resources).reduce((acc, key) => ({ ...acc, [key]: document.getElementById(`res${key.charAt(0).toUpperCase() + key.slice(1)}`) }), {}),
               cityGrid: document.getElementById('city-grid'), islandGrid: document.getElementById('island-grid'),
               worldMapGrid: document.getElementById('world-map-grid'),
               contextPanel: document.getElementById('context-panel'), queueList: document.getElementById('queueList'),
               eventLog: document.getElementById('event-log'), modal: document.getElementById('actionModal'),
               modalTitle: document.getElementById('modalTitle'), modalMessage: document.getElementById('modalMessage'),
               modalCost: document.getElementById('modal-cost'), modalConfirmBtn: document.getElementById('modalConfirmBtn'),
               modalCancelBtn: document.getElementById('modalCancelBtn'), navLinks: document.querySelectorAll('.main-nav a'),
               mainViews: document.querySelectorAll('.main-view'), researchGrid: document.getElementById('research-grid'),
               militaryGrid: document.getElementById('military-grid'), battleGrid: document.getElementById('battle-grid'),
               diplomacyGrid: document.getElementById('diplomacy-grid'), questsGrid: document.getElementById('quests-grid'),
               tradeGrid: document.getElementById('trade-grid'), achievementsGrid: document.getElementById('achievements-grid'),
               worldGrid: document.getElementById('world-grid'),
           };

           let selectedPlotId = null;
           let currentAction = null;
           const ACTION_COOLDOWNS = { build: 5, research: 5, military: 5 };
           function isCooldownActive(type) { return gameState.cooldowns[type] && Date.now() < gameState.cooldowns[type]; }

           // --- PERSISTANCE DES DONN√âES ---
           function saveState() { localStorage.setItem('empireGameState', JSON.stringify(gameState)); }
          function loadState() {
              const savedState = localStorage.getItem('empireGameState');
               gameState = savedState ? JSON.parse(savedState) : JSON.parse(JSON.stringify(defaultGameState));
               
               // Migration des anciennes sauvegardes
               if (!gameState.cooldowns) gameState.cooldowns = { build: 0, research: 0, military: 0 };
               if (!gameState.exploredIslands) gameState.exploredIslands = [{ x: 7, y: 7, name: "√éle Capitale", type: "capital", resources: ["wood", "wine"], population: 1000, development: 1 }];
               if (!gameState.colonizedIslands) gameState.colonizedIslands = [];
               if (!gameState.currentIsland) gameState.currentIsland = { x: 7, y: 7 };
               if (!gameState.islandDetails) gameState.islandDetails = {};
               if (!gameState.worldEvents) gameState.worldEvents = [];
               if (!gameState.tradeRoutes) gameState.tradeRoutes = [];
               if (!gameState.diplomacy) gameState.diplomacy = { relations: {}, treaties: [], reputation: 50 };
               if (!gameState.playerStats) gameState.playerStats = { level: 1, xp: 0, totalBuildings: 2, totalUnits: 0 };
               if (!gameState.achievements) gameState.achievements = [];
               if (!gameState.activeQuests) gameState.activeQuests = [];
               if (!gameState.completedQuests) gameState.completedQuests = [];
               if (!gameState.eventHistory) gameState.eventHistory = [];
               if (!gameState.lastEventTime) gameState.lastEventTime = 0;
               
              const offlineTime = (Date.now() - gameState.lastUpdate) / 1000;
              produceResources(offlineTime);
              gameState.lastUpdate = Date.now();
              
              // Afficher les gains hors ligne si significatifs
              if (offlineTime > 60) {
                  logEvent(`Bienvenue ! Vous avez gagn√© des ressources pendant votre absence (${Math.floor(offlineTime/60)} min).`);
              }
          }

           // --- NAVIGATION & VUES ---
           function switchView(viewId) {
               dom.mainViews.forEach(view => view.classList.add('hidden'));
               document.getElementById(`view-${viewId}`).classList.remove('hidden');
               dom.navLinks.forEach(link => {
                   link.classList.toggle('active', link.dataset.view === viewId);
               });
               updateContextPanel(); // Clear context panel on view switch
           }

           // --- LOGIQUE DE JEU PRINCIPALE ---
           function init() {
               loadState();
               renderAll();
               switchView('city'); // Start on city view
               setInterval(gameLoop, 1000);
               dom.navLinks.forEach(link => {
                   link.addEventListener('click', (e) => {
                       e.preventDefault();
                       switchView(link.dataset.view)
                   });
               });
           }
           
           function renderAll() {
               renderCityLayout();
               renderIslandView();
               renderWorldMap();
               renderResearchTree();
               renderMilitaryUnits();
               renderBattle();
               renderDiplomacy();
               renderAchievements();
               renderQuests();
               renderTrade();
               updateAllUI();
           }

           function gameLoop() {
               try {
                   produceResources(1);
                   processQueues();
                   updateAllUI();
                   checkAchievements();
                   processQuests();
                   checkRandomEvents();
                   
                   // Sauvegarde automatique toutes les 30 secondes
                   if (!gameLoop.lastSave || Date.now() - gameLoop.lastSave > 30000) {
                       saveState();
                       gameLoop.lastSave = Date.now();
                   }
               } catch (error) {
                   console.error('Erreur dans la boucle de jeu:', error);
                   logEvent('‚ö†Ô∏è Erreur d√©tect√©e, tentative de r√©cup√©ration...');
               }
           }

           function produceResources(seconds) {
               const townHallLevel = gameState.buildings.townHall?.level || 1;
               const academyLevel = gameState.buildings.academy?.level || 0;
               
               // Production de base de l'√Æle capitale
               const capitalKey = "7-7";
               const capitalData = gameState.islandDetails[capitalKey];
               
               let baseProduction = {
                   gold: townHallLevel * 2 * seconds / 3600,
                   wood: 5 * seconds / 3600,
                   research: academyLevel > 0 ? academyLevel * 2 * seconds / 3600 : 0,
                   wine: 0,
                   marble: 0,
                   crystal: 0,
                   sulfur: 0
               };
               
               // Bonus des ressources naturelles de l'√Æle capitale
               if (capitalData && capitalData.naturalResources) {
                   capitalData.naturalResources.forEach(resource => {
                       if (baseProduction[resource] !== undefined) {
                           baseProduction[resource] *= 1.5; // +50% pour les ressources naturelles
                       } else {
                           baseProduction[resource] = 1 * seconds / 3600; // Production de base pour les nouvelles ressources
                       }
                   });
               }
               
               // Bonus des districts de l'√Æle capitale
               if (capitalData && capitalData.districts) {
                   baseProduction.gold += (capitalData.districts.commercial.income || 0) * seconds / 3600;
                   
                   const industrialBonus = (capitalData.districts.industrial.production || 0) / 100;
                   Object.keys(baseProduction).forEach(resource => {
                       if (resource !== 'gold') {
                           baseProduction[resource] *= (1 + industrialBonus);
                       }
                   });
               }
               
               // Production des colonies
               gameState.colonizedIslands.forEach(colony => {
                   const colonyKey = `${colony.x}-${colony.y}`;
                   const colonyData = gameState.islandDetails[colonyKey];
                   
                   if (colonyData) {
                       // Production bas√©e sur le d√©veloppement de la colonie
                       const developmentMultiplier = colonyData.development * 0.5;
                       
                       // Ressources naturelles de la colonie
                       if (colonyData.naturalResources) {
                           colonyData.naturalResources.forEach(resource => {
                               const amount = developmentMultiplier * 2 * seconds / 3600;
                               baseProduction[resource] = (baseProduction[resource] || 0) + amount;
                           });
                       }
                       
                       // Production des districts de la colonie
                       if (colonyData.districts) {
                           baseProduction.gold += (colonyData.districts.commercial.income || 0) * 0.5 * seconds / 3600;
                       }
                   }
               });
               
               // Bonus des b√¢timents sp√©cialis√©s
               Object.entries(gameState.buildings).forEach(([id, building]) => {
                   if (!building.type) return;
                   const level = building.level || 0;
                   
                   switch(building.type) {
                       case "Foresterie":
                           baseProduction.wood += level * 1.5 * seconds / 3600;
                           break;
                       case "Cave √† Vin":
                           baseProduction.wine += level * 1 * seconds / 3600;
                           break;
                       case "Carri√®re de Pierre":
                           baseProduction.marble += level * 0.8 * seconds / 3600;
                           break;
                       case "Verrerie":
                           baseProduction.crystal += level * 0.6 * seconds / 3600;
                           break;
                       case "Alchimiste":
                           baseProduction.sulfur += level * 0.5 * seconds / 3600;
                           break;
                   }
               });
               
               // Bonus des routes commerciales
               gameState.tradeRoutes.forEach(route => {
                   const profit = calculateTradeRouteProfit(route);
                   baseProduction.gold += profit * seconds / 3600; // Profit par minute converti
               });
               
               // Bonus de niveau du joueur
               const levelBonus = gameState.playerStats.level * 0.05; // 5% par niveau
               Object.keys(baseProduction).forEach(resource => {
                   baseProduction[resource] *= (1 + levelBonus);
               });
               
               // Bonus des technologies recherch√©es
               if (gameState.researchCompleted.includes('Commerce')) {
                   baseProduction.gold *= 1.25;
               }
               if (gameState.researchCompleted.includes('Philosophie')) {
                   baseProduction.research *= 1.2;
               }
               
               // Appliquer la production finale
               Object.entries(baseProduction).forEach(([resource, amount]) => {
                   gameState.resources[resource] = (gameState.resources[resource] || 0) + Math.max(0, amount);
               });
               
               gameState.lastUpdate = Date.now();
           }

           function processQueues() {
               const now = Date.now();
               let stateChanged = false;
               ['build', 'research', 'military'].forEach(qType => {
                   const finished = [];
                   gameState.queues[qType].forEach((item, index) => {
                       if (now >= item.endTime) {
                           finished.push(index);
                           logEvent(`${item.name} termin√© !`);
                           
                           if (qType === 'build') {
                               if (item.level === 1) gameState.buildings[item.id].type = item.name;
                               gameState.buildings[item.id].level = item.level;
                               gameState.playerStats.totalBuildings++;
                               addXP(item.level * 10);
                               checkAchievements();
                           } else if (qType === 'research') {
                               gameState.researchCompleted.push(item.name);
                               addXP(50);
                               checkAchievements();
                           } else if (qType === 'military') {
                               gameState.playerStats.totalUnits += item.count || 1;
                               addXP(item.count * 5);
                               checkAchievements();
                           }
                           stateChanged = true;
                       }
                   });
                   if (finished.length > 0) {
                       gameState.queues[qType] = gameState.queues[qType].filter((_, index) => !finished.includes(index));
                   }
               });
               if (stateChanged) {
                   renderAll();
                   if (selectedPlotId) updateContextPanel(selectedPlotId);
               }
           }
           
          function startAction(type, id, name, level) {
               if (isCooldownActive(type)) { showModal("Action impossible", "Cette action est encore en cooldown."); return; }
               const queue = gameState.queues[type];
               let spec, cost, time;
               if (type === 'build') { spec = config.buildings[name].levels[level - 1]; }
               else if (type === 'research') { const branch = Object.keys(config.research).find(br => config.research[br].techs[name]); spec = config.research[branch].techs[name]; }
               else if (type === 'military') { spec = config.units[name]; }
               cost = spec.cost; time = spec.buildTime || spec.time;
               for(const res in cost) { if (gameState.resources[res] < cost[res]) { showModal("Action impossible", "Ressources insuffisantes."); return; } }
               for(const res in cost) gameState.resources[res] -= cost[res];
               const endTime = Date.now() + time * 1000;
               queue.push({ id, name, level, endTime });
               gameState.cooldowns[type] = Date.now() + ACTION_COOLDOWNS[type] * 1000;
               logEvent(`Lancement: ${name}.`);
               updateAllUI();
               if (selectedPlotId) updateContextPanel(selectedPlotId);
          }

           function startWorldAction(action, coords, name) {
               const [x, y] = coords.split(',').map(Number);
               const spec = config.worldActions[action];
               const cost = spec.cost || {};
               for (const res in cost) { if (gameState.resources[res] < cost[res]) { showModal("Action impossible", "Ressources insuffisantes."); return; } }
               for (const res in cost) gameState.resources[res] -= cost[res];
               if (action === 'explore') {
                   gameState.exploredIslands.push({ x, y });
                   logEvent(`Exploration de [${x},${y}] termin√©e.`);
               } else if (action === 'colonize') {
                   gameState.colonizedIslands.push({ x, y, type: 'player', name: name || 'Nouvelle Colonie' });
                   if (!gameState.exploredIslands.some(p => p.x === x && p.y === y)) gameState.exploredIslands.push({ x, y });
                   logEvent(`Vous avez colonis√© [${x},${y}].`);
               } else if (action === 'attack') {
                   logEvent(`Vous attaquez ${name} [${x},${y}].`);
               }
               updateAllUI();
               renderWorldMap();
               saveState();
           }

           // --- FONCTIONS D'AFFICHAGE ---
           function updateAllUI() { updateResourceUI(); updatePlayerUI(); updateQueueUI(); updateActionAvailability(); }
           function updateResourceUI() { 
               for (const res in dom.res) { 
                   if(dom.res[res]) dom.res[res].textContent = Math.floor(gameState.resources[res]); 
               } 
           }
           
           function updatePlayerUI() {
               const levelEl = document.getElementById('playerLevel');
               const xpEl = document.getElementById('playerXP');
               const xpNeededEl = document.getElementById('playerXPNeeded');
               const achievementEl = document.getElementById('achievementCount');
               
               if (levelEl) levelEl.textContent = gameState.playerStats.level;
               if (xpEl) xpEl.textContent = gameState.playerStats.xp;
               if (xpNeededEl) xpNeededEl.textContent = gameState.playerStats.level * 100;
               if (achievementEl) achievementEl.textContent = gameState.achievements.length;
           }
           
           function renderCityLayout() {
               dom.cityGrid.innerHTML = '';
               config.cityLayout.forEach(plot => {
                   const el = document.createElement('div'); el.className = 'building-plot'; el.dataset.plotId = plot.id;
                   el.style.cssText = `top:${plot.top}; left:${plot.left}; width:${plot.width}; height:${plot.height};`;
                   const building = gameState.buildings[plot.id];
                   if (building && building.type) { el.innerHTML = `${config.buildings[building.type].icon}<div class="level">Niv. ${building.level}</div>`; } else { el.innerHTML = '‚ûï'; }
                   if (gameState.queues.build.some(item => item.id === plot.id)) el.classList.add('constructing');
                   el.addEventListener('click', () => {
                       selectedPlotId = plot.id;
                       document.querySelectorAll('.building-plot.selected').forEach(p => p.classList.remove('selected'));
                       el.classList.add('selected');
                       if (window.innerWidth > 900) updateContextPanel(plot.id);
                       else showContextModalForBuilding(plot.id);
                   });
                   dom.cityGrid.appendChild(el);
               });
           }

         function renderWorldMap() {
             dom.worldMapGrid.innerHTML = '';
              
              let html = `
                  <div class="card" style="grid-column: 1 / -1;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                          <h3>üåç Carte du Monde - Empire de ${gameState.playerStats.empireName || 'l\'Empereur'}</h3>
                          <div style="display: flex; gap: 1rem;">
                              <div>√éles explor√©es: ${gameState.exploredIslands.length}</div>
                              <div>Colonies: ${gameState.colonizedIslands.length}</div>
                              <div>Routes commerciales: ${gameState.tradeRoutes.length}</div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="card" style="grid-column: 1 / -1;">
                      <div id="world-map-container" style="position: relative;">
                          <div id="world-map-grid" style="display: grid; grid-template-columns: repeat(15, 1fr); gap: 1px; background: #1e40af; padding: 0.5rem; border-radius: 0.5rem;">
              `;
              
              // G√©n√©rer la carte du monde 15x15
              for (let y = 0; y < 15; y++) {
                  for (let x = 0; x < 15; x++) {
                      const island = getIslandAtPosition(x, y);
                      const isExplored = gameState.exploredIslands.some(exp => exp.x === x && exp.y === y);
                      const isColonized = gameState.colonizedIslands.some(col => col.x === x && col.y === y);
                      const isCurrentIsland = gameState.currentIsland.x === x && gameState.currentIsland.y === y;
                      
                      let tileClass = 'ocean';
                      let tileIcon = 'üåä';
                      let tileTitle = 'Oc√©an';
                      
                      if (island) {
                          tileClass = island.type;
                          tileIcon = getIslandTypeIcon(island.type);
                          tileTitle = island.name || `√éle [${x},${y}]`;
                          
                          if (!isExplored && island.type !== 'capital') {
                              tileIcon = '‚ùì';
                              tileTitle = 'Territoire inexplor√©';
                          }
                      }
                      
                      html += `
                          <div class="world-tile ${tileClass} ${isCurrentIsland ? 'current-island' : ''}" 
                               onclick="selectWorldTile(${x}, ${y})" 
                               title="${tileTitle}"
                               style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; border-radius: 0.25rem; position: relative; ${isCurrentIsland ? 'border: 2px solid var(--color-primary); box-shadow: 0 0 10px var(--color-primary);' : 'border: 1px solid rgba(255,255,255,0.2);'} ${isColonized ? 'background: var(--color-success);' : isExplored ? 'background: var(--color-warning);' : island ? 'background: var(--color-panel);' : 'background: #1e40af;'}">
                              ${tileIcon}
                              ${isColonized ? '<div style="position: absolute; top: -2px; right: -2px; background: var(--color-success); border-radius: 50%; width: 8px; height: 8px;"></div>' : ''}
                              ${hasTradeRoute(x, y) ? '<div style="position: absolute; bottom: -2px; left: -2px; background: var(--color-warning); border-radius: 50%; width: 8px; height: 8px;"></div>' : ''}
                          </div>
                      `;
                  }
              }
              
              html += `
                          </div>
                          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; font-size: 0.9rem;">
                              <div><span style="color: var(--color-primary);">üèõÔ∏è</span> Votre capitale</div>
                              <div><span style="color: var(--color-success);">üèùÔ∏è</span> Vos colonies</div>
                              <div><span style="color: var(--color-warning);">üó∫Ô∏è</span> √éles explor√©es</div>
                              <div><span style="color: var(--color-danger);">‚öîÔ∏è</span> Territoires hostiles</div>
                              <div><span style="color: var(--color-text-muted);">ü§ù</span> Alli√©s</div>
                              <div><span style="color: var(--color-warning);">üí∞</span> Routes commerciales</div>
                          </div>
                      </div>
                  </div>
              `;
              
              // Civilisations connues
              html += `
                  <div class="card" style="grid-column: 1 / -1;">
                      <h3>üèõÔ∏è Civilisations Connues</h3>
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
              `;
              
              const knownCivilizations = getKnownCivilizations();
              knownCivilizations.forEach(civ => {
                  const relation = gameState.diplomacy.relations[civ.id] || 0;
                  const relationText = getRelationText(relation);
                  const relationColor = getRelationColor(relation);
                  
                  html += `
                      <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${relationColor};">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                              <h4 style="margin: 0; color: ${relationColor};">${civ.icon} ${civ.name}</h4>
                              <span style="font-size: 0.8rem; color: ${relationColor};">${relationText}</span>
                          </div>
                          <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">${civ.description}</p>
                          <div style="font-size: 0.8rem; color: var(--color-text-muted);">
                              <div>Territoire: ${civ.territories} √Æles</div>
                              <div>Puissance militaire: ${civ.militaryPower}</div>
                              <div>Richesse: ${civ.wealth}</div>
                          </div>
                          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                              <button onclick="openDiplomacy('${civ.id}')" class="action-btn" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                  Diplomatie
                              </button>
                              <button onclick="proposeTrade('${civ.id}')" class="action-btn" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                  Commerce
                              </button>
                          </div>
                      </div>
                  `;
              });
              
              html += `
                      </div>
                  </div>
              `;
              
              // Routes commerciales actives
              if (gameState.tradeRoutes.length > 0) {
                  html += `
                      <div class="card" style="grid-column: 1 / -1;">
                          <h3>üö¢ Routes Commerciales Actives</h3>
                          <div style="margin-top: 1rem;">
                  `;
                  
                  gameState.tradeRoutes.forEach((route, index) => {
                      const profit = calculateTradeRouteProfit(route);
                      html += `
                          <div style="background: var(--color-panel-light); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                              <div>
                                  <strong>${route.from.name} ‚Üî ${route.to.name}</strong><br>
                                  <span style="font-size: 0.9rem; color: var(--color-text-muted);">
                                      ${route.goods.join(', ')} | Distance: ${route.distance} cases
                                  </span>
                              </div>
                              <div style="text-align: right;">
                                  <div style="color: var(--color-success); font-weight: bold;">+${profit} or/min</div>
                                  <button onclick="cancelTradeRoute(${index})" class="action-btn" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--color-danger);">
                                      Annuler
                                  </button>
                              </div>
                          </div>
                      `;
                  });
                  
                  html += `
                          </div>
                      </div>
                  `;
              }
              
              // √âv√©nements mondiaux r√©cents
              if (gameState.worldEvents.length > 0) {
                  html += `
                      <div class="card" style="grid-column: 1 / -1;">
                          <h3>üì∞ √âv√©nements Mondiaux</h3>
                          <div style="margin-top: 1rem; max-height: 200px; overflow-y: auto;">
                  `;
                  
                  gameState.worldEvents.slice(-10).reverse().forEach(event => {
                      const timeAgo = Math.floor((Date.now() - event.timestamp) / 60000);
                      const timeText = timeAgo < 1 ? '√Ä l\'instant' : `Il y a ${timeAgo} min`;
                      
                      html += `
                          <div style="background: var(--color-panel-light); padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem; border-left: 3px solid var(--color-primary);">
                              <div style="display: flex; justify-content: space-between; align-items: center;">
                                  <strong>${event.title}</strong>
                                  <span style="font-size: 0.8rem; color: var(--color-text-muted);">${timeText}</span>
                              </div>
                              <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${event.description}</p>
                          </div>
                      `;
                  });
                  
                  html += `
                          </div>
                      </div>
                  `;
              }
              

               if(dom.worldMapGrid) {
                   dom.worldMapGrid.innerHTML = html;
               }
           }

           function handleWorldTileClick(x, y, island, explored) {
              if (!explored) {
                  showModal('explore', `${x},${y}`, `Case [${x},${y}]`);
                  return;
              }
              if (!island) {
                  showModal('Oc√©an', `Emplacement [${x},${y}]`);
                  return;
              }
              if (island.type === 'enemy') {
                  showModal('attack', `${x},${y}`, island.name);
              } else if (island.type === 'island') {
                  showModal('colonize', `${x},${y}`, island.name);
              } else {
                  showModal(island.name, `Type: ${island.type}`);
              }
           }
           
           function renderIslandView() {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey] || createDefaultIslandData(gameState.currentIsland);
               
               dom.islandGrid.innerHTML = '';
               
               let html = `
                   <div class="card" style="grid-column: 1 / -1;">
                       <div style="display: flex; justify-content: space-between; align-items: center;">
                           <div>
                               <h3>üèùÔ∏è ${islandData.name}</h3>
                               <p>Population: ${islandData.population.toLocaleString()} | Bonheur: ${islandData.happiness}% | D√©veloppement: Niveau ${islandData.development}</p>
                           </div>
                           <div style="text-align: right;">
                               <div>Climat: ${getClimateIcon(islandData.climate)} ${islandData.climate}</div>
                               <div>R√©putation: ${gameState.diplomacy.reputation}/100</div>
                           </div>
                       </div>
                   </div>
                   
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üó∫Ô∏è Carte de l'√éle</h3>
                       <div id="island-map" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.25rem; margin: 1rem 0;">
               `;
               
               // G√©n√©rer la carte de l'√Æle 6x6
               for (let y = 0; y < 6; y++) {
                   for (let x = 0; x < 6; x++) {
                       const tileId = `tile-${x}-${y}`;
                       const terrain = getTerrainForTile(x, y, islandData);
                       const building = getBuildingOnTile(x, y);
                       const isCenter = (x === 2 || x === 3) && (y === 2 || y === 3);
                       
                       html += `
                           <div class="island-tile ${terrain}" 
                                onclick="selectTile(${x}, ${y})" 
                                title="${getTerrainName(terrain)} ${building ? '- ' + building : ''}"
                                style="aspect-ratio: 1; border: 2px solid var(--color-border); border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; position: relative; ${isCenter ? 'border-color: var(--color-primary);' : ''}">
                               ${getTerrainIcon(terrain)}
                               ${building ? `<div style="position: absolute; top: -5px; right: -5px; background: var(--color-primary); border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">üèóÔ∏è</div>` : ''}
                           </div>
                       `;
                   }
               }
               
               html += `
                       </div>
                       <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                           <div><span style="color: #22c55e;">üå≤</span> For√™t</div>
                           <div><span style="color: #84cc16;">üåæ</span> Plaines</div>
                           <div><span style="color: #a3a3a3;">‚õ∞Ô∏è</span> Collines</div>
                           <div><span style="color: #3b82f6;">üåä</span> C√¥te</div>
                           <div><span style="color: #f59e0b;">üèúÔ∏è</span> D√©sert</div>
                           <div><span style="color: #8b5cf6;">üíé</span> Gisement</div>
                       </div>
                   </div>
               `;
               
               // Districts de l'√Æle
               html += `
                   <div class="card">
                       <h4>üèòÔ∏è District R√©sidentiel</h4>
                       <p>Population: ${islandData.districts.residential.population}</p>
                       <p>Niveau: ${islandData.districts.residential.level}</p>
                       <button onclick="upgradeDistrict('residential')" class="action-btn" ${canUpgradeDistrict('residential') ? '' : 'disabled'}>
                           Am√©liorer (${getDistrictUpgradeCost('residential').gold} or)
                       </button>
                   </div>
                   
                   <div class="card">
                       <h4>üè™ District Commercial</h4>
                       <p>Revenus: +${islandData.districts.commercial.income} or/min</p>
                       <p>Niveau: ${islandData.districts.commercial.level}</p>
                       <button onclick="upgradeDistrict('commercial')" class="action-btn" ${canUpgradeDistrict('commercial') ? '' : 'disabled'}>
                           Am√©liorer (${getDistrictUpgradeCost('commercial').gold} or)
                       </button>
                   </div>
                   
                   <div class="card">
                       <h4>üè≠ District Industriel</h4>
                       <p>Production: +${islandData.districts.industrial.production}% ressources</p>
                       <p>Niveau: ${islandData.districts.industrial.level}</p>
                       <button onclick="upgradeDistrict('industrial')" class="action-btn" ${canUpgradeDistrict('industrial') ? '' : 'disabled'}>
                           Am√©liorer (${getDistrictUpgradeCost('industrial').gold} or)
                       </button>
                   </div>
                   
                   <div class="card">
                       <h4>üõ°Ô∏è District Militaire</h4>
                       <p>D√©fense: ${islandData.districts.military.defense} points</p>
                       <p>Niveau: ${islandData.districts.military.level}</p>
                       <button onclick="upgradeDistrict('military')" class="action-btn" ${canUpgradeDistrict('military') ? '' : 'disabled'}>
                           Am√©liorer (${getDistrictUpgradeCost('military').gold} or)
                       </button>
                   </div>
               `;
               
               // Infrastructure de l'√Æle
               html += `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üõ§Ô∏è Infrastructure</h3>
                       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                           <div>
                               <h4>üõ£Ô∏è Routes (Niveau ${islandData.infrastructure.roads})</h4>
                               <p>R√©duit les co√ªts de transport de ${islandData.infrastructure.roads * 10}%</p>
                               <button onclick="upgradeInfrastructure('roads')" class="action-btn" ${canUpgradeInfrastructure('roads') ? '' : 'disabled'}>
                                   Am√©liorer (${getInfrastructureCost('roads').gold} or, ${getInfrastructureCost('roads').wood} bois)
                               </button>
                           </div>
                           <div>
                               <h4>‚öì Ports (Niveau ${islandData.infrastructure.ports})</h4>
                               <p>+${islandData.infrastructure.ports * 15}% revenus commerciaux</p>
                               <button onclick="upgradeInfrastructure('ports')" class="action-btn" ${canUpgradeInfrastructure('ports') ? '' : 'disabled'}>
                                   Am√©liorer (${getInfrastructureCost('ports').gold} or, ${getInfrastructureCost('ports').marble} marbre)
                               </button>
                           </div>
                           <div>
                               <h4>üè∞ D√©fenses (Niveau ${islandData.infrastructure.defenses})</h4>
                               <p>+${islandData.infrastructure.defenses * 20} points de d√©fense</p>
                               <button onclick="upgradeInfrastructure('defenses')" class="action-btn" ${canUpgradeInfrastructure('defenses') ? '' : 'disabled'}>
                                   Am√©liorer (${getInfrastructureCost('defenses').gold} or, ${getInfrastructureCost('defenses').sulfur} soufre)
                               </button>
                           </div>
                       </div>
                   </div>
               `;
               
               // Ressources naturelles de l'√Æle
               html += `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üåø Ressources Naturelles</h3>
                       <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
               `;
               
               islandData.naturalResources.forEach(resource => {
                   const resourceIcon = {
                       wood: 'üå≤', wine: 'üçá', marble: 'üèõÔ∏è', 
                       crystal: 'üíé', sulfur: 'üî•', gold: 'üí∞'
                   }[resource];
                   
                   html += `
                       <div style="background: var(--color-panel-light); padding: 0.75rem; border-radius: 0.5rem; text-align: center;">
                           <div style="font-size: 1.5rem;">${resourceIcon}</div>
                           <div style="font-size: 0.9rem; margin-top: 0.25rem;">${resource}</div>
                       </div>
                   `;
               });
               
               html += `
                       </div>
                       <p style="margin-top: 1rem; color: var(--color-text-muted); font-style: italic;">
                           Les ressources naturelles augmentent la production de base de ces ressources sur cette √Æle.
                       </p>
                   </div>
               `;
               
               dom.islandGrid.innerHTML = html;
           }

           function updateContextPanel(plotId) {
               if (window.innerWidth <= 900) return; // Ne pas utiliser sur mobile
               let html = '';
               if (!plotId) {
                   html = '<h3>Informations</h3><p>S√©lectionnez un √©l√©ment pour voir ses d√©tails.</p>';
               } else {
                   const building = gameState.buildings[plotId];
                   if (building && building.type) {
                       const { type, level } = building; const spec = config.buildings[type]; const nextLevel = level < spec.levels.length ? level + 1 : null;
                       html = `<h3>${type} (Niv ${level})</h3><p>${spec.description}</p>`;
                       if (gameState.queues.build.some(item => item.id === plotId)) { html += `<p style="color: var(--color-primary); margin-top: 1rem;">Am√©lioration en cours...</p>`; }
                       else if (isCooldownActive('build')) { html += `<button class="action-btn" disabled>Cooldown...</button>`; }
                       else if (nextLevel) { html += `<button class="action-btn" data-action="build" data-id="${plotId}" data-name="${type}" data-level="${nextLevel}">Am√©liorer</button>`; }
                       else { html += `<p style="color: var(--color-primary); margin-top: 1rem;">Niveau maximum</p>`; }
                   } else {

                       html = `<h3>Emplacement Vide</h3><p>Cliquez pour construire :</p><div style="display:flex; flex-direction:column; gap:0.5rem;">`;
                       for (const type in config.buildings) { html += isCooldownActive('build') ? `<button class="action-btn" disabled>${config.buildings[type].icon} ${type}</button>` : `<button class="action-btn" data-action="build" data-id="${plotId}" data-name="${type}" data-level="1">${config.buildings[type].icon} ${type}</button>`; }
                       html += `</div>`;

                   }
               }
               dom.contextPanel.innerHTML = html;

               const chooseBtn = dom.contextPanel.querySelector('#chooseBuildingBtn');
               if (chooseBtn) chooseBtn.addEventListener('click', () => showBuildSelection(plotId));

           }

           function showContextModalForBuilding(plotId) {
               const building = gameState.buildings[plotId];
               if (building && building.type) {
                    const { type, level } = building;
                    const spec = config.buildings[type];
                    const nextLevel = level < spec.levels.length ? level + 1 : null;
                    if(nextLevel && !gameState.queues.build.some(item => item.id === plotId)) {
                       showModal('build', plotId, type, nextLevel);
                    } else {
                       showModal(type, `Niveau ${level}. ${spec.description}`);
                    }
               } else {
                   showBuildSelection(plotId);
               }
           }

           function showBuildSelection(plotId) {
               // Cr√©er une modal simple pour la s√©lection de b√¢timents sur mobile
               let html = '<h4>Choisir un b√¢timent</h4><div class="build-select-grid">';
               for (const type in config.buildings) {
                   const spec = config.buildings[type];
                   const cost = Object.entries(spec.levels[0].cost).map(([res, val]) => `${res}: ${val}`).join(', ');
                   html += `<div class="build-option">
                       <div>${spec.icon}</div>
                       <div style="font-size: 0.8rem; margin: 0.25rem 0;">${type}</div>
                       <div class="cost">${cost}</div>
                       <button class="action-btn" data-action="build" data-id="${plotId}" data-name="${type}" data-level="1" style="font-size: 0.7rem; padding: 0.25rem;">Construire</button>
                   </div>`;
               }
               html += '</div>';
               
               dom.modalTitle.textContent = 'Construction';
               dom.modalMessage.innerHTML = html;
               dom.modalCost.innerHTML = '';
               dom.modalConfirmBtn.style.display = 'none';
               dom.modalCancelBtn.textContent = 'Fermer';
               dom.modal.style.display = 'flex';
           }
           
           // --- SYST√àME D'XP ET ACHIEVEMENTS ---
           function addXP(amount) {
               gameState.playerStats.xp += amount;
               const xpNeeded = gameState.playerStats.level * 100;
               if (gameState.playerStats.xp >= xpNeeded) {
                   const oldLevel = gameState.playerStats.level;
                   gameState.playerStats.level++;
                   gameState.playerStats.xp -= xpNeeded;
                   
                   // Notification de niveau
                   showLevelUpNotification(oldLevel, gameState.playerStats.level);
                   
                   // Bonus de niveau : +10% de production
                   Object.keys(gameState.resources).forEach(res => {
                       if (res !== 'research') {
                           const bonus = Math.floor(gameState.resources[res] * 0.1);
                           gameState.resources[res] += bonus;
                           if (bonus > 0) animateResourceGain(res);
                       }
                   });
               }
           }
           
           function showLevelUpNotification(oldLevel, newLevel) {
               const notification = document.createElement('div');
               notification.className = 'level-up-notification';
               notification.innerHTML = `
                   <div>üéâ NIVEAU SUP√âRIEUR ! üéâ</div>
                   <div>Niveau ${oldLevel} ‚Üí ${newLevel}</div>
                   <div style="font-size: 0.9rem; margin-top: 0.5rem;">Bonus de ressources accord√© !</div>
               `;
               document.body.appendChild(notification);
               
               setTimeout(() => {
                   notification.remove();
               }, 3000);
           }
           
           function showAchievementNotification(achievement) {
               const notification = document.createElement('div');
               notification.className = 'achievement-notification';
               notification.innerHTML = `
                   <div style="font-weight: bold;">üèÜ Achievement D√©bloqu√© !</div>
                   <div>${achievement.name}</div>
                   <div style="font-size: 0.8rem; opacity: 0.9;">${achievement.desc}</div>
               `;
               document.body.appendChild(notification);
               
               setTimeout(() => {
                   notification.remove();
               }, 4000);
           }
           
           function animateResourceGain(resourceType) {
               const element = document.getElementById(`res${resourceType.charAt(0).toUpperCase() + resourceType.slice(1)}`);
               if (element) {
                   element.parentElement.classList.add('resource-gain');
                   setTimeout(() => {
                       element.parentElement.classList.remove('resource-gain');
                   }, 1000);
               }
           }
           
           function checkAchievements() {
               const achievements = [
                   { id: 'builder1', name: 'Premier Constructeur', desc: 'Construire 5 b√¢timents', condition: () => gameState.playerStats.totalBuildings >= 5 },
                   { id: 'builder2', name: 'Architecte', desc: 'Construire 15 b√¢timents', condition: () => gameState.playerStats.totalBuildings >= 15 },
                   { id: 'builder3', name: 'Ma√Ætre B√¢tisseur', desc: 'Construire 30 b√¢timents', condition: () => gameState.playerStats.totalBuildings >= 30 },
                   { id: 'researcher1', name: '√ârudit', desc: 'Terminer 3 recherches', condition: () => gameState.researchCompleted.length >= 3 },
                   { id: 'researcher2', name: 'Savant', desc: 'Terminer 8 recherches', condition: () => gameState.researchCompleted.length >= 8 },
                   { id: 'military1', name: 'G√©n√©ral', desc: 'Recruter 20 unit√©s', condition: () => gameState.playerStats.totalUnits >= 20 },
                   { id: 'military2', name: 'Conqu√©rant', desc: 'Recruter 50 unit√©s', condition: () => gameState.playerStats.totalUnits >= 50 },
                   { id: 'rich1', name: 'Riche Marchand', desc: 'Poss√©der 10000 or', condition: () => gameState.resources.gold >= 10000 },
                   { id: 'rich2', name: 'Empereur Dor√©', desc: 'Poss√©der 50000 or', condition: () => gameState.resources.gold >= 50000 },
                   { id: 'explorer1', name: 'Explorateur', desc: 'Explorer 10 √Æles', condition: () => gameState.exploredIslands.length >= 10 },
                   { id: 'colonizer1', name: 'Colonisateur', desc: 'Coloniser 3 √Æles', condition: () => gameState.colonizedIslands.length >= 3 },
                   { id: 'level5', name: 'V√©t√©ran', desc: 'Atteindre le niveau 5', condition: () => gameState.playerStats.level >= 5 },
                   { id: 'level10', name: 'Expert', desc: 'Atteindre le niveau 10', condition: () => gameState.playerStats.level >= 10 }
               ];
               
               achievements.forEach(achievement => {
                   if (!gameState.achievements.includes(achievement.id) && achievement.condition()) {
                       gameState.achievements.push(achievement.id);
                       showAchievementNotification(achievement);
                       logEvent(`üèÜ Achievement d√©bloqu√© : ${achievement.name}`);
                       addXP(100);
                   }
               });
           }

           function renderResearchTree() {
               dom.researchGrid.innerHTML = '';
               for (const branchKey in config.research) {
                   const branch = config.research[branchKey]; let branchHtml = `<div class="card"><h3>${branch.name}</h3>`;
                   for (const techKey in branch.techs) {
                       const tech = branch.techs[techKey]; const isCompleted = gameState.researchCompleted.includes(techKey);
                       const isResearching = gameState.queues.research.some(t => t.name === techKey);
                       branchHtml += `<div class="card"><h4>${techKey}</h4><p>${tech.description}</p><p class="cost">Co√ªt: üî¨${tech.cost.research}</p>`;
                       if (isCompleted) { branchHtml += `<button class="action-btn" disabled>Termin√©</button>`; }
                       else if (isResearching) { branchHtml += `<button class="action-btn" disabled>En cours...</button>`; }
                       else if (isCooldownActive('research')) { branchHtml += `<button class="action-btn" disabled>Cooldown...</button>`; }
                       else { branchHtml += `<button class="action-btn" data-action="research" data-name="${techKey}" data-level="1">Rechercher</button>`; }
                       branchHtml += `</div>`;
                   }
                   branchHtml += `</div>`; dom.researchGrid.innerHTML += branchHtml;
               }
           }
           function renderMilitaryUnits() {
               dom.militaryGrid.innerHTML = '';
               for (const unitKey in config.units) {
                   const unit = config.units[unitKey]; const isRecruiting = gameState.queues.military.some(u => u.name === unitKey);
                   let html = `<div class="card"><h4>${unitKey} ${unit.icon}</h4><p>${unit.description}</p><p class="cost">Co√ªt: üå≤${unit.cost.wood || 0} üî•${unit.cost.sulfur || 0} üí∞${unit.cost.gold || 0}</p>`;
                   if (isRecruiting) { html += `<button class="action-btn" disabled>En formation...</button>`; }
                   else if (isCooldownActive('military')) { html += `<button class="action-btn" disabled>Cooldown...</button>`; }
                   else { html += `<button class="action-btn" data-action="military" data-name="${unitKey}" data-level="1">Recruter</button>`; }
                   html += `</div>`; dom.militaryGrid.innerHTML += html;
               }
           }
           function renderBattle() {
               dom.battleGrid.innerHTML = `
                   <div class="card">
                       <h3>Simulateur de Bataille</h3>
                       <p>Testez vos strat√©gies militaires !</p>
                       <div style="margin: 1rem 0;">
                           <h4>Votre Arm√©e</h4>
                           <div>Hoplites: <input type="number" id="attackerHoplites" value="10" min="0" max="100" style="width: 60px;"></div>
                           <div>Archers: <input type="number" id="attackerArchers" value="5" min="0" max="100" style="width: 60px;"></div>
                       </div>
                       <div style="margin: 1rem 0;">
                           <h4>Arm√©e Ennemie</h4>
                           <div>Hoplites: <input type="number" id="defenderHoplites" value="8" min="0" max="100" style="width: 60px;"></div>
                           <div>D√©fense Muraille: <input type="number" id="wallDefense" value="20" min="0" max="200" style="width: 60px;"></div>
                       </div>
                       <button class="action-btn" id="simulateBattleBtn">‚öîÔ∏è Lancer le Combat</button>
                       <div id="battleResult" class="battle-result" style="margin-top: 1rem; padding: 1rem; background: var(--color-panel-light); border-radius: 0.5rem;"></div>
                   </div>`;
               const btn = document.getElementById('simulateBattleBtn');
               if (btn) {
                   btn.addEventListener('click', () => {
                       const attackerHoplites = parseInt(document.getElementById('attackerHoplites').value) || 0;
                       const attackerArchers = parseInt(document.getElementById('attackerArchers').value) || 0;
                       const defenderHoplites = parseInt(document.getElementById('defenderHoplites').value) || 0;
                       const wallDef = parseInt(document.getElementById('wallDefense').value) || 0;
                       
                       const attacker = { 
                           units: [
                               { type: 'hoplite', count: attackerHoplites }, 
                               { type: 'archer', count: attackerArchers }
                           ].filter(u => u.count > 0),
                           resources: {} 
                       };
                       const defender = { 
                           units: [{ type: 'hoplite', count: defenderHoplites }].filter(u => u.count > 0), 
                           wallDefense: wallDef, 
                           resources: { wood: 100, gold: 150, wine: 50 } 
                       };
                       
                       const result = simulateBattle(attacker, defender);
                       const resultEl = document.getElementById('battleResult');
                       const lootText = Object.keys(result.loot).length ? Object.entries(result.loot).map(([r,v]) => `${r}: ${v}`).join(', ') : 'aucun';
                       
                       resultEl.innerHTML = `
                           <h4>R√©sultat du Combat</h4>
                           <p><strong>Vainqueur:</strong> ${result.winner === 'attacker' ? 'üéâ Vous' : 'üíÄ D√©fenseur'}</p>
                           <p><strong>Butin r√©cup√©r√©:</strong> ${lootText}</p>
                           <div style="margin-top: 0.5rem;">
                               <div><strong>Pertes Attaquant:</strong> ${result.casualties.attacker.map(c => `${c.lost} ${c.type}`).join(', ') || 'aucune'}</div>
                               <div><strong>Pertes D√©fenseur:</strong> ${result.casualties.defender.map(c => `${c.lost} ${c.type}`).join(', ') || 'aucune'}</div>
                           </div>
                       `;
                   });
               }
           }
           
           // Fonction de simulation de bataille am√©lior√©e
           function simulateBattle(attacker, defender) {
               const unitStats = {
                   hoplite: { attack: 10, defense: 20 },
                   archer: { attack: 8, defense: 10 }
               };
               
               let atkPower = attacker.units.reduce((total, unit) => 
                   total + (unitStats[unit.type]?.attack || 0) * unit.count, 0);
               let defPower = defender.units.reduce((total, unit) => 
                   total + (unitStats[unit.type]?.defense || 0) * unit.count, 0) + (defender.wallDefense || 0);
               
               const winner = atkPower > defPower ? "attacker" : "defender";
               
               // Calcul des pertes proportionnelles
               const totalPower = atkPower + defPower || 1;
               const atkLossRatio = Math.min(0.8, defPower / totalPower);
               const defLossRatio = Math.min(0.8, atkPower / totalPower);
               
               const attackerLosses = attacker.units.map(u => ({
                   type: u.type,
                   lost: Math.ceil(u.count * atkLossRatio * (0.5 + Math.random() * 0.5))
               }));
               
               const defenderLosses = defender.units.map(u => ({
                   type: u.type,
                   lost: Math.ceil(u.count * defLossRatio * (0.5 + Math.random() * 0.5))
               }));
               
               // Calcul du butin
               const loot = {};
               if (winner === "attacker") {
                   for (let [res, amt] of Object.entries(defender.resources || {})) {
                       loot[res] = Math.floor(amt * (0.3 + Math.random() * 0.4));
                   }
               }
               
               return {
                   winner,
                   loot,
                   casualties: { attacker: attackerLosses, defender: defenderLosses }
               };
           }
           function renderDiplomacy() {
               dom.diplomacyGrid.innerHTML = '';
               let html = '<div><h3>Alliances</h3>';
               for(const name in config.diplomacy.alliances) {
                   const ally = config.diplomacy.alliances[name];
                   html += `<div class="card"><h4>${name} [${ally.tag}]</h4><p>Membres: ${ally.members} | Points: ${ally.points}</p><button class="action-btn">Voir</button></div>`;
               }
               html += '</div><div><h3>Trait√©s</h3>';
               for(const name in config.diplomacy.treaties) {
                   const treaty = config.diplomacy.treaties[name];
                   html += `<div class="card"><h4>${name}</h4><p>${treaty.description}</p><button class="action-btn" data-action="diplomacy" data-name="${name}">Signer</button></div>`;
               }
               html += '</div>'; dom.diplomacyGrid.innerHTML += html;
           }
           
           function renderAchievements() {
               const achievementsGrid = document.getElementById('achievements-grid');
               if (!achievementsGrid) return;
               
               const allAchievements = [
                   { id: 'builder1', name: 'Premier Constructeur', desc: 'Construire 5 b√¢timents', icon: 'üèóÔ∏è' },
                   { id: 'builder2', name: 'Architecte', desc: 'Construire 15 b√¢timents', icon: 'üèõÔ∏è' },
                   { id: 'builder3', name: 'Ma√Ætre B√¢tisseur', desc: 'Construire 30 b√¢timents', icon: 'üè∞' },
                   { id: 'researcher1', name: '√ârudit', desc: 'Terminer 3 recherches', icon: 'üìö' },
                   { id: 'researcher2', name: 'Savant', desc: 'Terminer 8 recherches', icon: 'üß™' },
                   { id: 'military1', name: 'G√©n√©ral', desc: 'Recruter 20 unit√©s', icon: '‚öîÔ∏è' },
                   { id: 'military2', name: 'Conqu√©rant', desc: 'Recruter 50 unit√©s', icon: 'üëë' },
                   { id: 'rich1', name: 'Riche Marchand', desc: 'Poss√©der 10000 or', icon: 'üí∞' },
                   { id: 'rich2', name: 'Empereur Dor√©', desc: 'Poss√©der 50000 or', icon: 'üëë' },
                   { id: 'explorer1', name: 'Explorateur', desc: 'Explorer 10 √Æles', icon: 'üó∫Ô∏è' },
                   { id: 'colonizer1', name: 'Colonisateur', desc: 'Coloniser 3 √Æles', icon: 'üèùÔ∏è' },
                   { id: 'level5', name: 'V√©t√©ran', desc: 'Atteindre le niveau 5', icon: '‚≠ê' },
                   { id: 'level10', name: 'Expert', desc: 'Atteindre le niveau 10', icon: 'üåü' }
               ];
               
               let html = `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üìä Statistiques du Joueur</h3>
                       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                           <div><strong>Niveau:</strong> ${gameState.playerStats.level}</div>
                           <div><strong>XP:</strong> ${gameState.playerStats.xp}/${gameState.playerStats.level * 100}</div>
                           <div><strong>B√¢timents construits:</strong> ${gameState.playerStats.totalBuildings}</div>
                           <div><strong>Unit√©s recrut√©es:</strong> ${gameState.playerStats.totalUnits}</div>
                           <div><strong>Recherches termin√©es:</strong> ${gameState.researchCompleted.length}</div>
                           <div><strong>√éles explor√©es:</strong> ${gameState.exploredIslands.length}</div>
                           <div><strong>Colonies fond√©es:</strong> ${gameState.colonizedIslands.length}</div>
                           <div><strong>Achievements d√©bloqu√©s:</strong> ${gameState.achievements.length}/${allAchievements.length}</div>
                       </div>
                   </div>
               `;
               
               allAchievements.forEach(achievement => {
                   const isUnlocked = gameState.achievements.includes(achievement.id);
                   html += `
                       <div class="card ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'}" style="opacity: ${isUnlocked ? '1' : '0.6'}; border: 2px solid ${isUnlocked ? 'var(--color-success)' : 'var(--color-border)'};">
                           <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem;">${achievement.icon}</div>
                           <h4 style="color: ${isUnlocked ? 'var(--color-success)' : 'var(--color-text-muted)'};">${achievement.name}</h4>
                           <p>${achievement.desc}</p>
                           <div style="text-align: center; margin-top: 0.5rem;">
                               ${isUnlocked ? '<span style="color: var(--color-success); font-weight: bold;">‚úÖ D√âBLOQU√â</span>' : '<span style="color: var(--color-text-muted);">üîí Verrouill√©</span>'}
                           </div>
                       </div>
                   `;
               });
               
               achievementsGrid.innerHTML = html;
           }
           
           function renderQuests() {
               const questsGrid = document.getElementById('quests-grid');
               if (!questsGrid) return;
               
               let html = `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üìã Qu√™tes Actives (${gameState.activeQuests.length})</h3>
                       <div style="margin-top: 1rem;">
               `;
               
               if (gameState.activeQuests.length === 0) {
                   html += '<p style="color: var(--color-text-muted); font-style: italic;">Aucune qu√™te active pour le moment.</p>';
               } else {
                   gameState.activeQuests.forEach(quest => {
                       const progress = quest.condition() ? '‚úÖ Pr√™t √† terminer' : '‚è≥ En cours';
                       const rewardText = Object.entries(quest.reward)
                           .map(([res, amt]) => `${res}: ${amt}`)
                           .join(', ');
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid var(--color-primary);">
                               <h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary);">${quest.title}</h4>
                               <p style="margin: 0 0 0.5rem 0;">${quest.description}</p>
                               <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                                   <span style="color: var(--color-text-muted);">R√©compenses: ${rewardText}</span>
                                   <span style="font-weight: bold; color: ${quest.condition() ? 'var(--color-success)' : 'var(--color-warning)'};">${progress}</span>
                               </div>
                           </div>
                       `;
                   });
               }
               
               html += `
                       </div>
                   </div>
                   
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>‚úÖ Qu√™tes Termin√©es (${gameState.completedQuests.length})</h3>
                       <div style="margin-top: 1rem;">
               `;
               
               if (gameState.completedQuests.length === 0) {
                   html += '<p style="color: var(--color-text-muted); font-style: italic;">Aucune qu√™te termin√©e.</p>';
               } else {
                   const completedQuestDetails = gameState.completedQuests.map(questId => 
                       QUEST_TEMPLATES.find(template => template.id === questId)
                   ).filter(Boolean);
                   
                   completedQuestDetails.forEach(quest => {
                       html += `
                           <div style="background: var(--color-success); color: white; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; opacity: 0.8;">
                               <h4 style="margin: 0 0 0.25rem 0;">${quest.title}</h4>
                               <p style="margin: 0; font-size: 0.9rem;">${quest.description}</p>
                           </div>
                       `;
                   });
               }
               
               html += `
                       </div>
                   </div>
                   
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üé≤ √âv√©nements R√©cents (${gameState.eventHistory.length})</h3>
                       <div style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
               `;
               
               if (gameState.eventHistory.length === 0) {
                   html += '<p style="color: var(--color-text-muted); font-style: italic;">Aucun √©v√©nement r√©cent.</p>';
               } else {
                   // Afficher les √©v√©nements du plus r√©cent au plus ancien
                   const sortedEvents = [...gameState.eventHistory].reverse();
                   sortedEvents.forEach(event => {
                       const timeAgo = Math.floor((Date.now() - event.timestamp) / 60000);
                       const timeText = timeAgo < 1 ? '√Ä l\'instant' : `Il y a ${timeAgo} min`;
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid #8b5cf6;">
                               <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem;">
                                   <h4 style="margin: 0; color: #8b5cf6;">${event.title}</h4>
                                   <span style="font-size: 0.8rem; color: var(--color-text-muted);">${timeText}</span>
                               </div>
                               <p style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">${event.description}</p>
                               <p style="margin: 0; font-size: 0.9rem; font-weight: bold; color: var(--color-primary);">${event.result}</p>
                           </div>
                       `;
                   });
               }
               
               html += `
                       </div>
                   </div>
               `;
               
               questsGrid.innerHTML = html;
           }
           
           function renderTrade() {
               const tradeGrid = document.getElementById('trade-grid');
               if (!tradeGrid) return;
               
               // Taux de change dynamiques bas√©s sur les ressources du joueur
               const exchangeRates = {
                   wood: { gold: 2, wine: 0.5, marble: 0.8, crystal: 0.3, sulfur: 0.4 },
                   wine: { gold: 8, wood: 2, marble: 1.5, crystal: 0.8, sulfur: 1 },
                   marble: { gold: 5, wood: 1.2, wine: 0.7, crystal: 0.6, sulfur: 0.8 },
                   crystal: { gold: 15, wood: 3, wine: 1.2, marble: 1.8, sulfur: 2 },
                   sulfur: { gold: 12, wood: 2.5, wine: 1, marble: 1.2, crystal: 0.5 },
                   gold: { wood: 0.4, wine: 0.1, marble: 0.15, crystal: 0.05, sulfur: 0.07 }
               };
               
               let html = `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üí± March√© des Ressources</h3>
                       <p>√âchangez vos ressources selon les taux du march√©. Les prix fluctuent selon l'offre et la demande.</p>
                   </div>
               `;
               
               // Cr√©er les cartes d'√©change pour chaque ressource
               Object.keys(exchangeRates).forEach(fromResource => {
                   if (fromResource === 'research') return; // Pas d'√©change pour la recherche
                   
                   const playerAmount = Math.floor(gameState.resources[fromResource] || 0);
                   const resourceIcon = {
                       wood: 'üå≤', wine: 'üçá', marble: 'üèõÔ∏è', 
                       crystal: 'üíé', sulfur: 'üî•', gold: 'üí∞'
                   }[fromResource];
                   
                   html += `
                       <div class="card">
                           <h4>${resourceIcon} ${fromResource.charAt(0).toUpperCase() + fromResource.slice(1)}</h4>
                           <p>Disponible: <strong>${playerAmount}</strong></p>
                           <div style="margin-top: 1rem;">
                   `;
                   
                   Object.entries(exchangeRates[fromResource]).forEach(([toResource, rate]) => {
                       const toIcon = {
                           wood: 'üå≤', wine: 'üçá', marble: 'üèõÔ∏è', 
                           crystal: 'üíé', sulfur: 'üî•', gold: 'üí∞'
                       }[toResource];
                       
                       html += `
                           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--color-panel-light); border-radius: 0.25rem;">
                               <span>1 ‚Üí ${rate} ${toIcon}</span>
                               <div>
                                   <input type="number" id="trade-${fromResource}-${toResource}" min="1" max="${playerAmount}" value="1" style="width: 60px; margin-right: 0.5rem;">
                                   <button onclick="executeTrade('${fromResource}', '${toResource}', ${rate})" class="action-btn" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" ${playerAmount < 1 ? 'disabled' : ''}>
                                       √âchanger
                                   </button>
                               </div>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               });
               
               // Ajouter une section pour les offres sp√©ciales
               html += `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üéØ Offres Sp√©ciales du Jour</h3>
                       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
               `;
               
               const specialOffers = [
                   {
                       name: "Pack du Constructeur",
                       description: "Parfait pour vos projets de construction",
                       cost: { gold: 1000 },
                       reward: { wood: 500, marble: 200, crystal: 100 },
                       available: gameState.resources.gold >= 1000
                   },
                   {
                       name: "Pack du Chercheur",
                       description: "Acc√©l√©rez vos recherches",
                       cost: { gold: 1500, wine: 100 },
                       reward: { research: 800, crystal: 300 },
                       available: gameState.resources.gold >= 1500 && gameState.resources.wine >= 100
                   },
                   {
                       name: "Pack Militaire",
                       description: "√âquipez votre arm√©e",
                       cost: { gold: 800, wood: 200 },
                       reward: { sulfur: 400, crystal: 150 },
                       available: gameState.resources.gold >= 800 && gameState.resources.wood >= 200
                   }
               ];
               
               specialOffers.forEach((offer, index) => {
                   const costText = Object.entries(offer.cost).map(([res, amt]) => `${amt} ${res}`).join(', ');
                   const rewardText = Object.entries(offer.reward).map(([res, amt]) => `${amt} ${res}`).join(', ');
                   
                   html += `
                       <div style="background: ${offer.available ? 'var(--color-panel-light)' : 'var(--color-panel)'}; padding: 1rem; border-radius: 0.5rem; border: 2px solid ${offer.available ? 'var(--color-success)' : 'var(--color-border)'}; opacity: ${offer.available ? '1' : '0.6'};">
                           <h4 style="margin: 0 0 0.5rem 0; color: ${offer.available ? 'var(--color-success)' : 'var(--color-text-muted)'};">${offer.name}</h4>
                           <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">${offer.description}</p>
                           <div style="margin-bottom: 0.5rem;">
                               <div><strong>Co√ªt:</strong> ${costText}</div>
                               <div><strong>Contenu:</strong> ${rewardText}</div>
                           </div>
                           <button onclick="buySpecialOffer(${index})" class="action-btn" style="width: 100%;" ${!offer.available ? 'disabled' : ''}>
                               ${offer.available ? 'Acheter' : 'Indisponible'}
                           </button>
                       </div>
                   `;
               });
               
               html += `
                       </div>
                   </div>
               `;
               
               tradeGrid.innerHTML = html;
           }
           
           function executeTrade(fromResource, toResource, rate) {
               const inputId = `trade-${fromResource}-${toResource}`;
               const amount = parseInt(document.getElementById(inputId)?.value || 1);
               
               if (amount <= 0 || gameState.resources[fromResource] < amount) {
                   logEvent('‚ùå Ressources insuffisantes pour cet √©change');
                   return;
               }
               
               const received = Math.floor(amount * rate);
               gameState.resources[fromResource] -= amount;
               gameState.resources[toResource] = (gameState.resources[toResource] || 0) + received;
               
               animateResourceGain(toResource);
               logEvent(`üí± √âchange r√©ussi : ${amount} ${fromResource} ‚Üí ${received} ${toResource}`);
               addXP(Math.floor(amount / 10));
               
               renderTrade();
               updateAllUI();
               saveState();
           }
           
           function buySpecialOffer(offerIndex) {
               const specialOffers = [
                   {
                       name: "Pack du Constructeur",
                       cost: { gold: 1000 },
                       reward: { wood: 500, marble: 200, crystal: 100 }
                   },
                   {
                       name: "Pack du Chercheur",
                       cost: { gold: 1500, wine: 100 },
                       reward: { research: 800, crystal: 300 }
                   },
                   {
                       name: "Pack Militaire",
                       cost: { gold: 800, wood: 200 },
                       reward: { sulfur: 400, crystal: 150 }
                   }
               ];
               
               const offer = specialOffers[offerIndex];
               if (!offer) return;
               
               // V√©rifier si le joueur a assez de ressources
               for (const [resource, cost] of Object.entries(offer.cost)) {
                   if (gameState.resources[resource] < cost) {
                       logEvent(`‚ùå Ressources insuffisantes pour ${offer.name}`);
                       return;
                   }
               }
               
               // D√©duire le co√ªt
               Object.entries(offer.cost).forEach(([resource, cost]) => {
                   gameState.resources[resource] -= cost;
               });
               
               // Donner les r√©compenses
               Object.entries(offer.reward).forEach(([resource, reward]) => {
                   gameState.resources[resource] = (gameState.resources[resource] || 0) + reward;
                   animateResourceGain(resource);
               });
               
               const rewardText = Object.entries(offer.reward).map(([res, amt]) => `${amt} ${res}`).join(', ');
               logEvent(`üéØ ${offer.name} achet√© ! Re√ßu : ${rewardText}`);
               addXP(50);
               
               renderTrade();
               updateAllUI();
               saveState();
           }
           function updateQueueUI() {
               if (window.innerWidth <= 900) { dom.queueList.innerHTML = ''; return; } // Pas de liste sur mobile
               dom.queueList.innerHTML = '';
               ['build', 'research', 'military'].forEach(qType => {
                   gameState.queues[qType].forEach(item => {
                       const remainingTime = Math.max(0, Math.ceil((item.endTime - Date.now()) / 1000));
                       const li = document.createElement('li'); li.className = 'queue-item';
                       li.innerHTML = `<div class="name">${item.name} ${item.level ? `(Niv. ${item.level})` : ''}</div><div class="timer">${new Date(remainingTime * 1000).toISOString().substr(14, 5)}</div>`;
                       dom.queueList.appendChild(li);
                   });
               });
           }
           function updateActionAvailability() {
               document.querySelectorAll('button[data-action]').forEach(btn => {
                   const action = btn.dataset.action;
                   const name = btn.dataset.name;
                   const level = parseInt(btn.dataset.level) || 1;
                   let spec, cost;
                   if (action === 'build') { spec = config.buildings[name]?.levels[level - 1]; }
                   else if (action === 'research') {
                       const branch = Object.values(config.research).find(br => br.techs[name]);
                       spec = branch?.techs[name];
                   }
                   else if (action === 'military') { spec = config.units[name]; }
                   else if (action === 'diplomacy') { spec = config.diplomacy.treaties[name]; }
                   cost = spec?.cost;
                   if (cost) {
                       const enough = Object.entries(cost).every(([res, val]) => (gameState.resources[res] || 0) >= val);
                       btn.disabled = !enough;
                   }
               });
           }
           function showModal(action, id, name, level) {
               let spec, cost, time, title, message;
               if (action === 'build') { spec = config.buildings[name].levels[level - 1]; title = `${level > 1 ? 'Am√©liorer' : 'Construire'} ${name}`; currentAction = () => startAction(action, id, name, level); }
               else if (action === 'research') { const branch = Object.keys(config.research).find(br => config.research[br].techs[name]); spec = config.research[branch].techs[name]; title = `Rechercher ${name}`; currentAction = () => startAction(action, id, name, level); }
               else if (action === 'military') { spec = config.units[name]; title = `Recruter ${name}`; currentAction = () => startAction(action, id, name, level); }
               else if (config.worldActions && config.worldActions[action]) { spec = config.worldActions[action]; title = `${spec.label} ${name}`; currentAction = () => startWorldAction(action, id, name); }
               else if (typeof action === 'string') { // For simple messages
                   dom.modalTitle.textContent = action;
                   dom.modalMessage.textContent = id || '';
                   dom.modalCost.innerHTML = '';
                   currentAction = null;
                   dom.modalConfirmBtn.style.display = 'none';
                   dom.modalCancelBtn.textContent = 'Fermer';
                   dom.modal.style.display = 'flex';
                   return;
               }
               else { showModal("Action inconnue", "Cette action n'est pas encore impl√©ment√©e."); return; }

               message = spec.description || `Voulez-vous vraiment lancer cette action ?`;
               cost = spec.cost; time = spec.buildTime || spec.time;
               dom.modalTitle.textContent = title; dom.modalMessage.textContent = message;
               const costText = Object.entries(cost || {}).map(([res, val]) => `${res}: ${val}`).join(', ');
               dom.modalCost.innerHTML = `Co√ªt: ${costText}${time ? ` - Temps: ${time}s` : ''}`;
               dom.modalConfirmBtn.style.display = 'inline-block';
               dom.modalCancelBtn.textContent = 'Annuler';
               dom.modal.style.display = 'flex';
           }
           function logEvent(message) { dom.eventLog.textContent = message; }

           // --- EVENT LISTENERS ---
           document.body.addEventListener('click', e => {
               const target = e.target.closest('button[data-action]');
               if (!target) return;
               const { action, id, name, level } = target.dataset;
               if (isCooldownActive(action)) { showModal('Action en cooldown', 'Veuillez patienter avant de relancer cette action.'); return; }
               showModal(action, id, name, parseInt(level));
           });
           dom.modalConfirmBtn.addEventListener('click', () => { if (currentAction) currentAction(); dom.modal.style.display = 'none'; });
           dom.modalCancelBtn.addEventListener('click', () => { dom.modal.style.display = 'none'; });

           // --- SYST√àME DE QU√äTES ---
           const QUEST_TEMPLATES = [
               {
                   id: 'first_building',
                   title: 'Premier B√¢timent',
                   description: 'Construisez votre premier b√¢timent de production',
                   condition: () => Object.values(gameState.buildings).filter(b => b.type && b.type !== 'H√¥tel de Ville' && b.type !== 'Acad√©mie' && b.type !== 'Caserne').length >= 1,
                   reward: { gold: 500, xp: 50 },
                   autoStart: true
               },
               {
                   id: 'reach_level_3',
                   title: 'Mont√©e en Puissance',
                   description: 'Atteignez le niveau 3',
                   condition: () => gameState.playerStats.level >= 3,
                   reward: { gold: 1000, wood: 200, xp: 100 },
                   autoStart: true
               },
               {
                   id: 'build_5_buildings',
                   title: 'Expansion Urbaine',
                   description: 'Construisez 5 b√¢timents au total',
                   condition: () => gameState.playerStats.totalBuildings >= 5,
                   reward: { gold: 1500, marble: 100, xp: 150 },
                   autoStart: true
               },
               {
                   id: 'first_research',
                   title: 'Premi√®re D√©couverte',
                   description: 'Terminez votre premi√®re recherche',
                   condition: () => gameState.researchCompleted.length >= 1,
                   reward: { research: 200, crystal: 50, xp: 100 },
                   autoStart: true
               },
               {
                   id: 'recruit_army',
                   title: 'Lever une Arm√©e',
                   description: 'Recrutez 10 unit√©s militaires',
                   condition: () => gameState.playerStats.totalUnits >= 10,
                   reward: { gold: 800, sulfur: 100, xp: 120 },
                   autoStart: true
               },
               {
                   id: 'explore_islands',
                   title: 'Grand Explorateur',
                   description: 'Explorez 5 √Æles diff√©rentes',
                   condition: () => gameState.exploredIslands.length >= 5,
                   reward: { gold: 2000, wine: 150, xp: 200 },
                   autoStart: true
               }
           ];

           function processQuests() {
               // D√©marrer automatiquement les nouvelles qu√™tes
               QUEST_TEMPLATES.forEach(template => {
                   if (template.autoStart && 
                       !gameState.activeQuests.find(q => q.id === template.id) &&
                       !gameState.completedQuests.includes(template.id)) {
                       gameState.activeQuests.push({
                           ...template,
                           startTime: Date.now()
                       });
                       logEvent(`üìã Nouvelle qu√™te : ${template.title}`);
                   }
               });

               // V√©rifier les qu√™tes actives
               gameState.activeQuests.forEach((quest, index) => {
                   if (quest.condition()) {
                       completeQuest(quest, index);
                   }
               });
           }

           function completeQuest(quest, index) {
               gameState.activeQuests.splice(index, 1);
               gameState.completedQuests.push(quest.id);
               
               // Donner les r√©compenses
               Object.entries(quest.reward).forEach(([resource, amount]) => {
                   if (resource === 'xp') {
                       addXP(amount);
                   } else {
                       gameState.resources[resource] = (gameState.resources[resource] || 0) + amount;
                       animateResourceGain(resource);
                   }
               });

               const rewardText = Object.entries(quest.reward)
                   .map(([res, amt]) => `${res}: +${amt}`)
                   .join(', ');
               
               logEvent(`‚úÖ Qu√™te termin√©e : ${quest.title} | R√©compenses : ${rewardText}`);
               
               // Notification visuelle
               showQuestCompleteNotification(quest);
           }

           function showQuestCompleteNotification(quest) {
               const notification = document.createElement('div');
               notification.className = 'achievement-notification';
               notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
               notification.innerHTML = `
                   <div style="font-weight: bold;">üìã Qu√™te Termin√©e !</div>
                   <div>${quest.title}</div>
                   <div style="font-size: 0.8rem; opacity: 0.9;">R√©compenses obtenues</div>
               `;
               document.body.appendChild(notification);
               
               setTimeout(() => {
                   notification.remove();
               }, 4000);
           }

           // --- SYST√àME D'√âV√âNEMENTS AL√âATOIRES ---
           const RANDOM_EVENTS = [
               {
                   id: 'merchant_visit',
                   title: 'Visite de Marchands',
                   description: 'Des marchands proposent un √©change avantageux',
                   probability: 0.02,
                   minLevel: 2,
                   effect: () => {
                       const bonus = Math.floor(gameState.resources.gold * 0.15);
                       gameState.resources.gold += bonus;
                       return `Vous gagnez ${bonus} or suppl√©mentaire !`;
                   }
               },
               {
                   id: 'good_harvest',
                   title: 'Bonne R√©colte',
                   description: 'Vos fermiers rapportent une r√©colte exceptionnelle',
                   probability: 0.015,
                   minLevel: 1,
                   effect: () => {
                       const woodBonus = Math.floor(Math.random() * 200) + 100;
                       const wineBonus = Math.floor(Math.random() * 50) + 25;
                       gameState.resources.wood += woodBonus;
                       gameState.resources.wine += wineBonus;
                       animateResourceGain('wood');
                       animateResourceGain('wine');
                       return `+${woodBonus} bois, +${wineBonus} vin`;
                   }
               },
               {
                   id: 'discovery',
                   title: 'D√©couverte Arch√©ologique',
                   description: 'Vos ouvriers d√©couvrent des artefacts anciens',
                   probability: 0.01,
                   minLevel: 3,
                   effect: () => {
                       const crystalBonus = Math.floor(Math.random() * 100) + 50;
                       const researchBonus = Math.floor(Math.random() * 150) + 75;
                       gameState.resources.crystal += crystalBonus;
                       gameState.resources.research += researchBonus;
                       animateResourceGain('crystal');
                       animateResourceGain('research');
                       return `+${crystalBonus} cristal, +${researchBonus} recherche`;
                   }
               },
               {
                   id: 'festival',
                   title: 'Festival Populaire',
                   description: 'Votre peuple organise une grande f√™te',
                   probability: 0.008,
                   minLevel: 4,
                   effect: () => {
                       const xpBonus = Math.floor(Math.random() * 100) + 50;
                       addXP(xpBonus);
                       return `+${xpBonus} XP pour votre leadership !`;
                   }
               },
               {
                   id: 'storm',
                   title: 'Temp√™te',
                   description: 'Une temp√™te endommage vos structures',
                   probability: 0.005,
                   minLevel: 2,
                   effect: () => {
                       const woodLoss = Math.floor(gameState.resources.wood * 0.1);
                       const goldLoss = Math.floor(gameState.resources.gold * 0.05);
                       gameState.resources.wood = Math.max(0, gameState.resources.wood - woodLoss);
                       gameState.resources.gold = Math.max(0, gameState.resources.gold - goldLoss);
                       return `Vous perdez ${woodLoss} bois et ${goldLoss} or`;
                   }
               }
           ];

           function checkRandomEvents() {
               const now = Date.now();
               // V√©rifier un √©v√©nement maximum toutes les 2 minutes
               if (now - gameState.lastEventTime < 120000) return;

               RANDOM_EVENTS.forEach(event => {
                   if (gameState.playerStats.level >= event.minLevel && Math.random() < event.probability) {
                       triggerRandomEvent(event);
                       gameState.lastEventTime = now;
                   }
               });
           }

           function triggerRandomEvent(event) {
               const result = event.effect();
               logEvent(`üé≤ ${event.title} : ${result}`);
               
               gameState.eventHistory.push({
                   ...event,
                   timestamp: Date.now(),
                   result: result
               });

               // Garder seulement les 20 derniers √©v√©nements
               if (gameState.eventHistory.length > 20) {
                   gameState.eventHistory = gameState.eventHistory.slice(-20);
               }

               showEventNotification(event, result);
           }

           function showEventNotification(event, result) {
               const notification = document.createElement('div');
               notification.className = 'achievement-notification';
               notification.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
               notification.innerHTML = `
                   <div style="font-weight: bold;">üé≤ ${event.title}</div>
                   <div style="font-size: 0.9rem; margin: 0.25rem 0;">${event.description}</div>
                   <div style="font-size: 0.8rem; opacity: 0.9;">${result}</div>
               `;
               document.body.appendChild(notification);
               
               setTimeout(() => {
                   notification.remove();
               }, 5000);
           }

           // --- FONCTIONS UTILITAIRES POUR LES √éLES ---
           function createDefaultIslandData(island) {
               const climates = ['temperate', 'tropical', 'arid', 'arctic', 'volcanic'];
               const terrainTypes = [
                   ['plains', 'forest', 'hills'],
                   ['jungle', 'beach', 'volcano'],
                   ['desert', 'oasis', 'canyon'],
                   ['tundra', 'glacier', 'mountain'],
                   ['lava', 'ash', 'crater']
               ];
               
               const climate = climates[Math.floor(Math.random() * climates.length)];
               const terrain = terrainTypes[climates.indexOf(climate)];
               
               const resourcePools = {
                   temperate: ['wood', 'wine', 'marble'],
                   tropical: ['wood', 'wine', 'crystal'],
                   arid: ['marble', 'crystal', 'sulfur'],
                   arctic: ['crystal', 'marble', 'gold'],
                   volcanic: ['sulfur', 'crystal', 'gold']
               };
               
               const naturalResources = resourcePools[climate] || ['wood', 'wine'];
               
               const islandData = {
                   name: island.name || generateIslandName(),
                   type: island.type || 'colony',
                   climate: climate,
                   terrain: terrain,
                   naturalResources: naturalResources,
                   population: island.population || 500,
                   happiness: 70,
                   development: 1,
                   infrastructure: { roads: 1, ports: 1, defenses: 1 },
                   specialBuildings: [],
                   districts: {
                       residential: { level: 1, population: 200 },
                       commercial: { level: 1, income: 25 },
                       industrial: { level: 1, production: 15 },
                       military: { level: 1, defense: 10 }
                   }
               };
               
               const key = `${island.x}-${island.y}`;
               gameState.islandDetails[key] = islandData;
               return islandData;
           }
           
           function generateIslandName() {
               const prefixes = ['√éle', 'Atoll', 'Archipel', 'Terre'];
               const suffixes = ['Dor√©e', 'Myst√©rieuse', 'Fertile', 'Rocheuse', 'Verdoyante', 'Sauvage', 'Paisible', 'Lointaine'];
               const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
               const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
               return `${prefix} ${suffix}`;
           }
           
           function getClimateIcon(climate) {
               const icons = {
                   temperate: 'üå§Ô∏è',
                   tropical: 'üå¥',
                   arid: 'üèúÔ∏è',
                   arctic: '‚ùÑÔ∏è',
                   volcanic: 'üåã'
               };
               return icons[climate] || 'üå§Ô∏è';
           }
           
           function getTerrainForTile(x, y, islandData) {
               // G√©n√©ration proc√©durale du terrain bas√©e sur la position
               const seed = x * 7 + y * 13 + islandData.climate.length;
               const terrainIndex = seed % islandData.terrain.length;
               return islandData.terrain[terrainIndex];
           }
           
           function getTerrainIcon(terrain) {
               const icons = {
                   plains: 'üåæ', forest: 'üå≤', hills: '‚õ∞Ô∏è', jungle: 'üåø',
                   beach: 'üèñÔ∏è', volcano: 'üåã', desert: 'üèúÔ∏è', oasis: 'üèùÔ∏è',
                   canyon: 'üèîÔ∏è', tundra: 'üèîÔ∏è', glacier: 'üßä', mountain: '‚õ∞Ô∏è',
                   lava: 'üåã', ash: 'üå´Ô∏è', crater: 'üï≥Ô∏è', coast: 'üåä'
               };
               return icons[terrain] || 'üåæ';
           }
           
           function getTerrainName(terrain) {
               const names = {
                   plains: 'Plaines', forest: 'For√™t', hills: 'Collines', jungle: 'Jungle',
                   beach: 'Plage', volcano: 'Volcan', desert: 'D√©sert', oasis: 'Oasis',
                   canyon: 'Canyon', tundra: 'Toundra', glacier: 'Glacier', mountain: 'Montagne',
                   lava: 'Lave', ash: 'Cendres', crater: 'Crat√®re', coast: 'C√¥te'
               };
               return names[terrain] || 'Terrain';
           }
           
           function getBuildingOnTile(x, y) {
               // V√©rifier s'il y a un b√¢timent sur cette case
               const isCenter = (x === 2 || x === 3) && (y === 2 || y === 3);
               if (isCenter) {
                   return 'Centre-ville';
               }
               return null;
           }
           
           function selectTile(x, y) {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               const terrain = getTerrainForTile(x, y, islandData);
               const building = getBuildingOnTile(x, y);
               
               let actions = [];
               if (!building && terrain !== 'coast' && terrain !== 'lava') {
                   actions.push(`<button onclick="buildOnTile(${x}, ${y})" class="action-btn">Construire ici</button>`);
               }
               if (terrain === 'forest') {
                   actions.push(`<button onclick="harvestResource(${x}, ${y}, 'wood')" class="action-btn">R√©colter Bois</button>`);
               }
               if (terrain === 'hills' || terrain === 'mountain') {
                   actions.push(`<button onclick="harvestResource(${x}, ${y}, 'marble')" class="action-btn">Extraire Marbre</button>`);
               }
               
               showModal(
                   `Case [${x},${y}] - ${getTerrainName(terrain)}`,
                   `Terrain: ${getTerrainName(terrain)}<br>
                    ${building ? `B√¢timent: ${building}<br>` : ''}
                    ${actions.length > 0 ? actions.join('<br>') : 'Aucune action disponible'}`
               );
           }
           
           function buildOnTile(x, y) {
               // Syst√®me de construction sur les cases sp√©cifiques
               const buildingOptions = [
                   { name: 'Ferme', cost: { wood: 100, gold: 50 }, effect: 'Production +10 nourriture' },
                   { name: 'Mine', cost: { wood: 150, gold: 100 }, effect: 'Production +15 minerai' },
                   { name: 'Scierie', cost: { wood: 80, gold: 40 }, effect: 'Production +20% bois' },
                   { name: 'Avant-poste', cost: { wood: 200, sulfur: 50 }, effect: 'D√©fense +25 points' }
               ];
               
               let html = 'Choisissez un b√¢timent √† construire :<br><br>';
               buildingOptions.forEach((building, index) => {
                   const canAfford = Object.entries(building.cost).every(([res, cost]) => gameState.resources[res] >= cost);
                   const costText = Object.entries(building.cost).map(([res, cost]) => `${cost} ${res}`).join(', ');
                   
                   html += `
                       <div style="margin-bottom: 1rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 0.25rem; ${canAfford ? '' : 'opacity: 0.5;'}">
                           <strong>${building.name}</strong><br>
                           Co√ªt: ${costText}<br>
                           Effet: ${building.effect}<br>
                           <button onclick="constructBuilding(${x}, ${y}, ${index})" class="action-btn" ${canAfford ? '' : 'disabled'}>
                               Construire
                           </button>
                       </div>
                   `;
               });
               
               showModal(`Construction sur [${x},${y}]`, html);
           }
           
           function constructBuilding(x, y, buildingIndex) {
               const buildingOptions = [
                   { name: 'Ferme', cost: { wood: 100, gold: 50 }, effect: 'Production +10 nourriture' },
                   { name: 'Mine', cost: { wood: 150, gold: 100 }, effect: 'Production +15 minerai' },
                   { name: 'Scierie', cost: { wood: 80, gold: 40 }, effect: 'Production +20% bois' },
                   { name: 'Avant-poste', cost: { wood: 200, sulfur: 50 }, effect: 'D√©fense +25 points' }
               ];
               
               const building = buildingOptions[buildingIndex];
               
               // V√©rifier les ressources
               for (const [resource, cost] of Object.entries(building.cost)) {
                   if (gameState.resources[resource] < cost) {
                       logEvent(`‚ùå Ressources insuffisantes pour construire ${building.name}`);
                       return;
                   }
               }
               
               // D√©duire les co√ªts
               Object.entries(building.cost).forEach(([resource, cost]) => {
                   gameState.resources[resource] -= cost;
               });
               
               // Ajouter le b√¢timent aux b√¢timents sp√©ciaux de l'√Æle
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               islandData.specialBuildings.push({
                   name: building.name,
                   x: x,
                   y: y,
                   effect: building.effect
               });
               
               logEvent(`üèóÔ∏è ${building.name} construite sur [${x},${y}]`);
               addXP(25);
               gameState.playerStats.totalBuildings++;
               
               dom.modal.style.display = 'none';
               renderIslandView();
               updateAllUI();
               saveState();
           }
           
           function harvestResource(x, y, resourceType) {
               const amount = Math.floor(Math.random() * 50) + 25;
               gameState.resources[resourceType] = (gameState.resources[resourceType] || 0) + amount;
               
               animateResourceGain(resourceType);
               logEvent(`‚õèÔ∏è R√©colt√© ${amount} ${resourceType} sur [${x},${y}]`);
               addXP(10);
               
               dom.modal.style.display = 'none';
               updateAllUI();
               saveState();
           }
           
           // --- FONCTIONS POUR LES DISTRICTS ET INFRASTRUCTURE ---
           function getDistrictUpgradeCost(districtType) {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               const currentLevel = islandData.districts[districtType].level;
               
               const baseCosts = {
                   residential: { gold: 500 },
                   commercial: { gold: 800 },
                   industrial: { gold: 1000 },
                   military: { gold: 1200 }
               };
               
               const cost = {};
               Object.entries(baseCosts[districtType]).forEach(([resource, amount]) => {
                   cost[resource] = amount * currentLevel;
               });
               
               return cost;
           }
           
           function canUpgradeDistrict(districtType) {
               const cost = getDistrictUpgradeCost(districtType);
               return Object.entries(cost).every(([resource, amount]) => gameState.resources[resource] >= amount);
           }
           
           function upgradeDistrict(districtType) {
               const cost = getDistrictUpgradeCost(districtType);
               
               // V√©rifier les ressources
               for (const [resource, amount] of Object.entries(cost)) {
                   if (gameState.resources[resource] < amount) {
                       logEvent(`‚ùå Ressources insuffisantes pour am√©liorer le district ${districtType}`);
                       return;
                   }
               }
               
               // D√©duire les co√ªts
               Object.entries(cost).forEach(([resource, amount]) => {
                   gameState.resources[resource] -= amount;
               });
               
               // Am√©liorer le district
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               const district = islandData.districts[districtType];
               
               district.level++;
               
               // Appliquer les bonus
               switch (districtType) {
                   case 'residential':
                       district.population += 200;
                       islandData.population += 200;
                       break;
                   case 'commercial':
                       district.income += 25;
                       break;
                   case 'industrial':
                       district.production += 15;
                       break;
                   case 'military':
                       district.defense += 15;
                       break;
               }
               
               logEvent(`üèóÔ∏è District ${districtType} am√©lior√© au niveau ${district.level}`);
               addXP(50);
               
               renderIslandView();
               updateAllUI();
               saveState();
           }
           
           function getInfrastructureCost(infraType) {
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               const currentLevel = islandData.infrastructure[infraType];
               
               const baseCosts = {
                   roads: { gold: 300, wood: 200 },
                   ports: { gold: 500, marble: 150 },
                   defenses: { gold: 800, sulfur: 100 }
               };
               
               const cost = {};
               Object.entries(baseCosts[infraType]).forEach(([resource, amount]) => {
                   cost[resource] = amount * currentLevel;
               });
               
               return cost;
           }
           
           function canUpgradeInfrastructure(infraType) {
               const cost = getInfrastructureCost(infraType);
               return Object.entries(cost).every(([resource, amount]) => gameState.resources[resource] >= amount);
           }
           
           function upgradeInfrastructure(infraType) {
               const cost = getInfrastructureCost(infraType);
               
               // V√©rifier les ressources
               for (const [resource, amount] of Object.entries(cost)) {
                   if (gameState.resources[resource] < amount) {
                       logEvent(`‚ùå Ressources insuffisantes pour am√©liorer ${infraType}`);
                       return;
                   }
               }
               
               // D√©duire les co√ªts
               Object.entries(cost).forEach(([resource, amount]) => {
                   gameState.resources[resource] -= amount;
               });
               
               // Am√©liorer l'infrastructure
               const currentIslandKey = `${gameState.currentIsland.x}-${gameState.currentIsland.y}`;
               const islandData = gameState.islandDetails[currentIslandKey];
               islandData.infrastructure[infraType]++;
               
               logEvent(`üõ§Ô∏è ${infraType} am√©lior√© au niveau ${islandData.infrastructure[infraType]}`);
               addXP(75);
               
               renderIslandView();
               updateAllUI();
               saveState();
           }

           // --- FONCTIONS UTILITAIRES POUR LE MONDE ---
           function getIslandAtPosition(x, y) {
               // G√©n√©ration proc√©durale d'√Æles bas√©e sur la position
               const seed = x * 31 + y * 17;
               const islandProbability = 0.15; // 15% de chance d'avoir une √Æle
               
               if (x === 7 && y === 7) {
                   // √éle capitale du joueur
                   return {
                       x: x, y: y,
                       name: "√éle Capitale",
                       type: "capital",
                       owner: "player"
                   };
               }
               
               // Utiliser le seed pour d√©terminer s'il y a une √Æle
               const random = (seed * 9301 + 49297) % 233280 / 233280;
               
               if (random < islandProbability) {
                   const islandTypes = ['neutral', 'enemy', 'ally', 'resource', 'pirate'];
                   const typeIndex = Math.floor((seed % 100) / 20);
                   const type = islandTypes[typeIndex] || 'neutral';
                   
                   return {
                       x: x, y: y,
                       name: generateIslandName(),
                       type: type,
                       owner: type === 'neutral' ? null : type,
                       resources: generateIslandResources(seed),
                       population: Math.floor(random * 2000) + 500,
                       strength: Math.floor(random * 100) + 20
                   };
               }
               
               return null;
           }
           
           function getIslandTypeIcon(type) {
               const icons = {
                   capital: 'üèõÔ∏è',
                   colony: 'üèùÔ∏è',
                   neutral: 'üó∫Ô∏è',
                   enemy: '‚öîÔ∏è',
                   ally: 'ü§ù',
                   resource: 'üíé',
                   pirate: 'üè¥‚Äç‚ò†Ô∏è',
                   trading: 'üè™'
               };
               return icons[type] || 'üèùÔ∏è';
           }
           
           function generateIslandResources(seed) {
               const allResources = ['wood', 'wine', 'marble', 'crystal', 'sulfur', 'gold'];
               const numResources = (seed % 3) + 1; // 1 √† 3 ressources
               const resources = [];
               
               for (let i = 0; i < numResources; i++) {
                   const resourceIndex = (seed + i * 7) % allResources.length;
                   const resource = allResources[resourceIndex];
                   if (!resources.includes(resource)) {
                       resources.push(resource);
                   }
               }
               
               return resources;
           }
           
           function hasTradeRoute(x, y) {
               return gameState.tradeRoutes.some(route => 
                   (route.from.x === x && route.from.y === y) || 
                   (route.to.x === x && route.to.y === y)
               );
           }
           
           function selectWorldTile(x, y) {
               const island = getIslandAtPosition(x, y);
               const isExplored = gameState.exploredIslands.some(exp => exp.x === x && exp.y === y);
               const isColonized = gameState.colonizedIslands.some(col => col.x === x && col.y === y);
               
               if (!island) {
                   showModal('Oc√©an', `Position [${x},${y}] - Rien que de l'eau √† perte de vue.`);
                   return;
               }
               
               if (!isExplored && island.type !== 'capital') {
                   const explorationCost = calculateExplorationCost(x, y);
                   showModal(
                       'Territoire Inexplor√©',
                       `Position [${x},${y}]<br><br>
                        Co√ªt d'exploration: ${explorationCost.gold} or, ${explorationCost.wood} bois<br><br>
                        <button onclick="exploreIsland(${x}, ${y})" class="action-btn" ${canAffordExploration(explorationCost) ? '' : 'disabled'}>
                            Explorer
                        </button>`
                   );
                   return;
               }
               
               // √éle explor√©e - afficher les options
               let actions = [];
               
               if (island.type === 'capital' || isColonized) {
                   actions.push(`<button onclick="visitIsland(${x}, ${y})" class="action-btn">Visiter cette √Æle</button>`);
               } else if (island.type === 'neutral') {
                   const colonizationCost = calculateColonizationCost(island);
                   actions.push(`<button onclick="colonizeIsland(${x}, ${y})" class="action-btn" ${canAffordColonization(colonizationCost) ? '' : 'disabled'}>Coloniser (${colonizationCost.gold} or)</button>`);
               } else if (island.type === 'enemy') {
                   actions.push(`<button onclick="attackIsland(${x}, ${y})" class="action-btn">Attaquer</button>`);
               } else if (island.type === 'ally') {
                   actions.push(`<button onclick="establishTradeRoute(${x}, ${y})" class="action-btn">√âtablir route commerciale</button>`);
               }
               
               if (island.type !== 'enemy') {
                   actions.push(`<button onclick="sendDiplomaticMission(${x}, ${y})" class="action-btn">Mission diplomatique</button>`);
               }
               
               const resourceText = island.resources ? `<br>Ressources: ${island.resources.join(', ')}` : '';
               const populationText = island.population ? `<br>Population: ${island.population.toLocaleString()}` : '';
               
               showModal(
                   `${island.name} [${x},${y}]`,
                   `Type: ${island.type}<br>
                    Propri√©taire: ${island.owner || 'Aucun'}${resourceText}${populationText}<br><br>
                    ${actions.join('<br>')}`
               );
           }
           
           function calculateExplorationCost(x, y) {
               const distance = Math.abs(x - 7) + Math.abs(y - 7); // Distance de Manhattan depuis la capitale
               return {
                   gold: 100 + distance * 20,
                   wood: 50 + distance * 10
               };
           }
           
           function canAffordExploration(cost) {
               return Object.entries(cost).every(([resource, amount]) => gameState.resources[resource] >= amount);
           }
           
           function exploreIsland(x, y) {
               const cost = calculateExplorationCost(x, y);
               
               if (!canAffordExploration(cost)) {
                   logEvent('‚ùå Ressources insuffisantes pour l\'exploration');
                   return;
               }
               
               // D√©duire les co√ªts
               Object.entries(cost).forEach(([resource, amount]) => {
                   gameState.resources[resource] -= amount;
               });
               
               // Ajouter l'√Æle aux √Æles explor√©es
               const island = getIslandAtPosition(x, y);
               gameState.exploredIslands.push({
                   x: x, y: y,
                   name: island.name,
                   type: island.type,
                   resources: island.resources,
                   population: island.population,
                   exploredAt: Date.now()
               });
               
               // √âv√©nement mondial
               gameState.worldEvents.push({
                   title: 'Nouvelle D√©couverte',
                   description: `Vos explorateurs ont d√©couvert ${island.name}, une √Æle ${island.type}`,
                   timestamp: Date.now()
               });
               
               logEvent(`üó∫Ô∏è ${island.name} explor√©e ! Type: ${island.type}`);
               addXP(30);
               
               dom.modal.style.display = 'none';
               renderWorldMap();
               updateAllUI();
               saveState();
           }
           
           function calculateColonizationCost(island) {
               const baseCost = 1000;
               const populationMultiplier = island.population ? island.population / 1000 : 1;
               return {
                   gold: Math.floor(baseCost * populationMultiplier),
                   wood: Math.floor(200 * populationMultiplier),
                   sulfur: Math.floor(100 * populationMultiplier)
               };
           }
           
           function canAffordColonization(cost) {
               return Object.entries(cost).every(([resource, amount]) => gameState.resources[resource] >= amount);
           }
           
           function colonizeIsland(x, y) {
               const island = getIslandAtPosition(x, y);
               const cost = calculateColonizationCost(island);
               
               if (!canAffordColonization(cost)) {
                   logEvent('‚ùå Ressources insuffisantes pour la colonisation');
                   return;
               }
               
               // D√©duire les co√ªts
               Object.entries(cost).forEach(([resource, amount]) => {
                   gameState.resources[resource] -= amount;
               });
               
               // Ajouter la colonie
               const colony = {
                   x: x, y: y,
                   name: island.name,
                   type: 'colony',
                   colonizedAt: Date.now(),
                   development: 1,
                   population: island.population,
                   happiness: 60
               };
               
               gameState.colonizedIslands.push(colony);
               
               // Cr√©er les d√©tails de l'√Æle
               createDefaultIslandData(colony);
               
               // √âv√©nement mondial
               gameState.worldEvents.push({
                   title: 'Nouvelle Colonie',
                   description: `${island.name} a √©t√© colonis√©e avec succ√®s`,
                   timestamp: Date.now()
               });
               
               logEvent(`üèùÔ∏è ${island.name} colonis√©e avec succ√®s !`);
               addXP(100);
               
               dom.modal.style.display = 'none';
               renderWorldMap();
               updateAllUI();
               saveState();
           }
           
           function visitIsland(x, y) {
               gameState.currentIsland = { x: x, y: y };
               logEvent(`üö¢ Voyage vers l'√Æle [${x},${y}]`);
               
               dom.modal.style.display = 'none';
               
               // Changer vers la vue √Æle
               document.querySelector('[data-view="island"]').click();
               
               renderIslandView();
               saveState();
           }
           
           function getKnownCivilizations() {
               // Civilisations g√©n√©r√©es dynamiquement bas√©es sur les √Æles explor√©es
               const civilizations = [
                   {
                       id: 'atlanteans',
                       name: 'Atlantes',
                       icon: 'üî±',
                       description: 'Ma√Ætres des oc√©ans et de la technologie aquatique',
                       territories: 8,
                       militaryPower: '√âlev√©e',
                       wealth: 'Tr√®s riche',
                       specialty: 'Navigation et commerce maritime'
                   },
                   {
                       id: 'desert_nomads',
                       name: 'Nomades du D√©sert',
                       icon: 'üê™',
                       description: 'Marchands habiles et guerriers du d√©sert',
                       territories: 5,
                       militaryPower: 'Moyenne',
                       wealth: 'Riche',
                       specialty: 'Commerce et exploration'
                   },
                   {
                       id: 'mountain_clans',
                       name: 'Clans des Montagnes',
                       icon: '‚õ∞Ô∏è',
                       description: 'Forgerons l√©gendaires et mineurs experts',
                       territories: 4,
                       militaryPower: 'Tr√®s √©lev√©e',
                       wealth: 'Moyenne',
                       specialty: 'M√©tallurgie et d√©fense'
                   },
                   {
                       id: 'forest_druids',
                       name: 'Druides de la For√™t',
                       icon: 'üå≤',
                       description: 'Gardiens de la nature et de la magie ancienne',
                       territories: 6,
                       militaryPower: 'Faible',
                       wealth: 'Pauvre',
                       specialty: 'Magie et ressources naturelles'
                   }
               ];
               
               // Ne montrer que les civilisations "d√©couvertes" bas√©es sur l'exploration
               const exploredCount = gameState.exploredIslands.length;
               return civilizations.slice(0, Math.min(Math.floor(exploredCount / 3), civilizations.length));
           }
           
           function getRelationText(relation) {
               if (relation >= 80) return 'Alli√©';
               if (relation >= 60) return 'Ami';
               if (relation >= 40) return 'Neutre+';
               if (relation >= 20) return 'Neutre';
               if (relation >= 0) return 'Neutre-';
               if (relation >= -20) return 'M√©fiant';
               if (relation >= -40) return 'Hostile';
               return 'Ennemi';
           }
           
           function getRelationColor(relation) {
               if (relation >= 60) return 'var(--color-success)';
               if (relation >= 20) return 'var(--color-warning)';
               if (relation >= -20) return 'var(--color-text)';
               return 'var(--color-danger)';
           }
           
           function calculateTradeRouteProfit(route) {
               const baseProfit = 10;
               const distanceBonus = Math.max(1, route.distance / 5);
               const goodsBonus = route.goods.length * 5;
               return Math.floor(baseProfit + distanceBonus + goodsBonus);
           }
           
           function openDiplomacy(civId) {
               const civ = getKnownCivilizations().find(c => c.id === civId);
               const currentRelation = gameState.diplomacy.relations[civId] || 0;
               
               let actions = [];
               
               if (currentRelation < 80) {
                   actions.push(`<button onclick="improveDiplomacy('${civId}')" class="action-btn">Am√©liorer relations (500 or)</button>`);
               }
               
               if (currentRelation >= 40) {
                   actions.push(`<button onclick="proposeTreaty('${civId}')" class="action-btn">Proposer trait√©</button>`);
               }
               
               if (currentRelation >= 60) {
                   actions.push(`<button onclick="requestMilitaryAid('${civId}')" class="action-btn">Demander aide militaire</button>`);
               }
               
               showModal(
                   `Diplomatie - ${civ.name}`,
                   `Relations actuelles: ${getRelationText(currentRelation)} (${currentRelation})<br><br>
                    ${civ.description}<br><br>
                    ${actions.join('<br>')}`
               );
           }
           
           function improveDiplomacy(civId) {
               if (gameState.resources.gold < 500) {
                   logEvent('‚ùå Pas assez d\'or pour am√©liorer les relations');
                   return;
               }
               
               gameState.resources.gold -= 500;
               gameState.diplomacy.relations[civId] = (gameState.diplomacy.relations[civId] || 0) + 10;
               
               const civ = getKnownCivilizations().find(c => c.id === civId);
               logEvent(`ü§ù Relations am√©lior√©es avec ${civ.name}`);
               
               dom.modal.style.display = 'none';
               renderWorldMap();
               updateAllUI();
               saveState();
           }
           
           function establishTradeRoute(x, y) {
               const island = getIslandAtPosition(x, y);
               const distance = Math.abs(x - gameState.currentIsland.x) + Math.abs(y - gameState.currentIsland.y);
               
               const route = {
                   from: { x: gameState.currentIsland.x, y: gameState.currentIsland.y, name: 'Votre √Æle' },
                   to: { x: x, y: y, name: island.name },
                   goods: island.resources || ['biens divers'],
                   distance: distance,
                   establishedAt: Date.now()
               };
               
               gameState.tradeRoutes.push(route);
               
               logEvent(`üö¢ Route commerciale √©tablie avec ${island.name}`);
               addXP(50);
               
               dom.modal.style.display = 'none';
               renderWorldMap();
               updateAllUI();
               saveState();
           }
           
           function cancelTradeRoute(index) {
               const route = gameState.tradeRoutes[index];
               gameState.tradeRoutes.splice(index, 1);
               
               logEvent(`‚ùå Route commerciale ${route.from.name} - ${route.to.name} annul√©e`);
               
               renderWorldMap();
               updateAllUI();
               saveState();
           }

           // --- SYST√àME DE QU√äTES ET √âV√âNEMENTS ---
           function renderQuestsView() {
               let html = `
                   <div class="card" style="grid-column: 1 / -1;">
                       <div style="display: flex; justify-content: space-between; align-items: center;">
                           <h3>üìã Centre de Missions</h3>
                           <div style="display: flex; gap: 1rem;">
                               <div>Qu√™tes actives: ${gameState.activeQuests.length}</div>
                               <div>Qu√™tes termin√©es: ${gameState.completedQuests.length}</div>
                               <div>Points de qu√™te: ${gameState.questPoints}</div>
                           </div>
                       </div>
                   </div>
               `;
               
               // Qu√™tes actives
               if (gameState.activeQuests.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>üéØ Qu√™tes Actives</h3>
                           <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                   `;
                   
                   gameState.activeQuests.forEach((quest, index) => {
                       const progress = calculateQuestProgress(quest);
                       const progressPercent = Math.min(100, (progress.current / progress.required) * 100);
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--color-primary);">
                               <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                   <div>
                                       <h4 style="margin: 0; color: var(--color-primary);">${quest.icon} ${quest.title}</h4>
                                       <p style="margin: 0.25rem 0; font-size: 0.9rem; color: var(--color-text-muted);">${quest.description}</p>
                                   </div>
                                   <div style="text-align: right;">
                                       <div style="font-size: 0.8rem; color: var(--color-warning);">
                                           ${quest.difficulty} | ${quest.timeLimit ? `‚è∞ ${Math.ceil((quest.deadline - Date.now()) / 60000)}min` : '‚àû'}
                                       </div>
                                   </div>
                               </div>
                               
                               <div style="margin: 0.5rem 0;">
                                   <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                       <span>Progression</span>
                                       <span>${progress.current}/${progress.required}</span>
                                   </div>
                                   <div style="background: var(--color-panel); border-radius: 0.25rem; height: 8px; overflow: hidden;">
                                       <div style="background: var(--color-primary); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                                   </div>
                               </div>
                               
                               <div style="display: flex; justify-content: space-between; align-items: center;">
                                   <div style="font-size: 0.9rem;">
                                       <strong>R√©compenses:</strong> ${formatQuestRewards(quest.rewards)}
                                   </div>
                                   ${progressPercent >= 100 ? 
                                       `<button onclick="completeQuest(${index})" class="action-btn" style="background: var(--color-success);">Terminer</button>` :
                                       `<button onclick="abandonQuest(${index})" class="action-btn" style="background: var(--color-danger); font-size: 0.8rem;">Abandonner</button>`
                                   }
                               </div>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               // Nouvelles qu√™tes disponibles
               const availableQuests = generateAvailableQuests();
               if (availableQuests.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>üìú Nouvelles Missions Disponibles</h3>
                           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                   `;
                   
                   availableQuests.forEach((quest, index) => {
                       html += `
                           <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; border: 2px solid var(--color-border);">
                               <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                   <h4 style="margin: 0;">${quest.icon} ${quest.title}</h4>
                                   <span style="font-size: 0.8rem; color: var(--color-warning);">${quest.difficulty}</span>
                               </div>
                               <p style="margin: 0.5rem 0; font-size: 0.9rem;">${quest.description}</p>
                               <div style="margin: 0.5rem 0; font-size: 0.8rem; color: var(--color-text-muted);">
                                   Objectif: ${quest.objective}<br>
                                   ${quest.timeLimit ? `Temps limite: ${quest.timeLimit} minutes` : 'Pas de limite de temps'}
                               </div>
                               <div style="margin: 0.5rem 0; font-size: 0.9rem;">
                                   <strong>R√©compenses:</strong> ${formatQuestRewards(quest.rewards)}
                               </div>
                               <button onclick="acceptQuest(${index})" class="action-btn" ${canAcceptQuest(quest) ? '' : 'disabled'}>
                                   Accepter la mission
                               </button>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               // √âv√©nements mondiaux actifs
               const activeEvents = getActiveWorldEvents();
               if (activeEvents.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>üåü √âv√©nements Sp√©ciaux</h3>
                           <div style="margin-top: 1rem;">
                   `;
                   
                   activeEvents.forEach(event => {
                       const timeLeft = Math.max(0, event.endTime - Date.now());
                       const hoursLeft = Math.floor(timeLeft / 3600000);
                       const minutesLeft = Math.floor((timeLeft % 3600000) / 60000);
                       
                       html += `
                           <div style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; color: white;">
                               <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                   <h4 style="margin: 0;">${event.icon} ${event.title}</h4>
                                   <div style="font-size: 0.9rem;">‚è∞ ${hoursLeft}h ${minutesLeft}m restantes</div>
                               </div>
                               <p style="margin: 0.5rem 0; opacity: 0.9;">${event.description}</p>
                               <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                   ${event.actions.map(action => 
                                       `<button onclick="participateInEvent('${event.id}', '${action.id}')" class="action-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                                           ${action.name}
                                       </button>`
                                   ).join('')}
                               </div>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               // Historique des qu√™tes termin√©es (derni√®res 10)
               if (gameState.completedQuests.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>‚úÖ Missions R√©cemment Termin√©es</h3>
                           <div style="max-height: 300px; overflow-y: auto; margin-top: 1rem;">
                   `;
                   
                   gameState.completedQuests.slice(-10).reverse().forEach(quest => {
                       const timeAgo = Math.floor((Date.now() - quest.completedAt) / 60000);
                       const timeText = timeAgo < 1 ? '√Ä l\'instant' : `Il y a ${timeAgo} min`;
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.5rem; border-left: 3px solid var(--color-success);">
                               <div style="display: flex; justify-content: space-between; align-items: center;">
                                   <div>
                                       <strong>${quest.icon} ${quest.title}</strong>
                                       <div style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                                           R√©compenses re√ßues: ${formatQuestRewards(quest.rewards)}
                                       </div>
                                   </div>
                                   <span style="font-size: 0.8rem; color: var(--color-text-muted);">${timeText}</span>
                               </div>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               dom.questsGrid.innerHTML = html;
           }
           
           function generateAvailableQuests() {
               const questTemplates = [
                   {
                       id: 'build_structures',
                       icon: 'üèóÔ∏è',
                       title: 'Expansion Urbaine',
                       description: 'Votre ville a besoin de nouveaux b√¢timents pour prosp√©rer.',
                       objective: 'Construire 3 b√¢timents',
                       difficulty: 'Facile',
                       type: 'build',
                       target: 3,
                       rewards: { gold: 500, xp: 100, questPoints: 10 },
                       requirements: { level: 1 }
                   },
                   {
                       id: 'explore_islands',
                       icon: 'üó∫Ô∏è',
                       title: 'Explorateur des Mers',
                       description: 'Les oc√©ans regorgent d\'√Æles myst√©rieuses √† d√©couvrir.',
                       objective: 'Explorer 5 nouvelles √Æles',
                       difficulty: 'Moyen',
                       type: 'explore',
                       target: 5,
                       rewards: { gold: 1000, wood: 500, xp: 200, questPoints: 25 },
                       requirements: { level: 3, exploredIslands: 2 }
                   },
                   {
                       id: 'establish_colonies',
                       icon: 'üèùÔ∏è',
                       title: 'Fondateur d\'Empire',
                       description: '√âtendez votre influence en √©tablissant de nouvelles colonies.',
                       objective: 'Coloniser 2 √Æles',
                       difficulty: 'Difficile',
                       type: 'colonize',
                       target: 2,
                       rewards: { gold: 2000, research: 100, xp: 300, questPoints: 50 },
                       requirements: { level: 5, colonizedIslands: 0 }
                   },
                   {
                       id: 'trade_routes',
                       icon: 'üö¢',
                       title: 'Ma√Ætre Marchand',
                       description: 'Le commerce est la cl√© de la prosp√©rit√©.',
                       objective: '√âtablir 3 routes commerciales',
                       difficulty: 'Moyen',
                       type: 'trade',
                       target: 3,
                       rewards: { gold: 1500, wine: 200, xp: 250, questPoints: 30 },
                       requirements: { level: 4, colonizedIslands: 1 }
                   },
                   {
                       id: 'research_tech',
                       icon: 'üî¨',
                       title: 'Savant √ârudit',
                       description: 'La connaissance est le pouvoir ultime.',
                       objective: 'Rechercher 5 technologies',
                       difficulty: 'Moyen',
                       type: 'research',
                       target: 5,
                       rewards: { research: 500, crystal: 100, xp: 200, questPoints: 35 },
                       requirements: { level: 3, researchCompleted: 2 }
                   },
                   {
                       id: 'military_power',
                       icon: '‚öîÔ∏è',
                       title: 'Seigneur de Guerre',
                       description: 'Une arm√©e puissante prot√®ge votre empire.',
                       objective: 'Entra√Æner 50 unit√©s militaires',
                       difficulty: 'Difficile',
                       type: 'military',
                       target: 50,
                       rewards: { gold: 1000, sulfur: 200, xp: 300, questPoints: 40 },
                       requirements: { level: 6, militaryUnits: 10 }
                   },
                   {
                       id: 'resource_master',
                       icon: 'üíé',
                       title: 'Ma√Ætre des Ressources',
                       description: 'Accumulez des richesses pour votre empire.',
                       objective: 'Poss√©der 10000 or et 5000 de chaque ressource',
                       difficulty: 'Tr√®s Difficile',
                       type: 'resources',
                       target: { gold: 10000, wood: 5000, wine: 5000, marble: 5000, crystal: 5000, sulfur: 5000 },
                       rewards: { gold: 5000, research: 200, xp: 500, questPoints: 100 },
                       requirements: { level: 8 }
                   }
               ];
               
               // Filtrer les qu√™tes disponibles selon les pr√©requis
               return questTemplates.filter(quest => {
                   if (gameState.activeQuests.some(active => active.id === quest.id)) return false;
                   if (gameState.completedQuests.some(completed => completed.id === quest.id)) return false;
                   
                   const reqs = quest.requirements;
                   if (reqs.level && gameState.playerStats.level < reqs.level) return false;
                   if (reqs.exploredIslands && gameState.exploredIslands.length < reqs.exploredIslands) return false;
                   if (reqs.colonizedIslands && gameState.colonizedIslands.length < reqs.colonizedIslands) return false;
                   if (reqs.researchCompleted && gameState.researchCompleted.length < reqs.researchCompleted) return false;
                   if (reqs.militaryUnits && gameState.militaryUnits.length < reqs.militaryUnits) return false;
                   
                   return true;
               }).slice(0, 6); // Limiter √† 6 qu√™tes disponibles
           }
           
           function calculateQuestProgress(quest) {
               let current = 0;
               const required = quest.target;
               
               switch (quest.type) {
                   case 'build':
                       current = gameState.playerStats.totalBuildings;
                       break;
                   case 'explore':
                       current = gameState.exploredIslands.length;
                       break;
                   case 'colonize':
                       current = gameState.colonizedIslands.length;
                       break;
                   case 'trade':
                       current = gameState.tradeRoutes.length;
                       break;
                   case 'research':
                       current = gameState.researchCompleted.length;
                       break;
                   case 'military':
                       current = gameState.militaryUnits.length;
                       break;
                   case 'resources':
                       // Pour les qu√™tes de ressources, v√©rifier si toutes les conditions sont remplies
                       current = Object.entries(required).every(([resource, amount]) => 
                           gameState.resources[resource] >= amount
                       ) ? 1 : 0;
                       return { current: current, required: 1 };
               }
               
               return { current: Math.min(current, required), required: required };
           }
           
           function formatQuestRewards(rewards) {
               return Object.entries(rewards).map(([resource, amount]) => {
                   const icons = {
                       gold: 'üí∞', wood: 'üå≤', wine: 'üçá', marble: 'üèõÔ∏è',
                       crystal: 'üíé', sulfur: 'üî•', research: 'üî¨', xp: '‚≠ê', questPoints: 'üèÜ'
                   };
                   return `${amount} ${icons[resource] || resource}`;
               }).join(', ');
           }
           
           function canAcceptQuest(quest) {
               return gameState.activeQuests.length < 5; // Limite de 5 qu√™tes actives
           }
           
           function acceptQuest(questIndex) {
               const availableQuests = generateAvailableQuests();
               const quest = availableQuests[questIndex];
               
               if (!quest || !canAcceptQuest(quest)) {
                   logEvent('‚ùå Impossible d\'accepter cette qu√™te');
                   return;
               }
               
               const activeQuest = {
                   ...quest,
                   acceptedAt: Date.now(),
                   deadline: quest.timeLimit ? Date.now() + (quest.timeLimit * 60000) : null
               };
               
               gameState.activeQuests.push(activeQuest);
               logEvent(`üìã Qu√™te accept√©e: ${quest.title}`);
               
               renderQuestsView();
               saveState();
           }
           
           function completeQuest(questIndex) {
               const quest = gameState.activeQuests[questIndex];
               if (!quest) return;
               
               const progress = calculateQuestProgress(quest);
               if (progress.current < progress.required) {
                   logEvent('‚ùå Qu√™te pas encore termin√©e');
                   return;
               }
               
               // Donner les r√©compenses
               Object.entries(quest.rewards).forEach(([resource, amount]) => {
                   if (resource === 'xp') {
                       addXP(amount);
                   } else if (resource === 'questPoints') {
                       gameState.questPoints = (gameState.questPoints || 0) + amount;
                   } else {
                       gameState.resources[resource] = (gameState.resources[resource] || 0) + amount;
                   }
               });
               
               // Marquer comme termin√©e
               const completedQuest = {
                   ...quest,
                   completedAt: Date.now()
               };
               
               gameState.completedQuests.push(completedQuest);
               gameState.activeQuests.splice(questIndex, 1);
               
               logEvent(`‚úÖ Qu√™te termin√©e: ${quest.title}`);
               showNotification(`Qu√™te termin√©e ! R√©compenses: ${formatQuestRewards(quest.rewards)}`, 'success');
               
               renderQuestsView();
               updateAllUI();
               saveState();
           }
           
           function abandonQuest(questIndex) {
               const quest = gameState.activeQuests[questIndex];
               if (!quest) return;
               
               gameState.activeQuests.splice(questIndex, 1);
               logEvent(`‚ùå Qu√™te abandonn√©e: ${quest.title}`);
               
               renderQuestsView();
               saveState();
           }
           
           function getActiveWorldEvents() {
               const now = Date.now();
               
               // G√©n√©rer des √©v√©nements dynamiques
               const eventTemplates = [
                   {
                       id: 'pirate_raid',
                       icon: 'üè¥‚Äç‚ò†Ô∏è',
                       title: 'Raid de Pirates',
                       description: 'Des pirates menacent vos routes commerciales ! D√©fendez-vous ou n√©gociez.',
                       duration: 2 * 60 * 60 * 1000, // 2 heures
                       actions: [
                           { id: 'fight', name: 'Combattre', cost: { sulfur: 100 }, reward: { gold: 1000, xp: 150 } },
                           { id: 'negotiate', name: 'N√©gocier', cost: { gold: 500 }, reward: { wine: 200, xp: 50 } }
                       ]
                   },
                   {
                       id: 'merchant_festival',
                       icon: 'üé™',
                       title: 'Festival des Marchands',
                       description: 'Un grand festival commercial offre des opportunit√©s d\'√©change exceptionnelles.',
                       duration: 3 * 60 * 60 * 1000, // 3 heures
                       actions: [
                           { id: 'participate', name: 'Participer', cost: { gold: 200 }, reward: { wine: 300, marble: 150, xp: 100 } },
                           { id: 'sponsor', name: 'Sponsoriser', cost: { gold: 1000 }, reward: { gold: 1500, crystal: 100, xp: 200 } }
                       ]
                   },
                   {
                       id: 'ancient_ruins',
                       icon: 'üèõÔ∏è',
                       title: 'Ruines Antiques D√©couvertes',
                       description: 'Des ruines myst√©rieuses ont √©t√© d√©couvertes. Explorez-les pour des tr√©sors anciens.',
                       duration: 4 * 60 * 60 * 1000, // 4 heures
                       actions: [
                           { id: 'explore', name: 'Explorer', cost: { wood: 200 }, reward: { research: 200, crystal: 100, xp: 250 } },
                           { id: 'excavate', name: 'Excaver', cost: { gold: 800, marble: 100 }, reward: { gold: 2000, research: 300, xp: 400 } }
                       ]
                   }
               ];
               
               // V√©rifier s'il faut g√©n√©rer de nouveaux √©v√©nements
               if (!gameState.worldEvents) gameState.worldEvents = [];
               
               const activeEvents = gameState.worldEvents.filter(event => event.endTime > now);
               
               // G√©n√©rer un nouvel √©v√©nement si n√©cessaire (10% de chance toutes les 30 minutes)
               const lastEventCheck = gameState.lastEventCheck || 0;
               if (now - lastEventCheck > 30 * 60 * 1000) { // 30 minutes
                   gameState.lastEventCheck = now;
                   
                   if (Math.random() < 0.1 && activeEvents.length < 2) { // 10% de chance, max 2 √©v√©nements
                       const template = eventTemplates[Math.floor(Math.random() * eventTemplates.length)];
                       const newEvent = {
                           ...template,
                           startTime: now,
                           endTime: now + template.duration
                       };
                       
                       gameState.worldEvents.push(newEvent);
                       activeEvents.push(newEvent);
                       
                       showNotification(`Nouvel √©v√©nement: ${newEvent.title}`, 'info');
                   }
               }
               
               return activeEvents;
           }
           
           function participateInEvent(eventId, actionId) {
               const event = gameState.worldEvents.find(e => e.id === eventId);
               if (!event || event.endTime < Date.now()) {
                   logEvent('‚ùå √âv√©nement expir√© ou introuvable');
                   return;
               }
               
               const action = event.actions.find(a => a.id === actionId);
               if (!action) return;
               
               // V√©rifier les co√ªts
               for (const [resource, cost] of Object.entries(action.cost)) {
                   if (gameState.resources[resource] < cost) {
                       logEvent(`‚ùå Ressources insuffisantes pour ${action.name}`);
                       return;
                   }
               }
               
               // D√©duire les co√ªts
               Object.entries(action.cost).forEach(([resource, cost]) => {
                   gameState.resources[resource] -= cost;
               });
               
               // Donner les r√©compenses
               Object.entries(action.reward).forEach(([resource, amount]) => {
                   if (resource === 'xp') {
                       addXP(amount);
                   } else {
                       gameState.resources[resource] = (gameState.resources[resource] || 0) + amount;
                   }
               });
               
               logEvent(`üåü Participation √† l'√©v√©nement: ${action.name}`);
               showNotification(`√âv√©nement r√©ussi ! R√©compenses: ${formatQuestRewards(action.reward)}`, 'success');
               
               // Marquer l'√©v√©nement comme termin√© pour ce joueur
               event.participated = true;
               
               renderQuestsView();
               updateAllUI();
               saveState();
           }

           // --- SYST√àME DE COMMERCE AVANC√â ---
           function renderTradeView() {
               let html = `
                   <div class="card" style="grid-column: 1 / -1;">
                       <div style="display: flex; justify-content: space-between; align-items: center;">
                           <h3>üí± Centre Commercial</h3>
                           <div style="display: flex; gap: 1rem;">
                               <div>Routes actives: ${gameState.tradeRoutes.length}</div>
                               <div>Profit total: ${calculateTotalTradeProfit()} or/min</div>
                               <div>R√©putation: ${gameState.tradeReputation || 50}/100</div>
                           </div>
                       </div>
                   </div>
               `;
               
               // March√© mondial des ressources
               html += `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>üìà March√© Mondial des Ressources</h3>
                       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
               `;
               
               const marketPrices = getMarketPrices();
               const resources = ['wood', 'wine', 'marble', 'crystal', 'sulfur'];
               
               resources.forEach(resource => {
                   const price = marketPrices[resource];
                   const trend = getMarketTrend(resource);
                   const trendIcon = trend > 0 ? 'üìà' : trend < 0 ? 'üìâ' : '‚û°Ô∏è';
                   const trendColor = trend > 0 ? 'var(--color-success)' : trend < 0 ? 'var(--color-danger)' : 'var(--color-warning)';
                   const playerStock = gameState.resources[resource] || 0;
                   
                   html += `
                       <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                           <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${getResourceIcon(resource)}</div>
                           <h4 style="margin: 0.25rem 0; text-transform: capitalize;">${resource}</h4>
                           <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-primary); margin: 0.5rem 0;">
                               ${price.toFixed(2)} or
                           </div>
                           <div style="color: ${trendColor}; font-size: 0.9rem; margin-bottom: 0.5rem;">
                               ${trendIcon} ${Math.abs(trend).toFixed(1)}%
                           </div>
                           <div style="font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">
                               Stock: ${playerStock.toLocaleString()}
                           </div>
                           <div style="display: flex; gap: 0.25rem;">
                               <button onclick="quickTrade('sell', '${resource}', 100)" class="action-btn" style="font-size: 0.7rem; padding: 0.25rem;" ${playerStock >= 100 ? '' : 'disabled'}>
                                   Vendre 100
                               </button>
                               <button onclick="quickTrade('buy', '${resource}', 100)" class="action-btn" style="font-size: 0.7rem; padding: 0.25rem;" ${gameState.resources.gold >= price * 100 ? '' : 'disabled'}>
                                   Acheter 100
                               </button>
                           </div>
                       </div>
                   `;
               });
               
               html += `
                       </div>
                   </div>
               `;
               
               // Contrats commerciaux disponibles
               const availableContracts = generateTradeContracts();
               if (availableContracts.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>üìã Contrats Commerciaux Disponibles</h3>
                           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; margin-top: 1rem;">
                   `;
                   
                   availableContracts.forEach((contract, index) => {
                       const profitability = calculateContractProfitability(contract);
                       const profitColor = profitability > 20 ? 'var(--color-success)' : profitability > 0 ? 'var(--color-warning)' : 'var(--color-danger)';
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid ${profitColor};">
                               <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                   <h4 style="margin: 0;">${contract.icon} ${contract.client}</h4>
                                   <span style="font-size: 0.8rem; color: ${profitColor};">
                                       ${profitability > 0 ? '+' : ''}${profitability.toFixed(1)}% profit
                                   </span>
                               </div>
                               <p style="margin: 0.5rem 0; font-size: 0.9rem;">${contract.description}</p>
                               <div style="margin: 0.5rem 0; font-size: 0.9rem;">
                                   <strong>Demande:</strong> ${contract.demand.amount} ${contract.demand.resource}<br>
                                   <strong>Offre:</strong> ${contract.payment.amount} ${contract.payment.resource}<br>
                                   <strong>D√©lai:</strong> ${contract.deadline} jours
                               </div>
                               <div style="display: flex; justify-content: space-between; align-items: center;">
                                   <div style="font-size: 0.8rem; color: var(--color-text-muted);">
                                       R√©putation requise: ${contract.reputationRequired}
                                   </div>
                                   <button onclick="acceptContract(${index})" class="action-btn" ${canAcceptContract(contract) ? '' : 'disabled'}>
                                       Accepter
                                   </button>
                               </div>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               // Contrats actifs
               if (gameState.activeContracts && gameState.activeContracts.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>‚è≥ Contrats en Cours</h3>
                           <div style="margin-top: 1rem;">
                   `;
                   
                   gameState.activeContracts.forEach((contract, index) => {
                       const timeLeft = contract.deadline - Date.now();
                       const daysLeft = Math.max(0, Math.ceil(timeLeft / (24 * 60 * 60 * 1000)));
                       const canComplete = gameState.resources[contract.demand.resource] >= contract.demand.amount;
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid var(--color-primary);">
                               <div style="display: flex; justify-content: space-between; align-items: center;">
                                   <div>
                                       <strong>${contract.icon} ${contract.client}</strong><br>
                                       <span style="font-size: 0.9rem;">
                                           Livrer ${contract.demand.amount} ${contract.demand.resource} 
                                           pour ${contract.payment.amount} ${contract.payment.resource}
                                       </span>
                                   </div>
                                   <div style="text-align: right;">
                                       <div style="color: ${daysLeft <= 1 ? 'var(--color-danger)' : 'var(--color-warning)'};">
                                           ‚è∞ ${daysLeft} jour${daysLeft > 1 ? 's' : ''}
                                       </div>
                                       <div style="margin-top: 0.5rem;">
                                           ${canComplete ? 
                                               `<button onclick="completeContract(${index})" class="action-btn" style="background: var(--color-success);">Livrer</button>` :
                                               `<button onclick="cancelContract(${index})" class="action-btn" style="background: var(--color-danger);">Annuler</button>`
                                           }
                                       </div>
                                   </div>
                               </div>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               // N√©gociateur de ressources
               html += `
                   <div class="card" style="grid-column: 1 / -1;">
                       <h3>ü§ù N√©gociateur de Ressources</h3>
                       <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                           <div>
                               <h4>Vous Offrez</h4>
                               <select id="offer-resource" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                                   ${resources.map(r => `<option value="${r}">${r.charAt(0).toUpperCase() + r.slice(1)}</option>`).join('')}
                               </select>
                               <input type="number" id="offer-amount" placeholder="Quantit√©" min="1" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                               <div id="offer-value" style="font-size: 0.9rem; color: var(--color-text-muted);">Valeur: 0 or</div>
                           </div>
                           <div>
                               <h4>Vous Demandez</h4>
                               <select id="request-resource" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                                   ${resources.map(r => `<option value="${r}">${r.charAt(0).toUpperCase() + r.slice(1)}</option>`).join('')}
                               </select>
                               <input type="number" id="request-amount" placeholder="Quantit√©" min="1" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                               <div id="request-value" style="font-size: 0.9rem; color: var(--color-text-muted);">Valeur: 0 or</div>
                           </div>
                       </div>
                       <div style="text-align: center; margin-top: 1rem;">
                           <div id="trade-fairness" style="margin-bottom: 1rem; font-weight: bold;"></div>
                           <button onclick="proposeResourceTrade()" class="action-btn">Proposer l'√âchange</button>
                       </div>
                   </div>
               `;
               
               // Historique des transactions
               if (gameState.tradeHistory && gameState.tradeHistory.length > 0) {
                   html += `
                       <div class="card" style="grid-column: 1 / -1;">
                           <h3>üìä Historique des Transactions</h3>
                           <div style="max-height: 300px; overflow-y: auto; margin-top: 1rem;">
                   `;
                   
                   gameState.tradeHistory.slice(-20).reverse().forEach(trade => {
                       const timeAgo = Math.floor((Date.now() - trade.timestamp) / 60000);
                       const timeText = timeAgo < 1 ? '√Ä l\'instant' : `Il y a ${timeAgo} min`;
                       
                       html += `
                           <div style="background: var(--color-panel-light); padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                               <div>
                                   <strong>${trade.type === 'buy' ? 'üìà Achat' : 'üìâ Vente'}</strong>
                                   ${trade.amount} ${trade.resource} 
                                   ${trade.type === 'buy' ? 'pour' : '√†'} ${trade.totalPrice} or
                               </div>
                               <span style="font-size: 0.8rem; color: var(--color-text-muted);">${timeText}</span>
                           </div>
                       `;
                   });
                   
                   html += `
                           </div>
                       </div>
                   `;
               }
               
               dom.tradeGrid.innerHTML = html;
               
               // Ajouter les event listeners pour le n√©gociateur
               setTimeout(() => {
                   const offerResource = document.getElementById('offer-resource');
                   const offerAmount = document.getElementById('offer-amount');
                   const requestResource = document.getElementById('request-resource');
                   const requestAmount = document.getElementById('request-amount');
                   
                   if (offerResource && offerAmount && requestResource && requestAmount) {
                       [offerResource, offerAmount, requestResource, requestAmount].forEach(element => {
                           element.addEventListener('input', updateTradeCalculation);
                       });
                   }
               }, 100);
           }
           
           function getResourceIcon(resource) {
               const icons = {
                   wood: 'üå≤', wine: 'üçá', marble: 'üèõÔ∏è', 
                   crystal: 'üíé', sulfur: 'üî•', gold: 'üí∞'
               };
               return icons[resource] || 'üì¶';
           }
           
           function getMarketPrices() {
               const now = Date.now();
               const baseDay = Math.floor(now / (24 * 60 * 60 * 1000));
               
               // Prix de base avec fluctuations bas√©es sur le jour
               const basePrices = {
                   wood: 2.5,
                   wine: 4.0,
                   marble: 6.0,
                   crystal: 8.5,
                   sulfur: 7.0
               };
               
               const prices = {};
               Object.entries(basePrices).forEach(([resource, basePrice]) => {
                   // Utiliser le jour et la ressource pour cr√©er une fluctuation pseudo-al√©atoire
                   const seed = baseDay * resource.length + resource.charCodeAt(0);
                   const fluctuation = (Math.sin(seed) * 0.3) + (Math.cos(seed * 1.5) * 0.2);
                   prices[resource] = Math.max(0.5, basePrice * (1 + fluctuation));
               });
               
               return prices;
           }
           
           function getMarketTrend(resource) {
               const now = Date.now();
               const currentDay = Math.floor(now / (24 * 60 * 60 * 1000));
               const previousDay = currentDay - 1;
               
               const currentPrice = getMarketPrices()[resource];
               
               // Calculer le prix d'hier
               const seed = previousDay * resource.length + resource.charCodeAt(0);
               const basePrices = { wood: 2.5, wine: 4.0, marble: 6.0, crystal: 8.5, sulfur: 7.0 };
               const fluctuation = (Math.sin(seed) * 0.3) + (Math.cos(seed * 1.5) * 0.2);
               const previousPrice = Math.max(0.5, basePrices[resource] * (1 + fluctuation));
               
               return ((currentPrice - previousPrice) / previousPrice) * 100;
           }
           
           function calculateTotalTradeProfit() {
               return gameState.tradeRoutes.reduce((total, route) => {
                   return total + calculateTradeRouteProfit(route);
               }, 0);
           }
           
           function quickTrade(type, resource, amount) {
               const prices = getMarketPrices();
               const price = prices[resource];
               const totalCost = price * amount;
               
               if (type === 'buy') {
                   if (gameState.resources.gold < totalCost) {
                       logEvent('‚ùå Pas assez d\'or pour cet achat');
                       return;
                   }
                   
                   gameState.resources.gold -= totalCost;
                   gameState.resources[resource] = (gameState.resources[resource] || 0) + amount;
                   
                   logEvent(`üìà Achet√© ${amount} ${resource} pour ${totalCost.toFixed(2)} or`);
               } else {
                   if ((gameState.resources[resource] || 0) < amount) {
                       logEvent('‚ùå Pas assez de ressources pour cette vente');
                       return;
                   }
                   
                   gameState.resources[resource] -= amount;
                   gameState.resources.gold += totalCost;
                   
                   logEvent(`üìâ Vendu ${amount} ${resource} pour ${totalCost.toFixed(2)} or`);
               }
               
               // Ajouter √† l'historique
               if (!gameState.tradeHistory) gameState.tradeHistory = [];
               gameState.tradeHistory.push({
                   type: type,
                   resource: resource,
                   amount: amount,
                   price: price,
                   totalPrice: totalCost.toFixed(2),
                   timestamp: Date.now()
               });
               
               // Am√©liorer l√©g√®rement la r√©putation commerciale
               gameState.tradeReputation = Math.min(100, (gameState.tradeReputation || 50) + 0.1);
               
               renderTradeView();
               updateAllUI();
               saveState();
           }
           
           function generateTradeContracts() {
               const contractTemplates = [
                   {
                       client: 'Marchands Atlantes',
                       icon: 'üî±',
                       description: 'Les Atlantes ont besoin de bois pour leurs constructions navales.',
                       demand: { resource: 'wood', amount: 500 },
                       payment: { resource: 'gold', amount: 1500 },
                       deadline: 7,
                       reputationRequired: 20
                   },
                   {
                       client: 'Nobles du D√©sert',
                       icon: 'üê™',
                       description: 'Les nobles recherchent du vin fin pour leurs banquets.',
                       demand: { resource: 'wine', amount: 300 },
                       payment: { resource: 'gold', amount: 1800 },
                       deadline: 5,
                       reputationRequired: 30
                   },
                   {
                       client: 'Architectes Royaux',
                       icon: 'üèõÔ∏è',
                       description: 'Un grand projet architectural n√©cessite du marbre de qualit√©.',
                       demand: { resource: 'marble', amount: 200 },
                       payment: { resource: 'gold', amount: 1600 },
                       deadline: 10,
                       reputationRequired: 40
                   },
                   {
                       client: 'Mages de Cristal',
                       icon: 'üîÆ',
                       description: 'Les mages ont besoin de cristaux pour leurs rituels.',
                       demand: { resource: 'crystal', amount: 150 },
                       payment: { resource: 'gold', amount: 2000 },
                       deadline: 3,
                       reputationRequired: 50
                   },
                   {
                       client: 'Alchimistes Militaires',
                       icon: '‚öóÔ∏è',
                       description: 'Production d\'armes alchimiques pour l\'arm√©e.',
                       demand: { resource: 'sulfur', amount: 250 },
                       payment: { resource: 'gold', amount: 2200 },
                       deadline: 4,
                       reputationRequired: 35
                   }
               ];
               
               // G√©n√©rer des contrats al√©atoires bas√©s sur le niveau et la r√©putation
               const playerLevel = gameState.playerStats.level;
               const reputation = gameState.tradeReputation || 50;
               
               return contractTemplates
                   .filter(contract => contract.reputationRequired <= reputation)
                   .filter(() => Math.random() < 0.6) // 60% de chance d'appara√Ætre
                   .slice(0, 4); // Maximum 4 contrats
           }
           
           function calculateContractProfitability(contract) {
               const marketPrices = getMarketPrices();
               const demandValue = marketPrices[contract.demand.resource] * contract.demand.amount;
               const paymentValue = contract.payment.resource === 'gold' ? 
                   contract.payment.amount : 
                   marketPrices[contract.payment.resource] * contract.payment.amount;
               
               return ((paymentValue - demandValue) / demandValue) * 100;
           }
           
           function canAcceptContract(contract) {
               const reputation = gameState.tradeReputation || 50;
               const activeContracts = gameState.activeContracts || [];
               
               return reputation >= contract.reputationRequired && activeContracts.length < 3;
           }
           
           function acceptContract(contractIndex) {
               const availableContracts = generateTradeContracts();
               const contract = availableContracts[contractIndex];
               
               if (!contract || !canAcceptContract(contract)) {
                   logEvent('‚ùå Impossible d\'accepter ce contrat');
                   return;
               }
               
               if (!gameState.activeContracts) gameState.activeContracts = [];
               
               const activeContract = {
                   ...contract,
                   acceptedAt: Date.now(),
                   deadline: Date.now() + (contract.deadline * 24 * 60 * 60 * 1000)
               };
               
               gameState.activeContracts.push(activeContract);
               logEvent(`üìã Contrat accept√©: ${contract.client}`);
               
               renderTradeView();
               saveState();
           }
           
           function completeContract(contractIndex) {
               const contract = gameState.activeContracts[contractIndex];
               if (!contract) return;
               
               // V√©rifier les ressources
               if (gameState.resources[contract.demand.resource] < contract.demand.amount) {
                   logEvent('‚ùå Ressources insuffisantes pour terminer le contrat');
                   return;
               }
               
               // Effectuer l'√©change
               gameState.resources[contract.demand.resource] -= contract.demand.amount;
               
               if (contract.payment.resource === 'gold') {
                   gameState.resources.gold += contract.payment.amount;
               } else {
                   gameState.resources[contract.payment.resource] = 
                       (gameState.resources[contract.payment.resource] || 0) + contract.payment.amount;
               }
               
               // Am√©liorer la r√©putation
               gameState.tradeReputation = Math.min(100, (gameState.tradeReputation || 50) + 5);
               
               // Supprimer le contrat
               gameState.activeContracts.splice(contractIndex, 1);
               
               logEvent(`‚úÖ Contrat termin√© avec ${contract.client}`);
               addXP(50);
               
               renderTradeView();
               updateAllUI();
               saveState();
           }
           
           function cancelContract(contractIndex) {
               const contract = gameState.activeContracts[contractIndex];
               if (!contract) return;
               
               // P√©nalit√© de r√©putation
               gameState.tradeReputation = Math.max(0, (gameState.tradeReputation || 50) - 10);
               
               gameState.activeContracts.splice(contractIndex, 1);
               logEvent(`‚ùå Contrat annul√© avec ${contract.client} (r√©putation -10)`);
               
               renderTradeView();
               saveState();
           }
           
           function updateTradeCalculation() {
               const offerResource = document.getElementById('offer-resource')?.value;
               const offerAmount = parseInt(document.getElementById('offer-amount')?.value) || 0;
               const requestResource = document.getElementById('request-resource')?.value;
               const requestAmount = parseInt(document.getElementById('request-amount')?.value) || 0;
               
               if (!offerResource || !requestResource) return;
               
               const prices = getMarketPrices();
               const offerValue = prices[offerResource] * offerAmount;
               const requestValue = prices[requestResource] * requestAmount;
               
               const offerValueEl = document.getElementById('offer-value');
               const requestValueEl = document.getElementById('request-value');
               const fairnessEl = document.getElementById('trade-fairness');
               
               if (offerValueEl) offerValueEl.textContent = `Valeur: ${offerValue.toFixed(2)} or`;
               if (requestValueEl) requestValueEl.textContent = `Valeur: ${requestValue.toFixed(2)} or`;
               
               if (fairnessEl && offerAmount > 0 && requestAmount > 0) {
                   const fairness = (offerValue / requestValue) * 100;
                   let fairnessText = '';
                   let fairnessColor = '';
                   
                   if (fairness > 120) {
                       fairnessText = 'Tr√®s favorable pour vous';
                       fairnessColor = 'var(--color-success)';
                   } else if (fairness > 105) {
                       fairnessText = 'Favorable pour vous';
                       fairnessColor = 'var(--color-success)';
                   } else if (fairness > 95) {
                       fairnessText = '√âchange √©quitable';
                       fairnessColor = 'var(--color-warning)';
                   } else if (fairness > 80) {
                       fairnessText = 'L√©g√®rement d√©favorable';
                       fairnessColor = 'var(--color-warning)';
                   } else {
                       fairnessText = 'Tr√®s d√©favorable pour vous';
                       fairnessColor = 'var(--color-danger)';
                   }
                   
                   fairnessEl.textContent = fairnessText;
                   fairnessEl.style.color = fairnessColor;
               }
           }
           
           function proposeResourceTrade() {
               const offerResource = document.getElementById('offer-resource')?.value;
               const offerAmount = parseInt(document.getElementById('offer-amount')?.value) || 0;
               const requestResource = document.getElementById('request-resource')?.value;
               const requestAmount = parseInt(document.getElementById('request-amount')?.value) || 0;
               
               if (!offerResource || !requestResource || offerAmount <= 0 || requestAmount <= 0) {
                   logEvent('‚ùå Veuillez remplir tous les champs correctement');
                   return;
               }
               
               if (gameState.resources[offerResource] < offerAmount) {
                   logEvent('‚ùå Vous n\'avez pas assez de ressources √† offrir');
                   return;
               }
               
               // Calculer la probabilit√© d'acceptation bas√©e sur l'√©quit√©
               const prices = getMarketPrices();
               const offerValue = prices[offerResource] * offerAmount;
               const requestValue = prices[requestResource] * requestAmount;
               const fairness = offerValue / requestValue;
               
               let acceptanceChance = 0;
               if (fairness >= 1.2) acceptanceChance = 0.9;
               else if (fairness >= 1.1) acceptanceChance = 0.7;
               else if (fairness >= 1.0) acceptanceChance = 0.5;
               else if (fairness >= 0.9) acceptanceChance = 0.3;
               else acceptanceChance = 0.1;
               
               // Bonus de r√©putation
               const reputationBonus = (gameState.tradeReputation || 50) / 200;
               acceptanceChance = Math.min(0.95, acceptanceChance + reputationBonus);
               
               if (Math.random() < acceptanceChance) {
                   // √âchange accept√©
                   gameState.resources[offerResource] -= offerAmount;
                   gameState.resources[requestResource] = (gameState.resources[requestResource] || 0) + requestAmount;
                   
                   gameState.tradeReputation = Math.min(100, (gameState.tradeReputation || 50) + 2);
                   
                   logEvent(`‚úÖ √âchange r√©ussi ! ${offerAmount} ${offerResource} contre ${requestAmount} ${requestResource}`);
                   showNotification('√âchange accept√© !', 'success');
               } else {
                   // √âchange refus√©
                   logEvent(`‚ùå √âchange refus√©. Proposez des conditions plus √©quitables.`);
                   showNotification('√âchange refus√©', 'error');
               }
               
               // Ajouter √† l'historique
               if (!gameState.tradeHistory) gameState.tradeHistory = [];
               gameState.tradeHistory.push({
                   type: 'exchange',
                   offered: `${offerAmount} ${offerResource}`,
                   requested: `${requestAmount} ${requestResource}`,
                   success: Math.random() < acceptanceChance,
                   timestamp: Date.now()
               });
               
               renderTradeView();
               updateAllUI();
               saveState();
           }

           // --- SYST√àME DE TUTORIEL ---
           function showTutorial() {
               if (gameState.playerStats.level === 1 && gameState.playerStats.totalBuildings <= 2) {
                   setTimeout(() => {
                       showModal('üéì Bienvenue dans Empire !', 
                           `Bienvenue, noble dirigeant ! Voici quelques conseils pour d√©buter :
                           
                           ‚Ä¢ Cliquez sur les emplacements vides (‚ûï) pour construire des b√¢timents
                           ‚Ä¢ Surveillez vos ressources en haut de l'√©cran
                           ‚Ä¢ Explorez les diff√©rentes vues : Ville, √éle, Monde, Recherche...
                           ‚Ä¢ Construisez des b√¢timents de production pour g√©n√©rer plus de ressources
                           ‚Ä¢ Recherchez de nouvelles technologies pour d√©bloquer du contenu
                           
                           Bonne chance dans votre conqu√™te !`);
                   }, 2000);
               }
           }
           
           // --- SYST√àME D'AIDE CONTEXTUELLE ---
           function showHelp(topic) {
               const helpTopics = {
                   buildings: 'Les b√¢timents sont la base de votre empire. Chaque type a des effets sp√©cifiques : production de ressources, d√©fense, recherche, etc.',
                   resources: 'G√©rez 7 types de ressources : Bois, Vin, Marbre, Cristal, Soufre, Or et Points de Recherche. Chacune a ses utilisations sp√©cifiques.',
                   research: 'La recherche d√©bloque de nouvelles technologies et am√©liorations. Construisez une Acad√©mie pour g√©n√©rer des points de recherche.',
                   military: 'Recrutez diff√©rents types d\'unit√©s pour d√©fendre votre empire et attaquer vos ennemis. Chaque unit√© a ses forces et faiblesses.',
                   world: 'Explorez le monde pour d√©couvrir de nouvelles √Æles, ressources et opportunit√©s de colonisation.'
               };
               
               showModal(`üí° Aide : ${topic}`, helpTopics[topic] || 'Sujet d\'aide non trouv√©.');
           }

           // --- INITIALISATION ---
           init();
           showTutorial();
       });
   </script>
</body>
</html>